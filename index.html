<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Zyumin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="java">
<meta property="og:type" content="website">
<meta property="og:title" content="Zyumin">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Zyumin">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zyumin">
  
    <link rel="alternate" href="/atom.xml" title="Zyumin" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Zyumin</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">保持自驱和热情</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Expert One-on-One-J2EE-Development-without-EJB" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/10/Expert One-on-One-J2EE-Development-without-EJB/" class="article-date">
  <time datetime="2019-03-10T11:45:57.000Z" itemprop="datePublished">2019-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/10/Expert One-on-One-J2EE-Development-without-EJB/">Expert One-on-One J2EE Development without EJB</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<pre><code>+ [Chapeter 1](#chapeter-1)
  - [EJB存在的问题](#ejb存在的问题)
  - [J2EE还剩下什么](#j2ee还剩下什么)
    * [J2EE 在易用性方面存在着严重的问题](#j2ee-在易用性方面存在着严重的问题)
    * [J2EE 项目具备架构重构能力的关键](#j2ee-项目具备架构重构能力的关键)
+ [Chapeter 5 EJB的5年间](#chapeter-5-ejb的5年间)
+ [Chapter 6 轻量级容器](#chapter-6-轻量级容器)
+ [Chapter 7 轻量级容器](#chapter-7-轻量级容器)
+ [Chapter8 基于AOP概念的声明性中间件](#chapter8-基于aop概念的声明性中间件)
+ [Chapter9 事务管理](#chapter9-事务管理)
    * [传统J2EE 事务管理](#传统j2ee-事务管理)
    * [J2EE容器作为事务协调器](#j2ee容器作为事务协调器)
    * [轻量级事务基础设施](#轻量级事务基础设施)
    * [Spring Framework的事务管理](#spring-framework的事务管理)
      + [事务声明](#事务声明)
      + [编程式事务处理](#编程式事务处理)
      + [声明式事务管理](#声明式事务管理)
    * [事务管理策略](#事务管理策略)
+ [Chapter10 持久化](#chapter10-持久化)
</code></pre><ul>
<li><a href="#">——————————————————</a><pre><code>* [依赖注入模式](#依赖注入模式)
* [是什么？](#是什么)
* [MVC](#mvc)
* [异常处理](#异常处理)
* [数据持久层](#数据持久层)
  + [事务管理](#事务管理)
  + [持久层封装](#持久层封装)
</code></pre></li>
</ul>
<!-- tocstop -->
<p>[TOC]</p>
<p>我想要获得什么。</p>
<p>​    架构师的思维，当一个框架不符合主流时候是怎么思考的，spring是为解决什么问题出现的？</p>
<p>大概是这样一种思维</p>
<p>​    不符合的原因  </p>
<p>​    指出我们正在需要的是什么。</p>
<p>​    替代方案</p>
<h3><span id="chapeter-1">Chapeter 1</span></h3><p>Why  without ？</p>
<h4><span id="ejb存在的问题">EJB存在的问题</span></h4><ul>
<li>EJB规范中的一些部分已经过时,J2SE1.3引入的动态代理(dynamicproxy)</li>
<li><p>EJB和RMI之间那种传统的紧密关系也开始显得有些不合时宜(local 和 remote 的调用？)这一方面是因为webservices 的迅速发展，另一方面是因为人们发现:很多时候 EJB 只需要本地接口</p>
</li>
<li><p>EJB 最善于实现业务对象分布的体系结构，然而这种体系结构究竟有多大程度的普遍性</p>
</li>
<li>SLSB （无状态session bean）和 MDB 使用较多，整个容器成本高昂</li>
<li>EJB的复杂性，EJB规范的复杂性 -&gt;开发效率</li>
<li>TDD流行 ，难以测试</li>
<li>对于 EJB 致力解决的中间件问题，面向方面的程序设计(Aspect Oriented Programming，AOP）</li>
</ul>
<p>EJB 试图解决太多的问题，其中很多问题本不应该由它来解决的。</p>
<h4><span id="j2ee还剩下什么">J2EE还剩下什么</span></h4><p>​    EJB只是J2EE的一种实现框架。因为这些库和框架不仅可以让我们摆脱使用 J2EE 服务的复杂度，而且也不会招致 EJB 所带来的复杂度。</p>
<p>​    J2EE 都是一个伟大的成功:</p>
<ul>
<li>它成功地在从前没有标准的地方建立了标准;</li>
<li>它大大提升了企业级软件的开放程度;</li>
<li>并且它得到了整个行业和开发者的广泛认可。</li>
</ul>
<h5><span id="j2ee-在易用性方面存在着严重的问题">J2EE 在易用性方面存在着严重的问题</span></h5><p><em>Core J2EE Patterns</em></p>
<p> 书中已经开始提倡使 用普通 Java 对象。</p>
<p>以规范为驱动的问题</p>
<p>有状态 session bean，状态的复制带来了很多微妙棘手的问题，所以大多数架构师总是尽量避免使用有状态 session bean。 </p>
<p>如果希望开发者遵循 J2EE 规范，那么 J2EE 规范首先必须是一个实用、易用的规范。</p>
<h5><span id="j2ee-项目具备架构重构能力的关键">J2EE 项目具备架构重构能力的关键</span></h5><p>​    简单、效率、面向对象（思想）、业务需求至上、可测试性</p>
<p> 􏰀 遵循良好的 OO 设计法则，并且始终针对接口编程、而非针对类编程。这是经典图书 </p>
<p>Design Patterns 教给我们的基本常识，可惜人们常常忽视了这一点。 </p>
<p>​    􏰀 将EJB之类的技术隐藏在普通Java对象背后。 </p>
<p>利用现有的框架提供这些基础设施服务</p>
<p>spring</p>
<p>​    基础框架的设计甚至早于<em>Expert One-on-One J2EE Design and Development</em>的写作，<br>它们来自我过去几个商业项目的经验。</p>
<h3><span id="chapeter-5-ejb的5年间">Chapeter 5 EJB的5年间</span></h3><p>不应该以规范先行  ，而应该开源引导</p>
<p>EJB出现的背景，制定标准 （好处是 强制接口实现分离 、容器的概念、管理对象，粗粒度）</p>
<p>rmi到Ws （SOAP 是基于 XML 的简易协议，可使应用程序在 HTTP 之上进行信息交换。使用描述语言WSDL）</p>
<p>需要EJB中的什么（从中获取价值，并用简单的方式实现）</p>
<p>​    声明式事务（编程式事务可以解决复杂的事务、 JTA webLogic）</p>
<p>​    远程调用（协议。JMS、 ws）</p>
<p>​    集群（web层、数据访问层、数据库。真正限制是在数据访问 吞吐、并置的应用更有效）</p>
<p>​    线程池（避免jvm垃圾回收、tomcat的线程池）和资源池</p>
<p>​    安全（web层、tomcat filter、springmvc filter）</p>
<p>​    管理业务对象（JNDI、重量级工厂 、ioc抄袭、spring提供基于配置 而不是代码、picoContainer、EJB提供了一个重量级工厂（实现、部署EJB、使用JNDI 应用代码）、消除了接口与实现之间的耦合。）</p>
<p>​    </p>
<p>总结</p>
<p>​    SLSB、 MDB      entity beans 性能、最好设计成哑数据（贫血模型） 不包含业务逻辑</p>
<p>不想要什么</p>
<p>​    容器的锁定</p>
<p>​        限制应用服务器的选择</p>
<p>​        只使用一小部分，却要接受其复杂性（不能按需引入）</p>
<p>​        业务对象会被EJB API浸入</p>
<p>​        不能在容器之外复用业务逻辑</p>
<p>​    丑陋的结构、泛滥的类</p>
<p>​        实现一个session bean ，至少需要三个Java源文件home接口 、组件接口 、bean实现类。通常还需要业务接口，来保持bean和组件的同步。</p>
<p>​    部署描述文件的地狱</p>
<p>​        描述文件冗长，依赖代码生成工具，不可手工维护</p>
<p>​    ==类加载器的地狱==</p>
<p>​        EJB容器与web容器使用的不是一个类加载器</p>
<p>​        EJB类加载器是WAR类加载器的父亲。 EJB类加载器不能看到WAR类加载器加载的类？</p>
<p>​    测试</p>
<p>​        依赖容器导致问题</p>
<p>简单的事情变困难</p>
<p>​    用EJB实现singleton</p>
<p>​    在EJB容器启动时做一些处理 （servelt listener 、web的listener 或者是bean的初始化后置操作等 、同时提供了依赖关系和顺序的支持）</p>
<p>​    在EJB之间以及EJB和EJB容器外的对象之间的共享配置</p>
<p>​    不能自由访问其他Java API  禁止访问一些Java API</p>
<p>EJB3.0（JSR 220 2003年6月）</p>
<p>​    主要动机是容易使用 降低EJB开发者使用时的复杂度，改良EJB的体系架构</p>
<p>​        使用源码级元数据 -&gt;废除部署描述文件。</p>
<p>​        提供一个简单、基于元数据标注的依赖注入机制。</p>
<p>​        采用新的持久化机制。Hibernate采用的持久化方式</p>
<p>​        </p>
<p>​    时间太长、不大可能引入AOP方案、还是依赖特定EJB容器。（从最近看webflux的做法，决定减少对servelt的依赖可以看出。不强依赖于Servelt，从而达到不依赖于特定服务器）        </p>
<p>​        </p>
<p>YAGNI     </p>
<h3><span id="chapter-6-轻量级容器">Chapter 6 轻量级容器</span></h3><p>容器需提供</p>
<p>​    生命周期，回调</p>
<p>​    查看服务 容器的核心是工厂</p>
<p>​    配置管理 统一方法来配置运行其中的对象</p>
<p>​    依赖管理</p>
<p>增值</p>
<p>​    企业级服务 ，事务管理或其他声明式服务</p>
<p>​    线程管理</p>
<p>​    对象池</p>
<p>​    集群服务</p>
<p>​    管理 jmx或暴露接口</p>
<p>​    远程服务 http 多协议</p>
<p>​        暴露</p>
<p>​        消费</p>
<p>​    可定制性和扩展性</p>
<p>EJB容器 管理的是粗粒度的组件（多个对象组合）</p>
<p>IOC</p>
<p>利用DI 消除lookup代码，让容器自动决定对象间的依赖关系</p>
<p>依赖查找 容器管理对象的生命周期，受管对象则负责查找自己的依赖关系 JNDI</p>
<p>依赖注入 让容器全权去负责依赖查询，受管对象暴露Java Bean 的setter 方法或带参数的构造。（或者通过元数据） </p>
<p>​    设值方法注入 建立在JavaBean规范之上</p>
<p>​    构造注入（picoContainer团队发明）</p>
<p>可以指定init 和 destroy 方法</p>
<p>注入异常检查</p>
<p>自动装配 通过类型</p>
<p>对于可移植性 </p>
<p>​    减少代码对容器的依赖</p>
<p>​    企业服务依赖容器，尽量以声明式而非编程式</p>
<p>代码风格</p>
<p> 针对接口</p>
<p>优先使用strategy设计模式</p>
<p>明确每个对象责任，不要大而全 （大一统，而是应该职责明确，抽成组件化）</p>
<p>能依靠容器解决的问题，就不要自己编写代码</p>
<p>为什么spring 能从轻量级框架中脱引而出，提供企业级服务的框架紧密合作，允许开发者通过编程方式或声明方式轻松地访问各种企业级服务。（粘合剂作用，例如整合ssh）</p>
<h3><span id="chapter-7-轻量级容器">Chapter 7 轻量级容器</span></h3><p>spring不重复造轮子 例如没有logger组件</p>
<p>工厂bean 主要在spring框架内部使用</p>
<p>​    例如 </p>
<p>​        JndiObjectFactoryBean</p>
<p>​        ProxyFactoryBean</p>
<p>​        TransactionProxyFactoryBean</p>
<p>​        RmiProxyFactoryBean</p>
<p>spring以统一的方式为多种j2ee服务提供了抽象，使得开发者灵活选择各种资源定位策略</p>
<p>最好不要依赖servlet环境，应该尽量使用spring的抽象，因为这样就不会依赖于任何环境</p>
<p>ApplicationContext</p>
<p>​    ApplicationEvent</p>
<p>​    MessageResource</p>
<p>​    ResourceLoader. use Resource</p>
<p>BeanFactoryAware</p>
<p>ApplicationContextAware</p>
<p>​     ResoureLoaderAware </p>
<p>BeanFactory的后处理</p>
<p>​    允许在底层bean工厂读取bean声明以后进行后处理，可以覆盖某个属性值，或是为某些属性提供占位值。</p>
<p>​    参考现成的实现</p>
<p>​        PropertyOverriderConfigurer</p>
<p>​        PropertyPlaceholderConfigurer</p>
<p>BeanPostProcessor</p>
<p>​        可以用于AOP代理</p>
<p>IoC容器强大在于：它几乎可以用于配置任何对象、框架和应用</p>
<h3><span id="chapter8-基于aop概念的声明性中间件">Chapter8 基于AOP概念的声明性中间件</span></h3><p>​    为何AOP对J2EE的未来至关重要</p>
<p>​    为何AOP是J2EE without EJB的关键</p>
<p>OOP 有些时候无法避免代码重复</p>
<p>概念</p>
<p>aspect  方面</p>
<p>adivce 增强，拦截器</p>
<p>Join point  连接点</p>
<p>Point cut 切入点</p>
<p>历史</p>
<p>​    一些OOP设计模式已经解决了AOP希望解决的部分问题</p>
<p>​    Decorator</p>
<p>​    Observer</p>
<p>​    Chain of Responsibility</p>
<p>使用OO设计模式，不可能做到既保持被增强方法的强类型性、又不必自己动手为每个方法编写转发代码</p>
<p>​    拦截器 如 servlet 、EJB 等 ，存在的问题是 它们将被拦截的代码与特点的API或上下文环境绑在一起，大多损失了强类型性。</p>
<p>AOP的实现策略</p>
<p>​    J2SE动态代理    </p>
<p>​         java1.3y引入动态代理，调用必要的拦截器链，最后一个拦截器借助反射调用目标对象</p>
<p>​        好处：标准的语言特征</p>
<p>​        局限：针对接口</p>
<p>​        实现：spring</p>
<p>​    动态字节码生成</p>
<p>​        CGLIB包，被应用在Hibernate 2.x版本中，并被证明是一种成熟的技术</p>
<p>​        存在的问题，通过继承来实现代理的，所以无法为final方法提供代理</p>
<p>​        实现：spring、Hibernate</p>
<p>​    Java代码生成 </p>
<p>​        OOP设计模式，EJB代码生成策略，预设的方式，由于动态代理和动态字节码生成技术的出现，这种做法逐渐退出</p>
<p>​    使用定制的类加载器</p>
<p>​        对某个类的所有实例进行增强</p>
<p>​        风险：偏离了Java标准</p>
<p>​        实现：JBoss4、AspectWerkz</p>
<p>​    语言扩展 </p>
<p>​        实现：AspectJ</p>
<p>springAOP的缺点</p>
<p>​    不支持字段拦截，但是封装性考虑是不应该</p>
<p>​    只有通过SpringIoc容器获取的对象才能进行增强，不能在类装载器层面进行增强</p>
<p>​    拦截器代码中没有强类型检查</p>
<p>AOP风险</p>
<p>​    拦截字段的风险 ，破坏封装性</p>
<p>​    太多的方面，维护</p>
<p>​    正交性，不依赖顺序，独立</p>
<p>​    测试 AOP提升可测试性，单元测试专注于业务逻辑</p>
<p>​    调试 </p>
<p>​    性能 粒度</p>
<p>​        如果你给细粒度的持久化对象加上AOP增强，在每次操作将会有数百个持久化对象被创建出来，那么才会有开销问题。</p>
<p>​    一次涉及反射的方法调用需要耗费的时间是毫秒级的 </p>
<p>​    一次数据库只读访问的时间开销通常是数十毫秒</p>
<p>​    通过浏览器访问web页面的网络延迟则是百毫秒级</p>
<p>AOP设计建议</p>
<p>​    渐进式、实用至上的方式来使用AOP</p>
<p>​    将AOP应用于业务对象，最有价值的用途就是在业务方法的粒度上提供通用的企业级服务</p>
<p>​    典型问题：</p>
<p>​        调用堆跟踪和性能监控</p>
<p>​        审计</p>
<p>​        消息通知（例如当特定的异常抛出时给管理员发送电子邮件）</p>
<p>​    不建议在非常细粒度的对象（例如持久化对象）进行增强</p>
<p>springAOP</p>
<p>​    一个可移植的服务层，类似于JTA、JDBC和别的底层API（将声明性服务从EJB容器中解耦出来，J2ee）</p>
<p>​    一种基于AOP的服务获取机制，基于Java</p>
<h3><span id="chapter9-事务管理">Chapter9  事务管理</span></h3><p>​    在一个 web层 、业务对象层 、数据访问层中，事务管理属于业务对象层，通过将数据库切换到手工提交事务的模式。</p>
<p>​    这种模式业务对象层和数据访问层都绑定到了特定的事务处理策略和数据访问策略。</p>
<p>​    分离这些关注点。</p>
<p>​        业务对象划分抽象事务，而无需关注事务涉及的数据库资源</p>
<p>​        数据访问对象获取数据库资源，无需关注数据库资源如何加入事务</p>
<h5><span id="传统j2ee-事务管理">传统J2EE 事务管理</span></h5><p>​    使用全局容器事务：事务由应用服务器来管理，登记所有参与事务的资源。一旦数据访问对象使用了涉及事务的资源，应用服务器容器将根据需要进行提交或回滚。</p>
<p>​    底层设施是由容器实现的JTA，全局事务管理使用CMT</p>
<h5><span id="j2ee容器作为事务协调器">J2EE容器作为事务协调器</span></h5><p>​    具备分布式事务的处理能力，应该完整支持遵循X/Open XA规范的两阶段提交协议（2-Phase-Commit）</p>
<p>​    第一阶段 事务协调器向所有相关资源发布 ‘准备’指令</p>
<p>​    第二阶段 等所有的资源准备好以后触发实际的提交动作</p>
<p>​    一、参与事务的资源必须被正确地配置好，例如JDBC，通过javax.sql.XADataSource接口实现类来建立JNDI DataSource</p>
<p>​    J2EE 1.3 引入参与事务的资源的统一模型 java连接器架构 （Java Connector Architecture）</p>
<p>​    二、使用特定的服务器特性来获取JTA内置的TransactionManage对象，TransactionManage对象允许数据访问框架注册到实物同步回调接口上</p>
<p>​    编程式事务管理（使用java代码）  通过JNDI,直接使用JTA UserTransaction （多个受控异常，没有共同父类，事务处理代码污染业务对象）</p>
<p>​    声明式事务管理（使用xml配置，注解的方式） 组件模型CMT ，建立在JTA基础设施之上的服务(只有EJB才能使用，解决了80%的问题，必须使用全局事务管理，EJB2.0才支持本地接口)</p>
<h5><span id="轻量级事务基础设施">轻量级事务基础设施</span></h5><p>​    提供的功能：</p>
<p>​    可编程的事务声明和一致的异常处理机制。错误是不可恢复的，所以应该采用非受控异常，并且所有的异常应该继承自一个公共的基础父类</p>
<p>​    在OPJO上面实现声明式事务，无需绑定重量级组件模型</p>
<p>​    可插入的事务策略，以及让资源能够自动加入事务的手段</p>
<p>​    为采用分布式容器事务而需要的JTA</p>
<p>​    独立的JDBC数据源</p>
<p>​    独立的JDO PersistenceManagerFactory</p>
<p>​    独立的Hibernate SessionFactory</p>
<p>不应该依赖J2EE容器提供的服务，例如JNDI数据源。</p>
<p>切换事务策略和资源定义应该是可配置的。</p>
<h5><span id="spring-framework的事务管理">Spring Framework的事务管理</span></h5><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g18zgtukb9j31kz0u0af4.jpg" alt="image-20190320090427683"></p>
<h6><span id="事务声明">事务声明</span></h6><p>事务的属性 TransactionDefinition</p>
<p>​    事务传播类型 required 、supports 、mandatory、  requires new 、not support、 never</p>
<p>​    隔离级别 default 、ru、 rc、 rr 、serializable</p>
<p>​    超时</p>
<p>​    只读</p>
<p>基础设施接口 PlatfromTransactionManager</p>
<p>​    抽象了实际的具体事务策略，针对一个给定的TransactionDefinition符合一个TransactionStatus对象，并且对这个状态对象触发提交或回滚操作。</p>
<p>TransactionStatus对象代表当前运行中的事务。</p>
<p>​    setRollbackOnly 不会抛出异常</p>
<blockquote>
<p>Invoking this method outside a Spring transactionally advised AOP invocation is a programming error and will result in a runtime exception.</p>
</blockquote>
<h6><span id="编程式事务处理">编程式事务处理</span></h6><p>直接使用 PlatfromTransactionManager</p>
<p>事务模板 TransactionTemplate</p>
<p>​    比直接使用JTA简单</p>
<h6><span id="声明式事务管理">声明式事务管理</span></h6><p>​    避免EJB带来的缺陷</p>
<p>通用的 Aop ProxyFactoryBean 和 TransactionInterceptor</p>
<p>​    由于TransactionInterceptor是通过ThreadLocal来存取事务状态对象的。</p>
<p>一站式 TransactionProxyFactoryBean</p>
<p>​    优点：</p>
<p>​    把关联的配置组织在一起</p>
<p>​    不需要了解整个拦截器链</p>
<p>​    代理接口通过目标类自动确定，并不需要显示的指定    </p>
<p>​    缺点：</p>
<p>​    丧失了更强的可配置能力</p>
<p>源代码级别的元数据（注解）</p>
<p>1.2开始支持，基于JDK5 </p>
<h5><span id="事务管理策略">事务管理策略</span></h5><p>​    DataSourceTransactionManager</p>
<p>​    JtaTransactionManager</p>
<p>​    JdoTransactionManager</p>
<p>​    HibernateTransactionManager</p>
<h3><span id="chapter10-持久化">Chapter10  持久化</span></h3><p>​    推荐Martin FOwler在 Patterns of Enterprise Application Architecture (POEAA) </p>
<hr>
<h1><span id="">——————————————————</span></h1><h5><span id="依赖注入模式">依赖注入模式</span></h5><p>Spring通过依赖注入模式，将依赖关系从编码中脱离出来，从而大大降低了组件之间的耦合，<br>实现了组件真正意义上的即插即用。这也是Spring最具价值的特性之一。</p>
<p>面向接口编程。</p>
<p>若没有spring 自己实现这些 ，往往这些系统开发中最常见的需求，会导致我们的代码迅速膨胀。</p>
<p>单例 </p>
<p>读配置</p>
<p>init </p>
<p>lazy loading</p>
<hr>
<h5><span id="是什么">是什么？</span></h5><p>Spring是笔者所见过的，最具实际意义的Java开发框架。</p>
<p>​    首先，Spring涵盖了应用系统开发所涉及的大多数技术范畴，包括MVC、ORM以及Remote<br>Interface等，这些技术往往贯穿了大多数应用系统的开发过程。Spring从开发者的角度对这些技术内<br>容进行了进一步的封装和抽象，使得应用开发更为简便。</p>
<p>​    其次，Spring并非一个强制性框架，它提供了很多独立的组件可供选择。</p>
<hr>
<h5><span id="mvc">MVC</span></h5><p>​    而对于 Spring 而言，首先，它提供了一个相当灵活和可扩展的 MVC 实现，与 WebWork2相比，它在依赖注入方面、AOP 等方面更加优秀，但在 MVC 框架与底层构架的分离上又与Webworks 存在着一定差距(Spring 的 MVC 与 Servlet API 相耦合，难于脱离 Servlet容器独立运行，在这点的扩展性上，比 Webwork2 稍逊一筹)。</p>
<p>​    所以现在才有去servlet化</p>
<h5><span id="异常处理">异常处理</span></h5><p>Web应用中对于异常的处理方式与其他形式的应用并没有太大的不同――通过try/catch 语句针对不同的异常进行相应处理。 </p>
<p>但是在具体实现中，由于异常层次、种类繁杂，我们往往很难在Servlet、JSP层妥善的处 理好所有异常情况，代码中大量的try/catch代码显得尤为凌乱。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们通常面对下面两个主要问题:</span><br></pre></td></tr></table></figure>
<ol>
<li>对异常实现集中式处理 </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">典型情况:对数据库异常记录错误日志。一般处理方法无外两种，一是在各处数据库 访问代码的异常处理中，加上日志记录语句。二是将在数据访问代码中将异常向上抛 出，并在上层结构中进行集中的日志记录处理。</span><br></pre></td></tr></table></figure>
<p>第一种处理方法失之繁琐、并且导致系统难以维护，假设后继需求为“对于数据库异 常，需记录日志，并发送通知消息告知系统管理员”。我们不得不对分散在系统中的各 处代码进行整改，工作量庞大。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第二种处理方法实现了统一的异常处理，但如果缺乏设计，往往使得上层异常处理过</span><br><span class="line">于复杂。</span><br></pre></td></tr></table></figure>
<p>这里，我们需要的是一个设计清晰、成熟可靠的集中式异常处理方案。 </p>
<p>2 对未捕获异常的处理<br>     对于Unchecked Exception而言，由于代码不强制捕获，往往被程序员所忽略，如果 运行期产生了Unchecked Exception，而代码中又没有进行相应的捕获和处理，则我 们可能不得不面对尴尬的500服务器内部错误提示页面。 这里，我们需要一个全面而有效的异常处理机制。 </p>
<p>同时，目前大多数服务器也都支持在Web.xml中通过</p>
<p><error-page>(Websphere/Weblogic)或者<error-code>(Tomcat)节点配置特定异常情<br>况的显示页面。</error-code></error-page></p>
<p>​    Spring MVC中提供了一个通用的异常处理机制，它提供了一个成熟的，简洁清晰的异常处<br>理方案。如果基于Spring MVC开发Web应用，那么利用这套现成的机制进行异常处理也更加自<br>然和有效。</p>
<hr>
<h5><span id="数据持久层">数据持久层</span></h5><h6><span id="事务管理">事务管理</span></h6><p>对于 J2EE 应用程序而言，事务的处理一般有两种模式: </p>
<ol>
<li>依赖特定事务资源的事务处理 这是应用开发中最常见的模式，即通过特定资源提供的事务机制进行事务管理。 如通过 JDBC、JTA 的 rollback、commit 方法;Hibernate Transaction 的 rollback、commit 方法等。这种方法大家已经相当熟悉。 （Spring 简化JDBC）</li>
<li>依赖容器的参数化事务管理 通过容器提供的集约式参数化事务机制，实现事务的外部管理，如 EJB 中的事 务管理模式。 （通过 Spring 实现基于容器的事务管理，Spring的事务管理是基于动态 AOP）</li>
</ol>
<p>与EJB事务管理的不同</p>
<ol>
<li>Spring 可以将任意 Java Class 纳入事务管理</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里的 UserDAO 只是我们编写的一个普通 Java Class，其中包含了一些 基本的数据应用逻辑。通过 Spring，我们即可简单的实现事务的可配置</span><br></pre></td></tr></table></figure>
<p>化。也就是说，我们可以随意为某个类的某个方法指定事务管理机制。 与之对比，如果使用 EJB 容器提供的事务管理功能，我们不得不按照 EJB 规范编将 UserDAO 进行改造，将其转换为一个标准的 EJB。 </p>
<ol start="2">
<li>Spring 事务管理并不依赖特定的事务资源。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EJB 容器必须依赖于 JTA 提供事务支持。而 Spring 的事务管理则支持 JDBC、JTA 等多种事务资源。这为我们提供了更多的选择，从而也使得 我们的系统部署更加灵活。</span><br></pre></td></tr></table></figure>
<h6><span id="持久层封装">持久层封装</span></h6><p>​    JDBCTemplate 模板应用的典范。特别是回调(CallBack)的使用，这带来了极强的灵活性和<br>扩展性。使得整个模板结构清晰高效</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/10/Expert One-on-One-J2EE-Development-without-EJB/" data-id="cjtjoe4ib000lv49ch623aprg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ejb/">ejb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/j2ee/">j2ee</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Expert-One-on-One-J2EE-Design-and-Development-总结" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/10/Expert-One-on-One-J2EE-Design-and-Development-总结/" class="article-date">
  <time datetime="2019-03-10T11:45:18.000Z" itemprop="datePublished">2019-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/10/Expert-One-on-One-J2EE-Design-and-Development-总结/">Expert One-on-One J2EE Design and Development</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#chapter-1">Chapter 1</a></li>
<li><a href="#chapter-2">Chapter 2</a></li>
<li><a href="#chapter3">Chapter3</a></li>
<li><a href="#chapter4-j2ee项目的实际技术与编程标准">Chapter4 J2EE项目的实际技术与编程标准</a></li>
<li><a href="#chapter-5-chapter-9">Chapter 5-Chapter 9</a><ul>
<li><a href="#chpter-6">Chpter 6</a></li>
<li><a href="#chapter-7">Chapter 7</a></li>
<li><a href="#chapter-8">Chapter 8</a></li>
<li><a href="#chapter-9-实际数据存取">Chapter 9 实际数据存取</a></li>
</ul>
</li>
<li><a href="#chapter-11">==Chapter 11==</a><ul>
<li><a href="#the-problem">The Problem</a></li>
<li><a href="#using-a-framework-to-configure-application-components">Using a Framework to Configure Application Components</a><ul>
<li><a href="#using-javabeans">Using JavaBeans</a></li>
<li><a href="#using-a-bean-factory">Using a “Bean Factory”</a></li>
<li><a href="#application-context-goals">Application Context Goals</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<p>Expert One-on-One J2EE Design and Development</p>
<p>##### </p>
<p>[TOC]</p>
<p>有点乱，待整理</p>
<p>重点章节。 4（Design and Standards）、9（data access）、11（Infrastructure）、12-13（web Tier）</p>
<p>4 Design Techniques and Coding<br>Standards for J2EE Projects</p>
<p>9 Practical Data Access</p>
<p>11 Infrastructure and Application Implementation </p>
<p>12 Web-Tier MVC Design</p>
<p>13 Views in the Web Tier</p>
<h3><span id="chapter-1">Chapter 1</span></h3><p>J2EE Architectures</p>
<p>Summary </p>
<ul>
<li><p>体系分层</p>
<p>  ​    EIS层 企业信息系统层 数据访问层？ dao层</p>
<p>  ​    中间层 业务对象 bizservice</p>
<p>  ​    用户接口层UI层 web层</p>
<p>  ​    web 层</p>
<p>  ​        模型 vo?  Model-&gt; json</p>
<p>  ​        视图  html   ui框架jsp 渲染引擎？-&gt;前端控制</p>
<p>  ​        控制器 不应该有业务逻辑  负责转发 struct—&gt;controller</p>
<p>  ​    控制流程是一种 command的设计模式</p>
</li>
</ul>
<pre><code>可移植性？

通过使用一个抽象层（Abstraction layer），可以利用松耦合把该应用的奇遇部分与必须用一种平台特有方式来实现的任何部分隔离开。



抽象层指一个其本身就独立于平台的接口。

​    spi的思想、 插拔式
</code></pre><h3><span id="chapter-2">Chapter 2</span></h3><p>选择一个应用服务器标准 </p>
<p>​    得到支持的规范</p>
<p>​    sun资源 CTS  ECPerf </p>
<p>​    成本</p>
<p>​    开发与部署</p>
<p>​        启动速度 部署速度 内存需求</p>
<p>​        额外步骤。编写部署描述符？</p>
<p>​        热部署的能力</p>
<p>​        服务器所提供的管理工具的完善度</p>
<p>​        SNMP（Simple Network Management Protocol）和JMX的管理标准集成度</p>
<p>​        运行时候错误报告的质量    </p>
<p>​    文档质量</p>
<p>​    可移植性的含义</p>
<p>​        应用在应用服务器之间的可以移植性</p>
<p>​        应用在服务器操作系统之间的可移植性</p>
<p>​        更改J2EE应用所依赖的重要资源的能力 数据库切换？</p>
<p>​    发布管理 指：保证一个应用发布从‘开发’ 、‘测试’到‘生产’到发展是可逆和可重复的</p>
<h3><span id="chapter3">Chapter3</span></h3><p>​    单元测试的重要性</p>
<h3><span id="chapter4-j2ee项目的实际技术与编程标准">Chapter4    J2EE项目的实际技术与编程标准</span></h3><p>​    J2EE应用的OO设计推荐标准</p>
<ul>
<li><p>利用接口来实现松耦合</p>
</li>
<li><p>首选对象合成而非具体继承性</p>
</li>
<li><p>Template Method设计模式  将特定步骤留给子类实现</p>
</li>
<li><p>Strategy  将特定步骤抽成一个接口。在具体继承性和接口委托之间进行折衷的例子</p>
</li>
<li><p>使用回调来实现可扩展 这是Strategy设计模式的一种特殊模式</p>
</li>
</ul>
<p>​            jdbcTemplate</p>
<p>​                query(String sql,RowCallBackHandler callbackHandler)</p>
<p>​                public interface RowCallBackHandler{<br>​                        void processRow(ResultSet rs) throws SQLException</p>
<p>​                }</p>
<ul>
<li>Observer设计模式。实现关系分离 </li>
</ul>
<p>​                例如处理登陆的对象为什么需要知道管理员的电子邮件地址、或者说如何发送邮件</p>
<p>​                核心职责被淹没在特性中</p>
<p>​                publisher-&gt;events-&gt;Observer</p>
<ul>
<li><p>考虑合并方法参数 Command</p>
</li>
<li><p>异常处理-已检查或未检查异常</p>
</li>
</ul>
<p>​            使用已检查异常会特有引起几个问题：</p>
<p>​                太多代码</p>
<p>​                难以读懂的代码</p>
<p>​                异常的无止休封装</p>
<p>​            一个异常相当于来自方法的一个可替代返回值的地方</p>
<p>​            已检查异常要比错误返回码好得多    </p>
<p>​            如果调用代码能够对该异常做些切合实际的事情可以使用，否则使用未检查异常RuntimeException，选择是否捕捉，依赖应用服务器容器来捕捉.（而不是jvm）    </p>
<p>​            对异常进行详细描写</p>
<ul>
<li><p>使用反射 Factory</p>
<p>  误解 </p>
<p>  ​        使用反射的代码是慢的 </p>
<p>  ​        过分复杂</p>
<p>  ​    如果使用得当，反射不会降低性能。正确使用反射实际哈桑应该改进代码可维护性。</p>
<p>  ​    反射的直接使用应该仅局限于基础结构类。</p>
</li>
<li><p>使用Java组件来实现灵活性</p>
</li>
<li><p>使用应用组册表来实现单例 Singleton Prototype Factory</p>
<p>  ​    支持接口</p>
<p>  ​    普通javabean</p>
<p>  ​    配置源上下文统一管理</p>
<p>  ​    为什么不适用jndi ? 复杂 单一</p>
</li>
</ul>
<p>编程规范</p>
<p>​    一个方法只应有一项明确的责任，而且所有操作都应该在同一个抽象级别上</p>
<p>​    避免代码重复</p>
<p>​    避免字面常量</p>
<p>​    可见度和作用范围尽可能小</p>
<p>​    内部类和接口 避免空间污染 </p>
<p>​    使用final关键字</p>
<p>​        开放式封闭原理：对扩展开放，对修改封闭。覆盖具体方法实际上是修改。</p>
<p>​        和抽象方法联合使用，保护超类的完整性。</p>
<p>​    使用界定符</p>
<p>实现一个框架</p>
<p>​    向现有框架学习</p>
<p>​    明确目标 、作用范围、 用最小复杂性来实现最大价值 </p>
<p>​        Pareto Principle（2/8原则） 某个特定功能很难实现，问问自己是不是必不可少的，能不能实现其价值的大部分</p>
<h3><span id="chapter-5-chapter-9">Chapter 5-Chapter 9</span></h3><h4><span id="chpter-6">Chpter 6</span></h4><p>高速缓存，减少没必要的调用和消耗</p>
<p>DATA ACCESS</p>
<p>DB mysql自身</p>
<p>DB组件 hibernate缓存</p>
<p>应用层</p>
<p>​    分布式缓存 redis  </p>
<p>​    单机jvm缓存 map  guava cache  </p>
<p>HTTP 304</p>
<h4><span id="chapter-7">Chapter 7</span></h4><p>RDBMS 与 ODBMS</p>
<p>范式化数据 消除数据冗余度</p>
<p>O/R 映射 尝试将Java对象的状态映射到RDMBMS上</p>
<p>用于OLTP，不适用于OLAP</p>
<h4><span id="chapter-8">Chapter 8</span></h4><p>​    关于Session Beans 和 Entity Beans的讨论</p>
<p>​    实体组件 分布式、共享的、事务性、持久性对象</p>
<p>​    Entity Bean 是一种糟糕的设计 ，不应该绑定在EJB容器上，应该交由专用的方案解决</p>
<p>​    无法继承，不具备java对象</p>
<h4><span id="chapter-9-实际数据存取">Chapter 9 实际数据存取</span></h4><p>JDBCTemplete</p>
<p>​    较高级的抽象 RDBMS建模为Java对象</p>
<h3><span id="chapter-11">==Chapter 11==</span></h3><h5><span id="the-problem">The Problem</span></h5><p>​    Without such infrastructure, configuration management is usually haphazard. J2EE applications often hold configuration in a variety of formats, such as properties files, XML documents (an increasingly popular choice), EJB JAR and WAR development descriptors, and database tables. </p>
<p>没有这样的基础设施，配置管理通常是随意的。 J2EE应用程序通常以各种格式进行配置，例如属性文件，XML文档（越来越流行的选择），EJB JAR和WAR开发描述符以及数据库表。</p>
<p>More seriously, application classes are bloated by configuration management code irrelevant to business responsibilities</p>
<p>应用程序类因与业务职责无关的配置管理代码而膨胀。</p>
<p>Equally harmfully, without a central infrastructure for configuration management, application code is to<br>likely to use variety to approaches to locating application objects. The Singleton design pattern is often<br>overused, resulting in problems we’ll discuss below. Alternatively, some application objects may be bound<br>to JNDI or attached to the global ServletContext (in web applications), both of which approaches<br>may complicate testing outside a JNDI server. Each application object is usually reconfigured<br>independently.</p>
<p>​    通过各种方式去获取配置。每个应用程序对象通常都是独立重新配置的。</p>
<h5><span id="using-a-framework-to-configure-application-components">Using a Framework to Configure Application Components</span></h5><p>外部化配置和OO设计</p>
<p>使用javaBean beanWapper</p>
<h6><span id="using-javabeans">Using JavaBeans</span></h6><p>​    If we make all application components JavaBeans, we maximize our ability to separate </p>
<p>configuration data from application code </p>
<p>​    However, manipulating beans is more complex, and requires the use of<br>reflection to instantiate objects and invoke methods by name. The core JavaBeans API does not provide<br>the ability to perform some useful operations on beans, such as</p>
<p>why ？</p>
<p>​    This provides the ability to manipulate beanseasily and adds the enhanced functionality described above, while respecting andavoiding duplicating the standard JavaBeans infrastructure.(andavoiding避免)</p>
<h6><span id="using-a-bean-factory">Using a “Bean Factory”</span></h6><p>why?</p>
<p>​    The com.interface21.beans.factory package defines a way of obtaining beans by<br>name from a central configuration repository using a “bean factory”. ==The goal of a bean==<br>==factory is to remove any need for individual Java objects to read configuration properties==<br>==or instantiate objects. Instead, configuration is read by a central component, the bean==<br>==factory, and the bean properties exposed by each application object are set to reflect==<br>configuration data.== The factory then makes available instances of beans, each with a<br>unique name. Sophisticated object graphs can be created within the bean factory, as<br>managed beans may reference other beans within the same factory.</p>
<p>对外暴露BeanWapper</p>
<h6><span id="application-context-goals">Application Context Goals</span></h6><p>​    Building on the bean factory, an application context provides a namespace for the JavaBeans that compose an application or subsystem, and the ability to share working objects at run time. The com.interface21.context.ApplicationContext interface extends the ListableBeanFact interface, adding the ability to: </p>
<p>o Publish events using the Observer design pattern. As we discussed in Chapter 4, the Observer design pattern provides the ability to decouple application components and achieve clean separation of concerns. </p>
<p>o Participate in a hierarchy of application contexts. Application contexts can have parent contexts, allowing developers to choose the amount of configuration shared between subsystems. </p>
<p>o Share working objects between application components at run time. </p>
<p>o Look up messages by string name, allowing support for internationalization. </p>
<p>o Facilitate testing. With an application context, as well as a bean factory, it’s often possible to provide a test implementation that enables application code to be tested outside an application server. </p>
<p>o Provide consistent configuration management in different types of applications. Application contexts behave the same way in different kinds of applications, such as Swing GUI applications or web applications, and inside and outside a J2EE application server. </p>
<p>web层 （不是本周重点）</p>
<p>性能框架测试（不是本周重点）</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/10/Expert-One-on-One-J2EE-Design-and-Development-总结/" data-id="cjtjoe4hl0000v49ctbhh7v8m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/j2ee/">j2ee</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spring-ioc" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/03/spring-ioc/" class="article-date">
  <time datetime="2019-03-03T06:51:56.000Z" itemprop="datePublished">2019-03-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/03/spring-ioc/">spring-ioc</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#ioc-containerioc-容器">IoC container(IoC 容器)</a><ul>
<li><a href="#问题">问题</a><ul>
<li><a href="#ioc">IOC</a><ul>
<li><a href="#从-依赖反转-到-依赖注入">从 ‘依赖反转’ 到 ‘依赖注入’</a></li>
<li><a href="#从-对象-对象-到-对象-ioc容器-对象">从 ‘对象-对象’ 到 ‘对象-IOC容器-对象’</a></li>
<li><a href="#对象的分类">对象的分类</a></li>
<li><a href="#与ejb的关系-对比">与EJB的关系、对比</a></li>
</ul>
</li>
<li><a href="#di">DI</a><ul>
<li><a href="#依赖查找dependency-lookup">依赖查找(Dependency Lookup)</a></li>
<li><a href="#依赖注入dependency-injection">依赖注入(Dependency Injection)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#模块">模块</a><ul>
<li><a href="#从beans说起">从Beans说起</a><ul>
<li><a href="#bean-的创建">Bean 的创建</a></li>
<li><a href="#bean-的定义">Bean 的定义</a></li>
<li><a href="#bean-的解析">Bean 的解析</a></li>
<li><a href="#spring-bean-封装机制">Spring Bean 封装机制</a><ul>
<li><a href="#beanwrapper">BeanWrapper</a></li>
</ul>
</li>
<li><a href="#bean-factory">Bean Factory</a></li>
</ul>
</li>
<li><a href="#容器context">容器Context</a><ul>
<li><a href="#core">Core</a></li>
<li><a href="#~~spel~~"><del>SpEL</del></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#规范">规范</a><ul>
<li><a href="#java-beans">Java Beans</a></li>
<li><a href="#dependency-injection-jsr-330httpswwwjcporgenjsrdetailid330">Dependency Injection (<a href="https://www.jcp.org/en/jsr/detail?id=330" target="_blank" rel="noopener">JSR 330</a>)</a></li>
<li><a href="#bean-validation-jsr-303httpsjcporgenjsrdetailid303">Bean Validation (<a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="noopener">JSR 303</a>)</a></li>
<li><a href="#common-annotations-jsr-250httpsjcporgenjsrdetailid250">Common Annotations (<a href="https://jcp.org/en/jsr/detail?id=250" target="_blank" rel="noopener">JSR 250</a>)</a></li>
</ul>
</li>
<li><a href="#api-doc">API-Doc</a><ul>
<li><a href="#beans">beans</a></li>
<li><a href="#context">context</a></li>
<li><a href="#core">core</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h2><span id="ioc-containerioc-容器">IoC container(IoC 容器)</span></h2><hr>
<p>[TOC]</p>
<h3><span id="问题">问题</span></h3><hr>
<p>​    思考如下问题</p>
<p>​    首先了解为啥需要这个模块？</p>
<p>​    它是啥，这个模块都有啥？</p>
<p>​    根据什么来的，实现了哪些规范？</p>
<h4><span id="ioc">IOC</span></h4><h5><span id="从-依赖反转-到-依赖注入">从 ‘依赖反转’ 到 ‘依赖注入’</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In early 2004, Martin Fowler asked the readers of his site: when talking about Inversion of Control: “the question is, what aspect of control are [they] inverting?”</span><br></pre></td></tr></table></figure>
<p>​    2004年，Martin Fowler 对依赖反转 提出了问题，并获得结论，依赖对象的获得被反转了，基于这个结论提出了个更好的名字，依赖注入。如果对象的引用或依赖关系的管理由具体对象来完成，会导致代码高度耦合和可测试性的降低。</p>
<h5><span id="从-对象-对象-到-对象-ioc容器-对象">从 ‘对象-对象’ 到 ‘对象-IOC容器-对象’</span></h5><p>​    依赖反转是一种设计模式，实现有很多种方式，ioc容器式实现这个模式的载体，管理对象，对象之间的关系</p>
<p>​    </p>
<h5><span id="对象的分类">对象的分类</span></h5><p>​    数据对象<br>​    数据处理对象 不常发生变化，是系统中基础的部分，不涉及数据和状态共享的问题，依赖关系比较稳定，单例</p>
<p>存在于应用系统，但是对象的管理交给了容器（平台）</p>
<h5><span id="与ejb的关系-对比">与EJB的关系、对比</span></h5><p>​    一方面，spring，ioc提供了一个基本的JavaBean容器，通过Ioc模式管理依赖关系，并通过依赖注入和AOP切面增强了<br>​    为JavaBean这样的POJO对象赋予事务管理、生命周期管理等基本功能；为防止注入异常，嗨提供特定依赖的检查。</p>
<p>​    EJB组件需要编写远程/本地接口、Home接口以及Bean的实现类，需要依赖EJB容器 JBOSS，查找其他EJB组件也需要通过诸如JNDI这样的方式，从而造成了对EJB容器和技术规范的依赖。</p>
<p>​    spring把EJB组件还原成了POJO对象或者JavaBean对象，降低了应用开发对传统J2EE技术规范的依赖。<br>但是因为封装、抽象的太好了，反而让J2EE的初学者忽略了相关规范</p>
<p>​    另一方面，通过可读的文本来完成配置，并且还能通过工具对这些配置信息进行可视化管理和浏览。并且如果耦合关系需要变动，并不需要重新修改和编译Java源代码，符合面向对象设计原则的开闭原则。如果结合OSGI还能提高应用的动态部署能力            </p>
<h4><span id="di">DI</span></h4><h5><span id="依赖查找dependency-lookup">依赖查找(Dependency Lookup)</span></h5><p>​    ID、别名、名称查找<br>​        BeanFactory#getBean(String) : Object </p>
<p>​    类型查找<br>​        BeanFactory#getBean(Class) : T </p>
<p>​    注解查找<br>​        ListableBeanFactory#getBeansWithAnnotation(Class) </p>
<p>​    FactoryBean 查找<br>​        FactoryBean#getObject() </p>
<p>​    ObjectFactory 查找<br>​              ObjectFactory#getObject()</p>
<h5><span id="依赖注入dependency-injection">依赖注入(Dependency Injection)</span></h5><p>​    方法<br>​        Spring @Autowired </p>
<p>​        Java @Resource </p>
<p>​        Java EE @Inject<br>​    注入方式  </p>
<p>​        接口、setter、构造器</p>
<p>spring官方更推荐使用构造器的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The Spring team generally advocates constructor injection, as it lets you implement application components as immutable objects and ensures that required dependencies are not null. Furthermore, constructor-injected components are always returned to the client (calling) code in a fully initialized state. As a side note, a large number of constructor arguments is a bad code smell, implying that the class likely has too many responsibilities and should be refactored to better address proper separation of concerns.</span><br></pre></td></tr></table></figure>
<p>在Ex中</p>
<p>Type2 构造子注入的优势: </p>
<ol>
<li><p>“在构造期即创建一个完整、合法的对象”，对于这条Java设计原则，Type2无疑是最好的 </p>
<p> 响应者。 </p>
</li>
<li><p>避免了繁琐的setter方法的编写，所有依赖关系均在构造函数中设定，依赖关系集中呈现， </p>
<p> 更加易读。 </p>
</li>
<li><p>由于没有setter方法，依赖关系在构造时由容器一次性设定，因此组件在被创建之后即处于 </p>
<p> 相对“不变”的稳定状态，无需担心上层代码在调用过程中执行setter方法对组件依赖关系 </p>
<p> 产生破坏，特别是对于Singleton模式的组件而言，这可能对整个系统产生重大的影响。 </p>
</li>
<li><p>同样，由于关联关系仅在构造函数中表达，只有组件创建者需要关心组件内部的依赖关系。 </p>
<p> 对调用者而言，组件中的依赖关系处于黑盒之中。对上层屏蔽不必要的信息，也为系统的 </p>
<p> 层次清晰性提供了保证。 </p>
</li>
<li><p>通过构造子注入，意味着我们可以在构造函数中决定依赖关系的注入顺序，对于一个大量 </p>
<p> 依赖外部服务的组件而言，依赖关系的获得顺序可能非常重要，比如某个依赖关系注入的 先决条件是组件的DataSource及相关资源已经被设定。 </p>
</li>
</ol>
<p>Type3 设值注入的优势 </p>
<ol>
<li><p>对于习惯了传统JavaBean开发的程序员而言，通过setter方法设定依赖关系显得更加直 </p>
<p> 观，更加自然。 </p>
</li>
<li><p>如果依赖关系(或继承关系)较为复杂，那么Type2模式的构造函数也会相当庞大(我们需 </p>
<p> 要在构造函数中设定所有依赖关系)，此时Type3模式往往更为简洁。 </p>
</li>
<li><p>对于某些第三方类库而言，可能要求我们的组件必须提供一个默认的构造函数(如Struts </p>
<p> 中的Action)，此时Type2类型的依赖注入机制就体现出其局限性，难以完成我们期望的功能。</p>
</li>
</ol>
<h3><span id="模块">模块</span></h3><hr>
<p>​    官方网站提过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">At the heart are the modules of the core container, including a configuration model and a dependency injection mechanism.</span><br></pre></td></tr></table></figure>
<p>​    从之前的module图可以知道有如下四部分。</p>
<p>​    </p>
<h4><span id="从beans说起">从Beans说起</span></h4><p>​    Spring 就是面向 Bean 的编程（BOP,Bean Oriented Programming），Bean 在 Spring 中作用就像 Object 对 OOP 的意义一样，没有对象的概念就像没有面向对象编程，Spring 中没有 Bean 也就没有 Spring 存在的意义</p>
<p>​    这个包下的所有类主要解决了三件事：Bean 的定义、Bean 的创建以及对 Bean 的解析</p>
<h5><span id="bean-的创建">Bean 的创建</span></h5><p>​    Spring Bean 的创建时典型的工厂模式，它的顶级接口是 <code>BeanFactory</code></p>
<p>​    <code>BeanFactory</code> 有三个子类：</p>
<p>​        <code>ListableBeanFactory</code> 接口 ：表示这些 Bean 是可列表的</p>
<p>​        <code>HierarchicalBeanFactory</code>  ：表示的这些 Bean 是有继承关系的，有父bean</p>
<p>​        <code>AutowireCapableBeanFactory</code> ：接口定义 Bean 的自动装配规则</p>
<p>​    上述的接口共同定义了 Bean 的集合、Bean 之间的关系、以及 Bean 行为，它们的默认实现类是 <code>DefaultListableBeanFactory</code></p>
<p>​    todo ==DefaultListableBeanFactory的子类分析==</p>
<h5><span id="bean-的定义">Bean 的定义</span></h5><p>​    Bean 的定义主要有 BeanDefinition 描述，主要来自两方面</p>
<p>​        XML定义，</p>
<p>​        注解扫描 @Service @Entity @Bean @Configuration</p>
<h5><span id="bean-的解析">Bean 的解析</span></h5><p>​    把xml解析成Resource类            </p>
<h5><span id="spring-bean-封装机制">Spring Bean 封装机制</span></h5><p>​    Spring 从核心而言，是一个 DI 容器，其设计哲学是提供一种无侵入式的高扩展性框架。即无需代码中涉及 Spring 专有类（指Bean），即可将其纳入 Spring 容器进行管理。 </p>
<p>​    作为对比，EJB 则是一种高度侵入性的框架规范，它制定了众多的接口和编码规范，要求实现者必须 遵从。侵入性的后果就是，一旦系统基于侵入性框架设计开发，那么之后任何脱离这个框架的企图都将付 出极大的代价。 </p>
<p>​    Spring 大量引入了 Java 的 Reflection 机制，通过动态 调用的方式避免硬编码方式的约束，并在此基础上建立了其核心组件 BeanFactory，以此作为其依赖注入 机制的实现基础。 </p>
<p>org.springframework.beans 包中包括了这些核心组件的实现类，核心中的核心为 BeanWrapper<br>和 BeanFactory 类。</p>
<h6><span id="beanwrapper">BeanWrapper</span></h6><p>​    这个BeanWrapper的功能很简单，提供一个设置JavaBean属性的通用方法， 动态设置一个对象属性</p>
<h5><span id="bean-factory">Bean Factory</span></h5><p>​    负责创建并维护Bean实例。 </p>
<p>Bean Factory负责根据配置文件创建Bean实例，可以配置的项目有:</p>
<ol>
<li>Bean属性值及依赖关系(对其他Bean的引用)  property</li>
<li>Bean创建模式(是否Singleton模式，即是否只针对指定类维持全局唯一的实例)  singleton</li>
<li>Bean初始化和销毁方法  init-method  destroy-method</li>
<li>Bean的依赖关系。 depends-on（通过depends-on指定其依赖关系可保证在此Bean加载之前，首先对depends-on所指定的资源进行加载）</li>
</ol>
<p>​    </p>
<h4><span id="容器context">容器Context</span></h4><p>​    BeanFactory提供了针对Java Bean的管理功能，而ApplicationContext提供了一个更为框架化的 实现(从上面的示例中可以看出，BeanFactory的使用方式更加类似一个API，而非Framework style)。 </p>
<p>​    ApplicationContext覆盖了BeanFactory的所有功能，并提供了更多的特性。此外， ApplicationContext为与现有应用框架相整合，提供了更为开放式的实现(如对于Web应用，我们可以在 web.xml中对ApplicationContext进行配置)。 </p>
<p>​    ApplicationContext 是 Context 的顶级父类，他除了能标识一个应用环境的基本信息外，他还继承了五个接口，这五个接口主要是扩展了 Context 的功能。下面是 Context 的类结构图</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1g0prh3oklzj31tk0qq781.jpg" alt="image-20190303180157960"></p>
<p>相对BeanFactory而言，ApplicationContext提供了以下扩展功能: </p>
<ol>
<li>国际化支持 我们可以在Beans.xml文件中，对程序中的语言信息(如提示信息)进行定义，将程序中的提示 信息抽取到配置文件中加以定义，为我们进行应用的各语言版本转换提供了极大的灵活性。 </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">（native2ascii messages_zh_CN.properties msg.txt）</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>资源访问 支持对文件和URL的访问。 </li>
<li>事件传播 事件传播特性为系统中状态改变时的检测提供了良好支持。 </li>
<li>多实例加载 可以在同一个应用中加载多个Context实例。 </li>
</ol>
<h5><span id="core">Core</span></h5><p>​    其实 Core 就是发现、建立和维护每个 Bean 之间的关系所需要的一些列的工具，从这个角度看来，Core 这个组件叫 Util 更能让你理解。</p>
<p>下图是 Resource 相关的类结构图：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1g0prtjnknbj31wk0rkgp4.jpg" alt="image-20190303181354519"></p>
<p>​    从上图可以看出 Resource 接口封装了各种可能的资源类型，也就是对使用者来说屏蔽了文件类型的不同。</p>
<p>​    对资源的提供者来说，如何把资源包装起来交给其他人用这也是一个问题，我们看到 Resource 接口继承了 InputStreamSource 接口，这个接口中有个 getInputStream 方法，返回的是 InputStream 类。这样所有的资源都被可以通过 InputStream 这个类来获取，所以也屏蔽了资源的提供者。</p>
<p>​    另外还有一个问题就是加载资源的问题，也就是资源的加载者要统一，从上图中可以看出这个任务是由 ResourceLoader 接口完成，他屏蔽了所有的资源加载者的差异，只需要实现这个接口就可以加载所有的资源，他的默认实现是 DefaultResourceLoader。</p>
<h5><span id="spel"><del>SpEL</del></span></h5><p><strong>如何创建 BeanFactory 工厂</strong></p>
<p><strong>如何创建 Bean 实例并构建 Bean 的关系网</strong></p>
<h3><span id="规范">规范</span></h3><hr>
<p>实现了哪些规范？</p>
<h4><span id="java-beans">Java Beans</span></h4><p>​            内省</p>
<p>​            基础核心特性:反射(Reflection) </p>
<p>​            附加特性:引用(Reference)<br>​                Reference<br>​                                SoftReference<br>​                                WeakReference<br>​                                PhantomReference<br>​                                FinalReference<br>​                       BeanInfo<br>​                               BeanDescriptor<br>​                      PropertyDescriptor<br>​                            事件: PropertyChangeEvent<br>​                                java.util.EventObject </p>
<p>​                            监听器: PropertyChangeListener<br>​                                             java.util.EventListener<br>​                              MethodDescriptor</p>
<h4><span id="dependency-injection-jsr-330">Dependency Injection ()</span></h4><h4><span id="bean-validation-jsr-303">Bean Validation ()</span></h4><h4><span id="common-annotations-jsr-250">Common Annotations ()</span></h4><h3><span id="api-doc">API-Doc</span></h3><hr>
<p><a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/javadoc-api/" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/5.1.5.RELEASE/javadoc-api/</a></p>
<h4><span id="beans">beans</span></h4><p>Package org.springframework.beans Description</p>
<p>This package contains interfaces and classes for manipulating Java beans. It is used by most other Spring packages.</p>
<p>A BeanWrapper object may be used to set and get bean properties, singly or in bulk.</p>
<p>The classes in this package are discussed in Chapter 11 of <a href="https://www.amazon.com/exec/obidos/tg/detail/-/0764543857/" target="_blank" rel="noopener">Expert One-On-One J2EE Design and Development</a> by Rod Johnson (Wrox, 2002).</p>
<h4><span id="context">context</span></h4><p>Package org.springframework.context Description</p>
<p>This package builds on the beans package to add support for message sources and for the Observer design pattern, and the ability for application objects to obtain resources using a consistent API.</p>
<p>There is no necessity for Spring applications to depend on ApplicationContext or even BeanFactory functionality explicitly. One of the strengths of the Spring architecture is that application objects can often be configured without any dependency on Spring-specific APIs.</p>
<h4><span id="core">core</span></h4><p>Package org.springframework.core Description</p>
<p>Provides basic classes for exception handling and version detection, and other core helpers that are not specific to any part of the framework.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/03/spring-ioc/" data-id="cjtjoe4hv0004v49c5cg4g0ju" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ioc/">ioc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spring" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/02/spring/" class="article-date">
  <time datetime="2019-03-02T04:29:06.000Z" itemprop="datePublished">2019-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/02/spring/">spring</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#spring">Spring</a><ul>
<li><a href="#spring-发展史">Spring 发展史</a><ul>
<li><a href="#由来">由来</a><ul>
<li><a href="#开端-j2ee">开端 J2EE</a></li>
<li><a href="#繁琐的ejb-inversion-of-control-dependency-injection">繁琐的EJB ：Inversion of Control / Dependency Injection</a></li>
<li><a href="#annotation">Annotation</a></li>
<li><a href="#微服务的崛起">微服务的崛起</a></li>
<li><a href="#反应式编程">反应式编程</a></li>
</ul>
</li>
<li><a href="#版本特征">版本特征</a></li>
</ul>
</li>
<li><a href="#javabeans的发展史">JavaBeans的发展史</a><ul>
<li><a href="#客户端">客户端</a></li>
<li><a href="#model">Model</a></li>
<li><a href="#enterprise-java-bean">Enterprise Java bean</a><ul>
<li><a href="#j2ee">J2EE</a></li>
<li><a href="#j2ee-粘合剂ejb">J2EE 粘合剂：EJB</a></li>
</ul>
</li>
<li><a href="#pojo">POJO</a></li>
</ul>
</li>
<li><a href="#spring-framework-module">Spring Framework Module</a></li>
<li><a href="#spring理念">spring理念</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<p>[TOC]</p>
<h2><span id="spring">Spring</span></h2><p>​    <a href="https://en.wikipedia.org/wiki/Spring_Framework" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Spring_Framework</a></p>
<p>​    <a href="https://docs.spring.io/spring/docs/" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/</a></p>
<h3><span id="spring-发展史">Spring 发展史</span></h3><hr>
<h4><span id="由来">由来</span></h4><h5><span id="开端-j2ee">开端 J2EE</span></h5><p>​    解决了什么问题？为什么需要？</p>
<p>​        applications are often slow, unduly complex, and take too long to develop.Rod Johnson believes that the problem lies not in J2EE itself, but in that it is often used badly</p>
<p>​    Rod Johnson 2002-10 写了 Expert One-on-One J2EE Design and Development </p>
<p>​    在这 本书中 讲解了何时使用EJB（需要分布式事务和消息的时候使用） 以及J2EE走向何方，写了interface21包 来简化J2EE的开发，提出了using a Framework to Configure Application Components ，其中提及 使用 javaBeans、 BeanFactory、applictionContext (简化、参考ejb)来简化J2EE开发， 以及如何简化EJB的使用 ，通过抽象EJB的 Bean，将使用EJB的代码与依赖JNDI和EJB API的代码分离。</p>
<p>​      同年， 开源了interface21， 并改名为 spring</p>
<p>​    2003 年6月  发布 spring0.9</p>
<p>​    2004-3 发布 spring 1.0 XML Bean Definitions</p>
<p>​               Spring MVC</p>
<p>​               spring 1.2    支持注解，要求jdk1.5</p>
<p>​                粘合剂     把Struts,Hibernate等黏合到一起，史称SSH。 </p>
<h5><span id="繁琐的ejb-inversion-of-control-dependency-injection">繁琐的EJB ：Inversion of Control / Dependency Injection</span></h5><p>​    解决了什么问题？为什么需要？</p>
<p>​        In early 2004, Martin Fowler asked the readers of his site: when talking about Inversion of Control: “the question is, what aspect of control are [they] inverting?”</p>
<p>​        我们曾经在无数的书籍和文章中看到，EJB是J2EE的核心技术之一，EJB太繁琐，约束太多，依赖EJB容器，轻量级j2ee</p>
<p>​    Rod Johnson等写了</p>
<p>​    2004-6  J2EE Development without EJB（讨论了我们真正需要EJB的什么，如何同样实现这些功能）</p>
<p>​    2005-7  Professional Java Development with the Spring Framework</p>
<p>​    </p>
<h5><span id="annotation">Annotation</span></h5><p>​    解决了什么问题？为什么需要？</p>
<p>​        基于注解的依赖注入和组件扫描 @Autowise @Configurable</p>
<p>​    2006年发布Spring 2.0 </p>
<p>​        Ruby on Rails的框架突然崛起，约定重于配置，Don’t repeat yourself的思想随着RoR深入人心。</p>
<p>​    2007年发布Spring 2.5 。</p>
<p>​    2009年Spring 3.0 RESTful的支持</p>
<p>​    </p>
<h5><span id="微服务的崛起">微服务的崛起</span></h5><p>​    解决了什么问题？为什么需要？</p>
<p>​        xml配置繁琐，自动装配springboot， 微服务等兴起 </p>
<p>​    2013年12月 Spring4.0 支持jdk8</p>
<p>​    2014  Spring Boot 约定大于配置</p>
<p>​    2015 Spring Cloud</p>
<h5><span id="反应式编程">反应式编程</span></h5><p>​    解决了什么问题？为什么需要？</p>
<p>​        高并发，IO密集型应用，同步阻塞的模型，受连接池等约束，反应式编程 reactive stream</p>
<p>​    2017年9月     Spring 5.0  WebFlux</p>
<h4><span id="版本特征">版本特征</span></h4><table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.9</td>
<td>2002</td>
<td></td>
</tr>
<tr>
<td>1.0</td>
<td>2003</td>
<td></td>
</tr>
<tr>
<td>2.0</td>
<td>2006</td>
<td></td>
</tr>
<tr>
<td>3.0</td>
<td>2009</td>
<td></td>
</tr>
<tr>
<td>4.0</td>
<td>2013</td>
<td></td>
</tr>
<tr>
<td>5.0</td>
<td>2017</td>
</tr>
</tbody>
</table>
<p>​    The first version was written by <a href="https://en.wikipedia.org/wiki/Rod_Johnson_(programmer" target="_blank" rel="noopener">Rod Johnson</a>), who released the framework with the publication of his book <em>Expert One-on-One J2EE Design and Development</em> in October 2002. The framework was first released under the <a href="https://en.wikipedia.org/wiki/Apache_License" target="_blank" rel="noopener">Apache 2.0 license</a> in June 2003. The first milestone release, 1.0, was released in March 2004 with further milestone releases in September 2004 and March 2005. The Spring 1.2.6 framework won a <a href="https://en.wikipedia.org/wiki/Jolt_Awards" target="_blank" rel="noopener">Jolt productivity award</a> and a <a href="https://en.wikipedia.org/w/index.php?title=JAX_Innovation_Award&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">JAX (Java API for XML) Innovation Award</a> in 2006.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-2" target="_blank" rel="noopener">[2]</a><a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-3" target="_blank" rel="noopener">[3]</a> Spring 2.0 was released in October 2006, Spring 2.5 in November 2007, Spring 3.0 in December 2009, Spring 3.1 in December 2011, and Spring 3.2.5 in November 2013.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-4" target="_blank" rel="noopener">[4]</a> Spring Framework 4.0 was released in December 2013.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-5" target="_blank" rel="noopener">[5]</a> Notable improvements in Spring 4.0 included support for Java SE (Standard Edition) 8, <a href="https://en.wikipedia.org/wiki/Groovy_(programming_language" target="_blank" rel="noopener">Groovy</a>) 2, some aspects of Java EE 7, and <a href="https://en.wikipedia.org/wiki/WebSocket" target="_blank" rel="noopener">WebSocket</a>.</p>
<p>​    Spring Framework 4.2.0 was released on 31 July 2015 and was immediately upgraded to version 4.2.1, which was released on 01 Sept 2015.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-6" target="_blank" rel="noopener">[6]</a> It is <em>“compatible with Java 6, 7 and 8, with a focus on core refinements and modern web capabilities”</em>.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-7" target="_blank" rel="noopener">[7]</a></p>
<p>Spring Framework 4.3 has been released on 10 June 2016 and will be supported until 2020.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-8" target="_blank" rel="noopener">[8]</a> It <em>“will be the final generation within the general Spring 4 system requirements (Java 6+, Servlet 2.5+), […]”</em>.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-9" target="_blank" rel="noopener">[9]</a></p>
<p>Spring 5 is announced to be built upon <a href="https://en.wikipedia.org/wiki/Reactive_Streams" target="_blank" rel="noopener">Reactive Streams</a> compatible Reactor Core.<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-10" target="_blank" rel="noopener">[10]</a></p>
<hr>
<h3><span id="javabeans的发展史">JavaBeans的发展史</span></h3><hr>
<h4><span id="客户端">客户端</span></h4><p>​    一开始的目标是客户端</p>
<p>javaBeans</p>
<p>《javaBeans规范》</p>
<ol>
<li>这个类需要是public 的， 然后需要有个无参数的构造函数</li>
<li>这个类的属性应该是private 的， 通过setXXX()和getXXX()来访问</li>
<li>这个类需要能支持“事件”， 例如addXXXXListener(XXXEvent e),  事件可以是Click事件，Keyboard事件等等， 当然咱们也支持自定义的事件。 </li>
<li>我们得提供一个所谓的自省/反射机制， 这样能在运行时查看java bean 的各种信息“</li>
<li>这个类应该是可以序列化的， 即可以把bean的状态保存的硬盘上， 以便以后来恢复。 </li>
</ol>
<h4><span id="model">Model</span></h4><p>​    Model-View-Controller  -》struct -〉spring</p>
<h4><span id="enterprise-java-bean">Enterprise Java bean</span></h4><h5><span id="j2ee">J2EE</span></h5><p>​    1998年发表 JDK1.2 并分为标准版(Standard Edition，<a href="https://baike.baidu.com/item/J2SE" target="_blank" rel="noopener">J2SE</a>), 企业版(Enterprise Edition，J2EE)，微型版(MicroEdition，<a href="https://baike.baidu.com/item/J2ME" target="_blank" rel="noopener">J2ME</a>)。J2EE便由此诞生。</p>
<p>​    四层模型</p>
<p>​        客户层组件 ：运行在客户端机器上的客户层组件</p>
<p>​        session bean</p>
<p>​        web层组件 ：运行在J2EE<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">服务器</a>上,java Servlet和JavaServer Pages(JSP）是web层组件</p>
<p>​        entity Bean</p>
<p>​        业务层组件:  运行在J2EE服务器上,Enterprise JavaBeans(EJB）是业务层组件.</p>
<p>​        message-driven beans.</p>
<p>​        信息系统层 : EIS服务器上的<a href="https://baike.baidu.com/item/%E4%BC%81%E4%B8%9A%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">企业信息系统</a>（Enterprise information system）层软件</p>
<p>​                </p>
<h5><span id="j2ee-粘合剂ejb">J2EE 粘合剂：EJB</span></h5><p>​    EJB(Enterprise JavaBean) 是J2EE的一种规范。设计目标与核心应用是部署分布式应用程序。</p>
<p>​    EJB 1.0 (1998-03-24)</p>
<p>​    EJB 2.0, final release (2001-08-22)</p>
<p>​    EJB 3.0, final release (2006-05-11)</p>
<p>​        JDBC</p>
<p>​        JNDI</p>
<p>​        RMI</p>
<p>​        JMS</p>
<p>​        JTA</p>
<p>​        Java mail</p>
<p>​        部署、集群</p>
<h4><span id="pojo">POJO</span></h4><p>​    EJB容器：Enterprise java bean 容器。更具有行业领域特色。他提供给运行在其中的组件EJB各种管理功能</p>
<p>​    -》JavaBean容器</p>
<p>​    轻量级javaBeans 没有规范</p>
<p>​    spring</p>
<hr>
<p>### </p>
<h3><span id="spring-framework-module">Spring Framework Module</span></h3><p>Show a picture (从spring 4.3.x中扒的，因为spring5的找不到这个module图了)</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1g0pnp0m1luj313l0u0ju7.jpg" alt="image-20190303154934664"></p>
<p>The Spring Framework includes several modules that provide a range of services:</p>
<ul>
<li>Spring Core Container: this is the base module of Spring and provides spring containers (BeanFactory and ApplicationContext).<a href="https://en.wikipedia.org/wiki/Spring_Framework#cite_note-11" target="_blank" rel="noopener">[11]</a></li>
<li><a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="noopener">Aspect-oriented programming</a>: enables implementing <a href="https://en.wikipedia.org/wiki/Cross-cutting_concern" target="_blank" rel="noopener">cross-cutting concerns</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/Authentication" target="_blank" rel="noopener">Authentication</a> and <a href="https://en.wikipedia.org/wiki/Authorization" target="_blank" rel="noopener">authorization</a>: configurable security processes that support a range of standards, protocols, tools and practices via the <a href="https://en.wikipedia.org/wiki/Spring_Security" target="_blank" rel="noopener">Spring Security</a> sub-project (formerly Acegi Security System for Spring).</li>
<li><a href="https://en.wikipedia.org/wiki/Convention_over_configuration" target="_blank" rel="noopener">Convention over configuration</a>: a rapid application development solution for Spring-based enterprise applications is offered in the <a href="https://en.wikipedia.org/wiki/Spring_Roo" target="_blank" rel="noopener">Spring Roo</a> module</li>
<li><a href="https://en.wikipedia.org/wiki/Data_access" target="_blank" rel="noopener">Data access</a>: working with <a href="https://en.wikipedia.org/wiki/RDBMS" target="_blank" rel="noopener">relational database management systems</a> on the Java platform using <a href="https://en.wikipedia.org/wiki/Java_Database_Connectivity" target="_blank" rel="noopener">Java Database Connectivity</a> (JDBC) and <a href="https://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank" rel="noopener">object-relational mapping</a> tools and with <a href="https://en.wikipedia.org/wiki/NoSQL" target="_blank" rel="noopener">NoSQL</a> databases</li>
<li><a href="https://en.wikipedia.org/wiki/Inversion_of_control" target="_blank" rel="noopener">Inversion of control</a> container: configuration of application components and lifecycle management of Java objects, done mainly via <a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">dependency injection</a></li>
<li>Messaging: configurative registration of message listener objects for transparent message-consumption from <a href="https://en.wikipedia.org/wiki/Message_queue" target="_blank" rel="noopener">message queues</a> via <a href="https://en.wikipedia.org/wiki/Java_Message_Service" target="_blank" rel="noopener">Java Message Service</a> (JMS), improvement of message sending over standard JMS APIs</li>
<li><a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank" rel="noopener">Model–view–controller</a>: an <a href="https://en.wikipedia.org/wiki/HTTP" target="_blank" rel="noopener">HTTP</a>- and <a href="https://en.wikipedia.org/wiki/Java_Servlet_API" target="_blank" rel="noopener">servlet</a>-based framework providing hooks for extension and customization for web applications and <a href="https://en.wikipedia.org/wiki/REST" target="_blank" rel="noopener">RESTful</a> (representational state transfer) Web services.</li>
<li>Remote access framework: configurative <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noopener">remote procedure call</a> (RPC)-style <a href="https://en.wikipedia.org/wiki/Marshalling_(computer_science" target="_blank" rel="noopener">marshalling</a>) of Java objects over networks supporting <a href="https://en.wikipedia.org/wiki/Java_remote_method_invocation" target="_blank" rel="noopener">Java remote method invocation</a> (RMI), <a href="https://en.wikipedia.org/wiki/CORBA" target="_blank" rel="noopener">CORBA</a> (Common Object Request Broker Architecture) and <a href="https://en.wikipedia.org/wiki/HTTP" target="_blank" rel="noopener">HTTP</a>-based protocols including <a href="https://en.wikipedia.org/wiki/Web_services" target="_blank" rel="noopener">Web services</a> (<a href="https://en.wikipedia.org/wiki/SOAP_(protocol" target="_blank" rel="noopener">SOAP (Simple Object Access Protocol)</a>))</li>
<li><a href="https://en.wikipedia.org/wiki/Transaction_processing" target="_blank" rel="noopener">Transaction management</a>: unifies several transaction management APIs and coordinates transactions for Java objects</li>
<li>Remote management: configurative exposure and management of Java objects for local or remote configuration via <a href="https://en.wikipedia.org/wiki/Java_Management_Extensions" target="_blank" rel="noopener">Java Management Extensions</a> (JMX)</li>
<li><a href="https://en.wikipedia.org/wiki/Software_testing" target="_blank" rel="noopener">Testing</a>: support classes for writing unit tests and integration tests</li>
</ul>
<h3><span id="spring理念">spring理念</span></h3><hr>
<p>核心IOC和AOP</p>
<p>​    javaEE的服务都被抽象到Ioc容器中，并通过AOP进行有效封装，因为依赖注入到特性，这些复杂的依赖关系的管理被反转并交给容器，使复杂的依赖关系管理从应用解放出来。</p>
<p>非侵入式、面向接口、体系结构的选择</p>
<p>interface21-》spring<br>    生态的丰富，得到j2ee服务的有力支持，使应用更关注业务逻辑，例如事务、持久化jdbc orm、校验、安全、rmi、webMvc、消息等</p>
<p>面向接口开发<br>    例如 ORM 可以使用mybatis 和 hibernate</p>
<p>应用平台（体系结构的选择）<br>    它不会与第三方的解决方案进行竞争，而是致力于为应用提供使用优秀方案的集成平台。让用户对具体技术方案拥有使用权，Aop集成了aspectJ框架 同时也有proxyFactory代理工厂（jvm动态、cglib第三方），Mvc模式不是指springMvc ，而是不属于GOF23的一种设计模式</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/02/spring/" data-id="cjtjoe4hw0005v49csrmpaw7o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-servlet-springmvc" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/03/servlet-springmvc/" class="article-date">
  <time datetime="2019-02-03T07:50:16.000Z" itemprop="datePublished">2019-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/03/servlet-springmvc/">servlet_spring-mvc</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#1-springmvc-核心servlet-dispatcherservlet">1. springMVC 核心servlet —DispatcherServlet</a><ul>
<li><a href="#11-整体结构">1.1 整体结构</a></li>
<li><a href="#12-创建过程">1.2 创建过程</a><ul>
<li><a href="#121-httpservletbean的创建">1.2.1 HttpServletBean的创建</a></li>
<li><a href="#122-framewordkservlet的创建">1.2.2 FramewordkServlet的创建</a></li>
<li><a href="#123-dispatcherservlet的创建">1.2.3 DispatcherServlet的创建</a></li>
</ul>
</li>
<li><a href="#13-组件概览">1.3 组件概览</a><ul>
<li><a href="#131-handlermapping">1.3.1 HandlerMapping</a></li>
<li><a href="#132-handleradapter">1.3.2 HandlerAdapter</a></li>
<li><a href="#133-handlerexceptionresolver">1.3.3 HandlerExceptionResolver</a></li>
<li><a href="#134-viewresolver">1.3.4 ViewResolver</a></li>
<li><a href="#135-requesttoviewnametranslator">1.3.5 RequestToViewNameTranslator</a></li>
<li><a href="#136-localeresolver">1.3.6 LocaleResolver</a></li>
<li><a href="#137-themeresolver">1.3.7 ThemeResolver</a></li>
<li><a href="#138-multipartresolver">1.3.8 MultipartResolver</a></li>
<li><a href="#139-flashmapmanager">1.3.9 FlashMapManager</a></li>
</ul>
</li>
<li><a href="#14-处理请求">1.4 处理请求</a><ul>
<li><a href="#141-frameworkservlet">1.4.1 FrameworkServlet</a></li>
<li><a href="#142-dispatcherservlet">1.4.2 DispatcherServlet</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-异步请求">2. 异步请求</a><ul>
<li><a href="#21-servlet异步支持">2.1 servlet异步支持</a><ul>
<li><a href="#211servletrequest">2.1.1ServletRequest</a></li>
<li><a href="#212-异步容器asynccontext">2.1.2 异步容器AsyncContext</a></li>
<li><a href="#213-asynclistener监听器">2.1.3 AsyncListener监听器</a></li>
</ul>
</li>
<li><a href="#22-springmvc中的相关组件">2.2 SpringMVC中的相关组件</a><ul>
<li><a href="#221-asyncwebrequest">2.2.1 AsyncWebRequest</a></li>
<li><a href="#222-webasyncmanager">2.2.2 WebAsyncManager</a></li>
<li><a href="#223-webasyncutils">2.2.3 WebAsyncUtils</a></li>
</ul>
</li>
<li><a href="#23-springmvc中请求的支持">2.3 SpringMVC中请求的支持</a></li>
<li><a href="#24-springwebflux-待补充">2.4 SpringWebFlux  ==待补充==</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<hr>
<h4><span id="1-springmvc-核心servlet-dispatcherservlet">1. springMVC 核心servlet —DispatcherServlet</span></h4><p>​    <code>基于spring-webmvc 4.0.3.RELEASE</code></p>
<h5><span id="11-整体结构">1.1 整体结构</span></h5><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fyc0ein61sj31m20u0adx.jpg" alt="image-20181219135235499"></p>
<blockquote>
<p>Aware：如果某个类想使用Spring的一些东西，就可以实现Aware接口</p>
<p>Capable:具有spring某个类的能力</p>
</blockquote>
<h5><span id="12-创建过程">1.2 创建过程</span></h5><h6><span id="121-httpservletbean的创建">1.2.1 HttpServletBean的创建</span></h6><p>​        实现了<code>EnvironmentCapable</code>、<code>EnvironmentAware</code> ，主要作用是将Servlet中配置的参数设置到相应的</p>
<h6><span id="122-framewordkservlet的创建">1.2.2 FramewordkServlet的创建</span></h6><p>​        实现了<code>ApplicationContextAware</code>，其主要作用是调用<code>initWebApplicationContext()</code>初始化<code>WebApplicationContext</code></p>
<ul>
<li>获取spring的根工期rootContext</li>
<li>设置webApplicationContext并根据情况调用onRefresh方法</li>
<li>将WebApplicationContext设置到ServletContext中            </li>
</ul>
<h6><span id="123-dispatcherservlet的创建">1.2.3 DispatcherServlet的创建</span></h6><p>​    onRefresh方法是DispatcherServlet的入口方法，onRefresh中调用了initStrategies()方法来初始化一些策略组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.initStrategies(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the strategy objects that this servlet uses.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">    initMultipartResolver(context);</span><br><span class="line">    initLocaleResolver(context);</span><br><span class="line">    initThemeResolver(context);</span><br><span class="line">    initHandlerMappings(context);</span><br><span class="line">    initHandlerAdapters(context);</span><br><span class="line">    initHandlerExceptionResolvers(context);</span><br><span class="line">    initRequestToViewNameTranslator(context);</span><br><span class="line">    initViewResolvers(context);</span><br><span class="line">    initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有配置相关，会使用默认的配置，在DispatcherServlet.properties文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Default implementation classes for DispatcherServlet&apos;s strategy interfaces.</span><br><span class="line"># Used as fallback when no matching beans are found in the DispatcherServlet context.</span><br><span class="line"># Not meant to be customized by application developers.</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.LocaleResolver=org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ThemeResolver=org.springframework.web.servlet.theme.FixedThemeResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerMapping=org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerAdapter=org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter,\</span><br><span class="line">   org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerExceptionResolver=org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerExceptionResolver,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver,\</span><br><span class="line">   org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.RequestToViewNameTranslator=org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ViewResolver=org.springframework.web.servlet.view.InternalResourceViewResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.FlashMapManager=org.springframework.web.servlet.support.SessionFlashMapManager</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips：If no bean is defined with the given name in the BeanFactory for this namespace, no multipart handling is provided.</p>
</blockquote>
<h5><span id="13-组件概览">1.3 组件概览</span></h5><h6><span id="131-handlermapping">1.3.1 HandlerMapping</span></h6><p>​    它的作用是根据request找到对应的处理器handler和Interceptors ,首先看下接口信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects that define a mapping between</span></span><br><span class="line"><span class="comment"> * requests and handler objects.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.core.Ordered</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.AbstractHandlerMapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.SimpleUrlHandlerMapping</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMapping</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   String PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".pathWithinHandlerMapping"</span>;</span><br><span class="line"></span><br><span class="line">   String BEST_MATCHING_PATTERN_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".bestMatchingPattern"</span>;</span><br><span class="line"></span><br><span class="line">   String INTROSPECT_TYPE_LEVEL_MAPPING = HandlerMapping.class.getName() + <span class="string">".introspectTypeLevelMapping"</span>;</span><br><span class="line"></span><br><span class="line">   String URI_TEMPLATE_VARIABLES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".uriTemplateVariables"</span>;</span><br><span class="line"></span><br><span class="line">   String MATRIX_VARIABLES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".matrixVariables"</span>;</span><br><span class="line"></span><br><span class="line">   String PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".producibleMediaTypes"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Return a handler and any interceptors for this request. The choice may be made</span></span><br><span class="line"><span class="comment">    * on request URL, session state, or any factor the implementing class chooses.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;The returned HandlerExecutionChain contains a handler Object, rather than</span></span><br><span class="line"><span class="comment">    * even a tag interface, so that handlers are not constrained in any way.</span></span><br><span class="line"><span class="comment">    * For example, a HandlerAdapter could be written to allow another framework's</span></span><br><span class="line"><span class="comment">    * handler objects to be used.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Returns &#123;<span class="doctag">@code</span> null&#125; if no match was found. This is not an error.</span></span><br><span class="line"><span class="comment">    * The DispatcherServlet will query all registered HandlerMapping beans to find</span></span><br><span class="line"><span class="comment">    * a match, and only decide there is an error if none can find a handler.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a HandlerExecutionChain instance containing handler object and</span></span><br><span class="line"><span class="comment">    * any interceptors, or &#123;<span class="doctag">@code</span> null&#125; if no mapping found</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if there is an internal error</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以常用接口实现为例，RequestMappingHandlerMapping</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyc839v8vdj31l20u043g.jpg" alt="image-20181219181838287"></p>
<blockquote>
<p>这里提供了Ordered接口，可以确定匹配的顺序，同时通过继承WebApplicationObjectSupport抽象类，可以获取相关Bean（handler）,更多细节可查看 类AbstractHandlerMapping。</p>
</blockquote>
<h6><span id="132-handleradapter">1.3.2 HandlerAdapter</span></h6><p>​    之所以要使用HandlerAdapter，是为SpringMVC中并没有对处理器做任何的限制，可以是个类，方法（HandlerMethod）这点从hanlder是Object就可以看出，首先是接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVC framework SPI interface, allowing parameterization of core MVC workflow.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Interface that must be implemented for each handler type to handle a request.</span></span><br><span class="line"><span class="comment"> * This interface is used to allow the &#123;<span class="doctag">@link</span> DispatcherServlet&#125; to be indefinitely</span></span><br><span class="line"><span class="comment"> * extensible. The DispatcherServlet accesses all installed handlers through this</span></span><br><span class="line"><span class="comment"> * interface, meaning that it does not contain code specific to any handler type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note that a handler can be of type &#123;<span class="doctag">@code</span> Object&#125;. This is to enable</span></span><br><span class="line"><span class="comment"> * handlers from other frameworks to be integrated with this framework without</span></span><br><span class="line"><span class="comment"> * custom coding, as well as to allow for annotation handler objects that do</span></span><br><span class="line"><span class="comment"> * not obey any specific Java interface.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This interface is not intended for application developers. It is available</span></span><br><span class="line"><span class="comment"> * to handlers who want to develop their own web workflow.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: HandlerAdaptger implementators may implement the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.core.Ordered&#125; interface to be able to specify a</span></span><br><span class="line"><span class="comment"> * sorting order (and thus a priority) for getting applied by DispatcherServlet.</span></span><br><span class="line"><span class="comment"> * Non-Ordered instances get treated as lowest priority.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.SimpleServletHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Given a handler instance, return whether or not this HandlerAdapter can</span></span><br><span class="line"><span class="comment">    * support it. Typical HandlerAdapters will base the decision on the handler</span></span><br><span class="line"><span class="comment">    * type. HandlerAdapters will usually only support one handler type each.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;A typical implementation:</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">    * return (handler instanceof MyHandler);</span></span><br><span class="line"><span class="comment">    * &#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler object to check</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> whether or not this object can use the given handler</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Use the given handler to handle this request.</span></span><br><span class="line"><span class="comment">    * The workflow that is required may vary widely.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler to use. This object must have previously been passed</span></span><br><span class="line"><span class="comment">    * to the &#123;<span class="doctag">@code</span> supports&#125; method of this interface, which must have</span></span><br><span class="line"><span class="comment">    * returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ModelAndView object with the name of the view and the required</span></span><br><span class="line"><span class="comment">    * model data, or &#123;<span class="doctag">@code</span> null&#125; if the request has been handled directly</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Same contract as for HttpServlet's &#123;<span class="doctag">@code</span> getLastModified&#125; method.</span></span><br><span class="line"><span class="comment">    * Can simply return -1 if there's no support in the handler class.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler to use</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the lastModified value for the given handler</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServlet#getLastModified</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> org.springframework.web.servlet.mvc.LastModified#getLastModified</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中一个实现类<code>SimpleControllerHandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.mvc;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adapter to use the plain &#123;<span class="doctag">@link</span> Controller&#125; workflow interface with</span></span><br><span class="line"><span class="comment"> * the generic &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;.</span></span><br><span class="line"><span class="comment"> * Supports handlers that implement the &#123;<span class="doctag">@link</span> LastModified&#125; interface.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This is an SPI class, not used directly by application code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.DispatcherServlet</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Controller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> LastModified</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> HttpRequestHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleControllerHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">HandlerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> Controller);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ((Controller) handler).handleRequest(request, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> LastModified) &#123;</span><br><span class="line">         <span class="keyword">return</span> ((LastModified) handler).getLastModified(request);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般默认使用的是 RequestMappingHandlerAdapter ,在其父类中有这样一句设置Order</p>
<p><code>private int order = Ordered.LOWEST_PRECEDENCE;</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fyc7lnlrzmj318o0u042e.jpg" alt="image-20181219180136155"></p>
<blockquote>
<p>HandlerAdapter implementators may implement the Order，使用时候是遍历 handlerAdapters ，调用supports判断直接返回（除了设置的，默认的实现有3个）。注意Order是越低优先级越高的。更多细节可以查看#afterPropertiesSet()方法</p>
</blockquote>
<p>总结一下，主要做了三件事，解析参数、执行请求，处理返回结果</p>
<ul>
<li>解析参数的过程中用到的参数来源有多个，大体可分为两类，一类是从Model来的（通过FlashMapManager和ModelFactory），另一类是从Request来的, 具体使用HandlerMethodArgumentResolver进行解析（有的是@InitBinder WebDataBinder）</li>
<li>执行请求的是用HandlerMethod的子类ServletInvocableHandlerMethod</li>
<li>返回值用HandlerMethodReturnValueHandler进行解析。</li>
</ul>
<p>另外，整个处理过程中ModelAndViewContainer起着参数传递的作用。</p>
<p>​    这里还有一个需要注意的，就是<code>RequestMappingHandlerAdapter</code> 是怎么注入的，通过debug发现，默认的实现HandlerAdapter 有 3个 ,除了前者还有<code>HttpRequestHandlerAdapte</code>、<code>SimpleControllerHandlerAdapte</code>的，<a href="https://docs.spring.io/spring/docs/3.2.10.RELEASE/spring-framework-reference/html/mvc.html#mvc-config-enable" target="_blank" rel="noopener">通过查询官方文档发现</a>，只要在配置文件配置了<code>mvc:annotation-driven</code> ，会自动生成相关@RequestMapping的类。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fydcs34e4rj31y60qu11o.jpg" alt="image-20181220174621313"></p>
<blockquote>
<p>官方文档的截图</p>
</blockquote>
<h6><span id="133-handlerexceptionresolver">1.3.3 HandlerExceptionResolver</span></h6><p>​    根据异常设置ModelAndView，之后交给render方法去渲染，这里要注意它是在render之前工作，所以只作用于解析对请求做处理过程中的产生的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects than can resolve exceptions thrown</span></span><br><span class="line"><span class="comment"> * during handler mapping or execution, in the typical case to error views.</span></span><br><span class="line"><span class="comment"> * Implementors are typically registered as beans in the application context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Error views are analogous to the error page JSPs, but can be used with</span></span><br><span class="line"><span class="comment"> * any kind of exception including any checked exception, with potentially</span></span><br><span class="line"><span class="comment"> * fine-granular mappings for specific handlers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 22.11.2003</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Try to resolve the given exception that got thrown during on handler execution,</span></span><br><span class="line"><span class="comment">    * returning a ModelAndView that represents a specific error page if appropriate.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;The returned ModelAndView may be &#123;<span class="doctag">@linkplain</span> ModelAndView#isEmpty() empty&#125;</span></span><br><span class="line"><span class="comment">    * to indicate that the exception has been resolved successfully but that no view</span></span><br><span class="line"><span class="comment">    * should be rendered, for instance by setting a status code.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler the executed handler, or &#123;<span class="doctag">@code</span> null&#125; if none chosen at the</span></span><br><span class="line"><span class="comment">    * time of the exception (for example, if multipart resolution failed)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ex the exception that got thrown during handler execution</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a corresponding ModelAndView to forward to,</span></span><br><span class="line"><span class="comment">    * or &#123;<span class="doctag">@code</span> null&#125; for default processing</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实现SimpleMappingExceptionResolver 可以通过扩展配置，设置自定义类型</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyc6u9xp9nj30zn0u0ag3.jpg" alt="image-20181219173520333"></p>
<blockquote>
<p>可以配合定制自定义Exception，前端统一展示等</p>
</blockquote>
<h6><span id="134-viewresolver">1.3.4 ViewResolver</span></h6><p>​    通过viewName来找到 对应的View，View是用来渲染页面的，主要解决用什么模版和用什么规则填入参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects that can resolve views by name.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;View state doesn't change during the running of the application,</span></span><br><span class="line"><span class="comment"> * so implementations are free to cache views.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Implementations are encouraged to support internationalization,</span></span><br><span class="line"><span class="comment"> * i.e. localized view resolution.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.InternalResourceViewResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.ResourceBundleViewResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.XmlViewResolver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Resolve the given view by name.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Note: To allow for ViewResolver chaining, a ViewResolver should</span></span><br><span class="line"><span class="comment">    * return &#123;<span class="doctag">@code</span> null&#125; if a view with the given name is not defined in it.</span></span><br><span class="line"><span class="comment">    * However, this is not required: Some ViewResolvers will always attempt</span></span><br><span class="line"><span class="comment">    * to build View objects with the given name, unable to return &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    * (rather throwing an exception when View creation failed).</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> viewName name of the view to resolve</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> locale Locale in which to resolve the view.</span></span><br><span class="line"><span class="comment">    * ViewResolvers that support internationalization should respect this.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the View object, or &#123;<span class="doctag">@code</span> null&#125; if not found</span></span><br><span class="line"><span class="comment">    * (optional, to allow for ViewResolver chaining)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if the view cannot be resolved</span></span><br><span class="line"><span class="comment">    * (typically in case of problems creating an actual View object)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用的jsp解析</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fycat4mrudj310q0u043a.jpg" alt="image-20181219195241323"></p>
<p>按照类图可以把继承<code>AbstractCachingViewResolver</code>(里面两个Map的方式值得学习)分成两类</p>
<ul>
<li><code>ResourceBundleViewResolver</code>  可以同时支持多种类型的视图，需要将每一个视图名和对应的视图类型配置到相应的properties文件中,该类的注释中，解释了其用法,</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;p&gt;This &#123;@code ViewResolver&#125; supports localized view definitions,</span></span><br><span class="line"><span class="comment">* using the default support of &#123;@link java.util.PropertyResourceBundle&#125;.</span></span><br><span class="line"><span class="comment">* For example, the basename "views" will be resolved as class path resources</span></span><br><span class="line"><span class="comment">* "views_de_AT.properties", "views_de.properties", "views.properties" -</span></span><br><span class="line"><span class="comment">* for a given Locale "de_AT"./</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>UrlBasedViewResolver</code>系列的解析器都是对单一视图进行解析的，只需找到模版就行，例如</li>
</ul>
<p><code>InternalResourceViewResolver</code> 是专门用来解析jsp，<code>FreeMarkerViewResolver</code>只针对FreeMarker</p>
<blockquote>
<p>相关扩展ExecelViewResolver、SimpleMapViewResolver</p>
<p>默认实现是 InternalResourceViewResolver</p>
</blockquote>
<h6><span id="135-requesttoviewnametranslator">1.3.5 RequestToViewNameTranslator</span></h6><p>比较简单，当handler处理完后，没有View和ViewName的会调用该方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Do we need view name translation?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyDefaultViewName</span><span class="params">(HttpServletRequest request, ModelAndView mv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.hasView()) &#123;</span><br><span class="line">      mv.setViewName(getDefaultViewName(request));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Translate the supplied request into a default view name.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP servlet request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the view name (or &#123;<span class="doctag">@code</span> null&#125; if no default found)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception if view name translation failed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getDefaultViewName</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.viewNameTranslator.getViewName(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>​    默认实现是RequestToViewNameTranslator</p>
</blockquote>
<h6><span id="136-localeresolver">1.3.6 LocaleResolver</span></h6><p>​    用于从request中解析出Locale,默认实现是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.i18n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.LocaleResolver;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> LocaleResolver&#125; implementation that simply uses the primary locale</span></span><br><span class="line"><span class="comment"> * specified in the "accept-language" header of the HTTP request (that is,</span></span><br><span class="line"><span class="comment"> * the locale sent by the client browser, normally that of the client's OS).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: Does not support &#123;<span class="doctag">@code</span> setLocale&#125;, since the accept header</span></span><br><span class="line"><span class="comment"> * can only be changed through changing the client's locale settings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 27.02.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getLocale()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptHeaderLocaleResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> request.getLocale();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">            <span class="string">"Cannot change HTTP accept header - use a different locale resolution strategy"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    在DispatcherServlet#doSerive()方法中， <code>request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);</code> 放进request中，这里除了视图解析的时候需要用到，在使用国际化主题的时候也会用到</p>
<blockquote>
<p>切换相关，可查看 LocaleChangeInterceptor</p>
</blockquote>
<h6><span id="137-themeresolver">1.3.7 ThemeResolver</span></h6><p>​    SpringMVC中和主题相关的类有如下</p>
<ul>
<li>ThemeResolver 作用是从request中解析出主题名,默认实现FixedThemeResolver</li>
<li>ThemeSource 根据主题名找到对应的主题 ，默认使用WebApplicationContext</li>
<li>Theme 就是主题，包含了具体资源</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.theme;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.ThemeResolver&#125; implementation</span></span><br><span class="line"><span class="comment"> * that simply uses a fixed theme. The fixed name can be defined via</span></span><br><span class="line"><span class="comment"> * the "defaultThemeName" property; out of the box, it is "theme".</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: Does not support &#123;<span class="doctag">@code</span> setThemeName&#125;, as the fixed theme</span></span><br><span class="line"><span class="comment"> * cannot be changed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jean-Pierre Pawlak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 17.06.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setDefaultThemeName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedThemeResolver</span> <span class="keyword">extends</span> <span class="title">AbstractThemeResolver</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getDefaultThemeName();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot change theme - use a different theme resolution strategy"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>切换相关，可查看 ThemeChangeInterceptor</p>
</blockquote>
<h6><span id="138-multipartresolver">1.3.8 MultipartResolver</span></h6><p>​    用于处理文件上传，注意这个组件在DispatcherServlet.properties 中 没有默认实现,首先是接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.multipart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A strategy interface for multipart file upload resolution in accordance</span></span><br><span class="line"><span class="comment"> * with &lt;a href="http://www.ietf.org/rfc/rfc1867.txt"&gt;RFC 1867&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> * Implementations are typically usable both within an application context</span></span><br><span class="line"><span class="comment"> * and standalone.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;There are two concrete implementations included in Spring, as of Spring 3.1:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> org.springframework.web.multipart.commons.CommonsMultipartResolver&#125; for Jakarta Commons FileUpload</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.StandardServletMultipartResolver&#125; for Servlet 3.0 Part API</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;There is no default resolver implementation used for Spring</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet DispatcherServlets&#125;,</span></span><br><span class="line"><span class="comment"> * as an application might choose to parse its multipart requests itself. To define</span></span><br><span class="line"><span class="comment"> * an implementation, create a bean with the id "multipartResolver" in a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet DispatcherServlet's&#125;</span></span><br><span class="line"><span class="comment"> * application context. Such a resolver gets applied to all requests handled</span></span><br><span class="line"><span class="comment"> * by that &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If a &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125; detects</span></span><br><span class="line"><span class="comment"> * a multipart request, it will resolve it via the configured</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; and pass on a</span></span><br><span class="line"><span class="comment"> * wrapped &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125;.</span></span><br><span class="line"><span class="comment"> * Controllers can then cast their given request to the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartHttpServletRequest&#125;</span></span><br><span class="line"><span class="comment"> * interface, which permits access to any</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartFile MultipartFiles&#125;.</span></span><br><span class="line"><span class="comment"> * Note that this cast is only supported in case of an actual multipart request.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre class="code"&gt;</span></span><br><span class="line"><span class="comment"> * public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) &#123;</span></span><br><span class="line"><span class="comment"> *   MultipartHttpServletRequest multipartRequest = (MultipartHttpServletRequest) request;</span></span><br><span class="line"><span class="comment"> *   MultipartFile multipartFile = multipartRequest.getFile("image");</span></span><br><span class="line"><span class="comment"> *   ...</span></span><br><span class="line"><span class="comment"> * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Instead of direct access, command or form controllers can register a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.ByteArrayMultipartFileEditor&#125;</span></span><br><span class="line"><span class="comment"> * or &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.StringMultipartFileEditor&#125;</span></span><br><span class="line"><span class="comment"> * with their data binder, to automatically apply multipart content to command</span></span><br><span class="line"><span class="comment"> * bean properties.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As an alternative to using a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; with a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;,</span></span><br><span class="line"><span class="comment"> * a &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.MultipartFilter&#125; can be</span></span><br><span class="line"><span class="comment"> * registered in &#123;<span class="doctag">@code</span> web.xml&#125;. It will delegate to a corresponding</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; bean in the root</span></span><br><span class="line"><span class="comment"> * application context. This is mainly intended for applications that do not</span></span><br><span class="line"><span class="comment"> * use Spring's own web MVC framework.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: There is hardly ever a need to access the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; itself</span></span><br><span class="line"><span class="comment"> * from application code. It will simply do its work behind the scenes,</span></span><br><span class="line"><span class="comment"> * making</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartHttpServletRequest MultipartHttpServletRequests&#125;</span></span><br><span class="line"><span class="comment"> * available to controllers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Trevor D. Cook</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 29.09.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MultipartHttpServletRequest</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MultipartFile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.commons.CommonsMultipartResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.support.ByteArrayMultipartFileEditor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.support.StringMultipartFileEditor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.DispatcherServlet</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Determine if the given request contains multipart content.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Will typically check for content type "multipart/form-data", but the actually</span></span><br><span class="line"><span class="comment">    * accepted requests might depend on the capabilities of the resolver implementation.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the servlet request to be evaluated</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> whether the request contains multipart content</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isMultipart</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the given HTTP request into multipart files and parameters,</span></span><br><span class="line"><span class="comment">    * and wrap the request inside a</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> org.springframework.web.multipart.MultipartHttpServletRequest&#125; object</span></span><br><span class="line"><span class="comment">    * that provides access to file descriptors and makes contained</span></span><br><span class="line"><span class="comment">    * parameters accessible via the standard ServletRequest methods.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the servlet request to wrap (must be of a multipart content type)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the wrapped servlet request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> MultipartException if the servlet request is not multipart, or if</span></span><br><span class="line"><span class="comment">    * implementation-specific problems are encountered (such as exceeding file size limits)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFile</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFileNames</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFileMap</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameter</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameterNames</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameterMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">MultipartHttpServletRequest <span class="title">resolveMultipart</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Cleanup any resources used for the multipart handling,</span></span><br><span class="line"><span class="comment">    * like a storage for the uploaded files.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the request to cleanup resources for</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用实现CommonsMultipartResolver</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fycdyq4kmxj31ta0u0ahy.jpg" alt="image-20181219214146380"></p>
<blockquote>
<p>对于上传类型判断是 multipart/form-data</p>
<p>两种实现，一种是Servlet的标准实现StandardServletMultipartResolver 一种是Apache的commons-fileupload方式</p>
</blockquote>
<h6><span id="139-flashmapmanager">1.3.9 FlashMapManager</span></h6><p>​    FlashMap主要用于redirect中传递参数，FlashMapManage是用来管理FlashMap的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A strategy interface for retrieving and saving FlashMap instances.</span></span><br><span class="line"><span class="comment"> * See &#123;<span class="doctag">@link</span> FlashMap&#125; for a general overview of flash attributes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> FlashMap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlashMapManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Find a FlashMap saved by a previous request that matches to the current</span></span><br><span class="line"><span class="comment">    * request, remove it from underlying storage, and also remove other</span></span><br><span class="line"><span class="comment">    * expired FlashMap instances.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method is invoked in the beginning of every request in contrast</span></span><br><span class="line"><span class="comment">    * to &#123;<span class="doctag">@link</span> #saveOutputFlashMap&#125;, which is invoked only when there are</span></span><br><span class="line"><span class="comment">    * flash attributes to be saved - i.e. before a redirect.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a FlashMap matching the current request or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">FlashMap <span class="title">retrieveAndUpdate</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Save the given FlashMap, in some underlying storage and set the start</span></span><br><span class="line"><span class="comment">    * of its expiration period.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&lt;strong&gt;<span class="doctag">NOTE:</span>&lt;/strong&gt; Invoke this method prior to a redirect in order</span></span><br><span class="line"><span class="comment">    * to allow saving the FlashMap in the HTTP session or in a response</span></span><br><span class="line"><span class="comment">    * cookie before the response is committed.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> flashMap the FlashMap to save</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">saveOutputFlashMap</span><span class="params">(FlashMap flashMap, HttpServletRequest request, HttpServletResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    两个方法，分别是retrieveAndUpdate 用于恢复参数，saveOutputFlashMap用于保存参数</p>
<p>类图也比较简单</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyce346qynj30zc0u0q9t.jpg" alt="image-20181219214559988"></p>
<blockquote>
<p>默认实现是SessionFlashMapManager</p>
</blockquote>
<p>整个redirects 的参数通过FlashMap传递的过程分三步</p>
<ol>
<li>首先，RequestMappingHandlerAapter会将其设置到<code>outputFlashMap</code>中，如果是redirect类型的返回类型值（将需要传递的参数设置到<code>outputFlashMap</code>中，也可以是RedirectAttributes类型的参数中）</li>
<li>在RedirectView中会调用<code>#saveOutputFlashMap()</code>方法，将<code>outputFlashMap</code>中的参数设置到Session</li>
<li>请求redirect后，DispatcherServlet会调有你<code>#retrieveAndUpdate()</code>方法从Session中获取<code>inputFlashMap</code>并设置到Request的属性中备用，同时从Session中删除</li>
</ol>
<h5><span id="14-处理请求">1.4 处理请求</span></h5><h6><span id="141-frameworkservlet">1.4.1 FrameworkServlet</span></h6><p>​    Servlet的处理过程，首先是从Servlet接口的service，然后在HttpServlet的service方法中根据请求的类型不同将请求路由到了doGet、doHead等方法。</p>
<p>​    FrameworkServlet中重写了doGet等方法。将请求集中到processRequest方法进行统一处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Override the parent class implementation in order to intercept PATCH</span></span><br><span class="line"><span class="comment"> * requests.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    String method = request.getMethod();</span><br><span class="line">    <span class="keyword">if</span> (method.equalsIgnoreCase(RequestMethod.PATCH.name())) &#123;</span><br><span class="line">        processRequest(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate GET requests to processRequest/doService.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Will also be invoked by HttpServlet's default implementation of &#123;<span class="doctag">@code</span> doHead&#125;,</span></span><br><span class="line"><span class="comment"> * with a &#123;<span class="doctag">@code</span> NoBodyResponse&#125; that just captures the content length.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doHead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    processRequest这个方法主要做了两件事情(当然还有doService，和对异步请求对处理)</p>
<ul>
<li>对LocaleContext（获取locale）和RequestAttributes(管理request和session属性)的设置及恢复</li>
<li>处理完后发布ServletRequestHandledEvent消息</li>
</ul>
<p>LocaleContextHolder 、RequestContextHolder </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LocaleContextHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal localeContextHolder = <span class="keyword">new</span> NamedThreadLocal(<span class="string">"Locale context"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal inheritableLocaleContextHolder = <span class="keyword">new</span> NamedInheritableThreadLocal(<span class="string">"Locale context"</span>);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里比较有意思的地方是这是个抽象类，里面的方法实现都是静态方法，只能调用不能实例化。RequestContextHolder的实现类似，封装的是ServletRequestAttributes</p>
<blockquote>
<p>这里之所以需要对LocaleContext和RequestAttributes恢复，是因为在Servlet外面可能还有别等操作，例如Filter（Spring-MVC的HandlerInterceptor）,为了不影响那些操作。</p>
</blockquote>
<h6><span id="142-dispatcherservlet">1.4.2 DispatcherServlet</span></h6><p>​    DispatcherServlet是FrameworkServlet的子类，实现了doService方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class="doctag">@link</span> #doDispatch&#125;</span></span><br><span class="line"><span class="comment"> * for the actual dispatching.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class="line">    <span class="comment">// to be able to restore the original attributes after the include.</span></span><br><span class="line">    Map&lt;String, Object&gt; attributesSnapshot = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">        attributesSnapshot = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">        <span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">            String attrName = (String) attrNames.nextElement();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.cleanupAfterInclude || attrName.startsWith(<span class="string">"org.springframework.web.servlet"</span>)) &#123;</span><br><span class="line">                attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make framework objects available to handlers and view objects.</span></span><br><span class="line">    request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">    request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.localeResolver);</span><br><span class="line">    request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.themeResolver);</span><br><span class="line">    request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Pass paramter use to Redirect</span></span><br><span class="line">    FlashMap inputFlashMap = <span class="keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">    <span class="keyword">if</span> (inputFlashMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">    &#125;</span><br><span class="line">    request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> FlashMap());</span><br><span class="line">    request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="keyword">this</span>.flashMapManager);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doDispatch(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class="line">        <span class="keyword">if</span> (attributesSnapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">            restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在doDispatch之前做了</p>
<ul>
<li>判断是否include请求，是的话保存快照（attributesSnapshot）</li>
<li>为request设置默认的属性，在后面的handlers和view中需要使用</li>
</ul>
<p>下面是doDispatch的方法的实现，主要的功能是 Process the actual dispatching to the handler.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the actual dispatching to the handler.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The handler will be obtained by applying the servlet's HandlerMappings in order.</span></span><br><span class="line"><span class="comment"> * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters</span></span><br><span class="line"><span class="comment"> * to find the first that supports the handler class.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers</span></span><br><span class="line"><span class="comment"> * themselves to decide which methods are acceptable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    HttpServletRequest processedRequest = request;</span><br><span class="line">    HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">        Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processedRequest = checkMultipart(request);</span><br><span class="line">            multipartRequestParsed = processedRequest != request;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            <span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span> || mappedHandler.getHandler() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">            String method = request.getMethod();</span><br><span class="line">            <span class="keyword">boolean</span> isGet = <span class="string">"GET"</span>.equals(method);</span><br><span class="line">            <span class="keyword">if</span> (isGet || <span class="string">"HEAD"</span>.equals(method)) &#123;</span><br><span class="line">                <span class="keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Last-Modified value for ["</span> + getRequestUri(request) + <span class="string">"] is: "</span> + lastModified);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">                mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            applyDefaultViewName(request, mv);</span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">        triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">            mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">        <span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">            cleanupMultipart(processedRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个处理过程最核心的代码只有4句</p>
<ul>
<li>根据request请求在HandlerMapping找到对应的Handler </li>
<li>根据Handler找到对应的HandlerAdapter</li>
<li>用HandlerAdapter处理Handler,返回一个ModelAndView(Controller就是在这个地方执行)</li>
<li>根据ModelAndView的信息（或异常处理），通过ViewResolver找到View,并根据Model中的数据渲染输出后给用户</li>
</ul>
<p>整个<code>#doDispatcher()</code>处理流程如下</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fybvzj6p72j30u00ynju2.jpg" alt="image-20181219111943655"></p>
<blockquote>
<p>​    从请求开始的话，当请求到达服务器，服务器(Tomcat connector)分配一个socket线程来连接，创建request和response ，然后交给对应的servlet处理（中间经过Pipeline,Filter），这样请求就从容器(Tomcat)到Servlet（springMVC）</p>
</blockquote>
<p>​    </p>
<h4><span id="2-异步请求">2. 异步请求</span></h4><p>​    http协议是单向的，只能客户端自己拉，不能服务端主动推。异步请求一般有两种方式，定时轮询或长链接。Servlet对异步的支持是通过长链接的方式。</p>
<h5><span id="21-servlet异步支持">2.1 servlet异步支持</span></h5><h6><span id="211servletrequest">2.1.1ServletRequest</span></h6><p>​    首先是在 3.0后的 ServletRequest 中可以找到<code>#startAsync()</code> 返回一个异步容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Defines an object to provide client request information to a servlet.  The</span></span><br><span class="line"><span class="comment"> * servlet container creates a &lt;code&gt;ServletRequest&lt;/code&gt; object and passes</span></span><br><span class="line"><span class="comment"> * it as an argument to the servlet's &lt;code&gt;service&lt;/code&gt; method.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;A &lt;code&gt;ServletRequest&lt;/code&gt; object provides data including</span></span><br><span class="line"><span class="comment"> * parameter name and values, attributes, and an input stream.</span></span><br><span class="line"><span class="comment"> * Interfaces that extend &lt;code&gt;ServletRequest&lt;/code&gt; can provide</span></span><br><span class="line"><span class="comment"> * additional protocol-specific data (for example, HTTP data is</span></span><br><span class="line"><span class="comment"> * provided by &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 	Various</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> 	javax.servlet.http.HttpServletRequest</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletRequest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Puts this request into asynchronous mode, and initializes its</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncContext&#125; with the original (unwrapped) ServletRequest</span></span><br><span class="line"><span class="comment">     * and ServletResponse objects.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Calling this method will cause committal of the associated</span></span><br><span class="line"><span class="comment">     * response to be delayed until &#123;<span class="doctag">@link</span> AsyncContext#complete&#125; is</span></span><br><span class="line"><span class="comment">     * called on the returned &#123;<span class="doctag">@link</span> AsyncContext&#125;, or the asynchronous</span></span><br><span class="line"><span class="comment">     * operation has timed out.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Calling &#123;<span class="doctag">@link</span> AsyncContext#hasOriginalRequestAndResponse()&#125; on</span></span><br><span class="line"><span class="comment">     * the returned AsyncContext will return &lt;code&gt;true&lt;/code&gt;. Any filters</span></span><br><span class="line"><span class="comment">     * invoked in the &lt;i&gt;outbound&lt;/i&gt; direction after this request was put</span></span><br><span class="line"><span class="comment">     * into asynchronous mode may use this as an indication that any request</span></span><br><span class="line"><span class="comment">     * and/or response wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt;</span></span><br><span class="line"><span class="comment">     * invocation need not stay around for the duration of the asynchronous</span></span><br><span class="line"><span class="comment">     * operation, and therefore any of their associated resources may be</span></span><br><span class="line"><span class="comment">     * released.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method clears the list of &#123;<span class="doctag">@link</span> AsyncListener&#125; instances</span></span><br><span class="line"><span class="comment">     * (if any) that were registered with the AsyncContext returned by the</span></span><br><span class="line"><span class="comment">     * previous call to one of the startAsync methods, after calling each</span></span><br><span class="line"><span class="comment">     * AsyncListener at its &#123;<span class="doctag">@link</span> AsyncListener#onStartAsync onStartAsync&#125;</span></span><br><span class="line"><span class="comment">     * method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Subsequent invocations of this method, or its overloaded </span></span><br><span class="line"><span class="comment">     * variant, will return the same AsyncContext instance, reinitialized</span></span><br><span class="line"><span class="comment">     * as appropriate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the (re)initialized AsyncContext</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this request is within the scope of</span></span><br><span class="line"><span class="comment">     * a filter or servlet that does not support asynchronous operations</span></span><br><span class="line"><span class="comment">     * (that is, &#123;<span class="doctag">@link</span> #isAsyncSupported&#125; returns false),</span></span><br><span class="line"><span class="comment">     * or if this method is called again without any asynchronous dispatch</span></span><br><span class="line"><span class="comment">     * (resulting from one of the &#123;<span class="doctag">@link</span> AsyncContext#dispatch&#125; methods),</span></span><br><span class="line"><span class="comment">     * is called outside the scope of any such dispatch, or is called again</span></span><br><span class="line"><span class="comment">     * within the scope of the same dispatch, or if the response has</span></span><br><span class="line"><span class="comment">     * already been closed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncContext <span class="title">startAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6><span id="212-异步容器asynccontext">2.1.2  异步容器AsyncContext</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class representing the execution context for an asynchronous operation</span></span><br><span class="line"><span class="comment"> * that was initiated on a ServletRequest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An AsyncContext is created and initialized by a call to</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment"> * Repeated invocations of these methods will return the same AsyncContext</span></span><br><span class="line"><span class="comment"> * instance, reinitialized as appropriate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;In the event that an asynchronous operation has timed out, the</span></span><br><span class="line"><span class="comment"> * container must run through these steps:</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invoke, at their &#123;<span class="doctag">@link</span> AsyncListener#onTimeout onTimeout&#125; method, all</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> AsyncListener&#125; instances registered with the ServletRequest</span></span><br><span class="line"><span class="comment"> * on which the asynchronous operation was initiated.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If none of the listeners called &#123;<span class="doctag">@link</span> #complete&#125; or any of the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #dispatch&#125; methods, perform an error dispatch with a status code</span></span><br><span class="line"><span class="comment"> * equal to &lt;tt&gt;HttpServletResponse.SC_INTERNAL_SERVER_ERROR&lt;/tt&gt;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no matching error page was found, or the error page did not call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #complete&#125; or any of the &#123;<span class="doctag">@link</span> #dispatch&#125; methods, call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #complete&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * request URI is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_REQUEST_URI = <span class="string">"javax.servlet.async.request_uri"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * context path is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_CONTEXT_PATH = <span class="string">"javax.servlet.async.context_path"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * path info is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_PATH_INFO = <span class="string">"javax.servlet.async.path_info"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * servlet path is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125;  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_SERVLET_PATH = <span class="string">"javax.servlet.async.servlet_path"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * query string is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_QUERY_STRING = <span class="string">"javax.servlet.async.query_string"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the request that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     * by calling &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the request that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRequest <span class="title">getRequest</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the response that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     * by calling &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the response that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletResponse <span class="title">getResponse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if this AsyncContext was initialized with the original or</span></span><br><span class="line"><span class="comment">     * application-wrapped request and response objects.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This information may be used by filters invoked in the</span></span><br><span class="line"><span class="comment">     * &lt;i&gt;outbound&lt;/i&gt; direction, after a request was put into</span></span><br><span class="line"><span class="comment">     * asynchronous mode, to determine whether any request and/or response</span></span><br><span class="line"><span class="comment">     * wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt; invocation need</span></span><br><span class="line"><span class="comment">     * to be preserved for the duration of the asynchronous operation, or may</span></span><br><span class="line"><span class="comment">     * be released.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if this AsyncContext was initialized with the original</span></span><br><span class="line"><span class="comment">     * request and response objects by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125;, or if it was initialized by</span></span><br><span class="line"><span class="comment">     * calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and neither the ServletRequest nor ServletResponse arguments </span></span><br><span class="line"><span class="comment">     * carried any application-provided wrappers; false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasOriginalRequestAndResponse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the servlet container.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If the asynchronous cycle was started with</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and the request passed is an instance of HttpServletRequest,</span></span><br><span class="line"><span class="comment">     * then the dispatch is to the URI returned by</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest#getRequestURI&#125;.</span></span><br><span class="line"><span class="comment">     * Otherwise, the dispatch is to the URI of the request when it was</span></span><br><span class="line"><span class="comment">     * last dispatched by the container.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The following sequence illustrates how this will work:</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * // REQUEST dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * AsyncContext ac = request.startAsync();</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * // FORWARD dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * getRequestDispatcher("/url/B").forward(request,response);</span></span><br><span class="line"><span class="comment">     * // Start async operation from within the target of the FORWARD</span></span><br><span class="line"><span class="comment">     * // dispatch</span></span><br><span class="line"><span class="comment">     * ac = request.startAsync();</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * // FORWARD dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * getRequestDispatcher("/url/B").forward(request,response);</span></span><br><span class="line"><span class="comment">     * // Start async operation from within the target of the FORWARD</span></span><br><span class="line"><span class="comment">     * // dispatch</span></span><br><span class="line"><span class="comment">     * ac = request.startAsync(request,response);</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method returns immediately after passing the request</span></span><br><span class="line"><span class="comment">     * and response objects to a container managed thread, on which the</span></span><br><span class="line"><span class="comment">     * dispatch operation will be performed.</span></span><br><span class="line"><span class="comment">     * If this method is called before the container-initiated dispatch</span></span><br><span class="line"><span class="comment">     * that called &lt;tt&gt;startAsync&lt;/tt&gt; has returned to the container, the</span></span><br><span class="line"><span class="comment">     * dispatch operation will be delayed until after the container-initiated</span></span><br><span class="line"><span class="comment">     * dispatch has returned to the container.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The dispatcher type of the request is set to</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;DispatcherType.ASYNC&lt;/tt&gt;. Unlike</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> RequestDispatcher#forward(ServletRequest, ServletResponse)</span></span><br><span class="line"><span class="comment">     * forward dispatches&#125;, the response buffer and</span></span><br><span class="line"><span class="comment">     * headers will not be reset, and it is legal to dispatch even if the</span></span><br><span class="line"><span class="comment">     * response has already been committed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Control over the request and response is delegated</span></span><br><span class="line"><span class="comment">     * to the dispatch target, and the response will be closed when the</span></span><br><span class="line"><span class="comment">     * dispatch target has completed execution, unless</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;</span></span><br><span class="line"><span class="comment">     * are called.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Any errors or exceptions that may occur during the execution</span></span><br><span class="line"><span class="comment">     * of this method must be caught and handled by the container, as</span></span><br><span class="line"><span class="comment">     * follows:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;Invoke, at their &#123;<span class="doctag">@link</span> AsyncListener#onError onError&#125; method, all</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncListener&#125; instances registered with the ServletRequest</span></span><br><span class="line"><span class="comment">     * for which this AsyncContext was created, and make the caught </span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;Throwable&lt;/tt&gt; available via &#123;<span class="doctag">@link</span> AsyncEvent#getThrowable&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If none of the listeners called &#123;<span class="doctag">@link</span> #complete&#125; or any of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch&#125; methods, perform an error dispatch with a status code</span></span><br><span class="line"><span class="comment">     * equal to &lt;tt&gt;HttpServletResponse.SC_INTERNAL_SERVER_ERROR&lt;/tt&gt;, and</span></span><br><span class="line"><span class="comment">     * make the above &lt;tt&gt;Throwable&lt;/tt&gt; available as the value of the</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;RequestDispatcher.ERROR_EXCEPTION&lt;/tt&gt; request attribute.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If no matching error page was found, or the error page did not call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #complete&#125; or any of the &#123;<span class="doctag">@link</span> #dispatch&#125; methods, call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #complete&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the given &lt;tt&gt;path&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &lt;tt&gt;path&lt;/tt&gt; parameter is interpreted in the same way </span></span><br><span class="line"><span class="comment">     * as in &#123;<span class="doctag">@link</span> ServletRequest#getRequestDispatcher(String)&#125;, within</span></span><br><span class="line"><span class="comment">     * the scope of the &#123;<span class="doctag">@link</span> ServletContext&#125; from which this</span></span><br><span class="line"><span class="comment">     * AsyncContext was initialized.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;All path related query methods of the request must reflect the</span></span><br><span class="line"><span class="comment">     * dispatch target, while the original request URI, context path,</span></span><br><span class="line"><span class="comment">     * path info, servlet path, and query string may be recovered from</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #ASYNC_REQUEST_URI&#125;, &#123;<span class="doctag">@link</span> #ASYNC_CONTEXT_PATH&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_PATH_INFO&#125;, &#123;<span class="doctag">@link</span> #ASYNC_SERVLET_PATH&#125;, and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_QUERY_STRING&#125; attributes of the request. These</span></span><br><span class="line"><span class="comment">     * attributes will always reflect the original path elements, even under</span></span><br><span class="line"><span class="comment">     * repeated dispatches.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;See &#123;<span class="doctag">@link</span> #dispatch()&#125; for additional details, including error</span></span><br><span class="line"><span class="comment">     * handling.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path the path of the dispatch target, scoped to the</span></span><br><span class="line"><span class="comment">     * ServletContext from which this AsyncContext was initialized</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the given &lt;tt&gt;path&lt;/tt&gt; scoped to the given &lt;tt&gt;context&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &lt;tt&gt;path&lt;/tt&gt; parameter is interpreted in the same way </span></span><br><span class="line"><span class="comment">     * as in &#123;<span class="doctag">@link</span> ServletRequest#getRequestDispatcher(String)&#125;, except that</span></span><br><span class="line"><span class="comment">     * it is scoped to the given &lt;tt&gt;context&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;All path related query methods of the request must reflect the</span></span><br><span class="line"><span class="comment">     * dispatch target, while the original request URI, context path,</span></span><br><span class="line"><span class="comment">     * path info, servlet path, and query string may be recovered from</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #ASYNC_REQUEST_URI&#125;, &#123;<span class="doctag">@link</span> #ASYNC_CONTEXT_PATH&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_PATH_INFO&#125;, &#123;<span class="doctag">@link</span> #ASYNC_SERVLET_PATH&#125;, and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_QUERY_STRING&#125; attributes of the request. These</span></span><br><span class="line"><span class="comment">     * attributes will always reflect the original path elements, even under</span></span><br><span class="line"><span class="comment">     * repeated dispatches.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;See &#123;<span class="doctag">@link</span> #dispatch()&#125; for additional details, including error</span></span><br><span class="line"><span class="comment">     * handling.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context the ServletContext of the dispatch target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path the path of the dispatch target, scoped to the given</span></span><br><span class="line"><span class="comment">     * ServletContext</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(ServletContext context, String path)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Completes the asynchronous operation that was started on the request</span></span><br><span class="line"><span class="comment">     * that was used to initialze this AsyncContext, closing the response</span></span><br><span class="line"><span class="comment">     * that was used to initialize this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Any listeners of type &#123;<span class="doctag">@link</span> AsyncListener&#125; that were registered</span></span><br><span class="line"><span class="comment">     * with the ServletRequest for which this AsyncContext was created will</span></span><br><span class="line"><span class="comment">     * be invoked at their &#123;<span class="doctag">@link</span> AsyncListener#onComplete(AsyncEvent)</span></span><br><span class="line"><span class="comment">     * onComplete&#125; method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;It is legal to call this method any time after a call to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and before a call to one of the &lt;tt&gt;dispatch&lt;/tt&gt; methods</span></span><br><span class="line"><span class="comment">     * of this class. </span></span><br><span class="line"><span class="comment">     * If this method is called before the container-initiated dispatch</span></span><br><span class="line"><span class="comment">     * that called &lt;tt&gt;startAsync&lt;/tt&gt; has returned to the container, then</span></span><br><span class="line"><span class="comment">     * the call will not take effect (and any invocations of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncListener#onComplete(AsyncEvent)&#125; will be delayed) until</span></span><br><span class="line"><span class="comment">     * after the container-initiated dispatch has returned to the container.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Causes the container to dispatch a thread, possibly from a managed</span></span><br><span class="line"><span class="comment">     * thread pool, to run the specified &lt;tt&gt;Runnable&lt;/tt&gt;. The container may</span></span><br><span class="line"><span class="comment">     * propagate appropriate contextual information to the &lt;tt&gt;Runnable&lt;/tt&gt;. </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> run the asynchronous handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Runnable run)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers the given &#123;<span class="doctag">@link</span> AsyncListener&#125; with the most recent</span></span><br><span class="line"><span class="comment">     * asynchronous cycle that was started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener will receive an &#123;<span class="doctag">@link</span> AsyncEvent&#125; when</span></span><br><span class="line"><span class="comment">     * the asynchronous cycle completes successfully, times out, or results</span></span><br><span class="line"><span class="comment">     * in an error.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;AsyncListener instances will be notified in the order in which</span></span><br><span class="line"><span class="comment">     * they were added.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener the AsyncListener to be registered</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(AsyncListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers the given &#123;<span class="doctag">@link</span> AsyncListener&#125; with the most recent</span></span><br><span class="line"><span class="comment">     * asynchronous cycle that was started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener will receive an &#123;<span class="doctag">@link</span> AsyncEvent&#125; when</span></span><br><span class="line"><span class="comment">     * the asynchronous cycle completes successfully, times out, or results</span></span><br><span class="line"><span class="comment">     * in an error.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;AsyncListener instances will be notified in the order in which</span></span><br><span class="line"><span class="comment">     * they were added.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given ServletRequest and ServletResponse objects will</span></span><br><span class="line"><span class="comment">     * be made available to the given AsyncListener via the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125; methods,</span></span><br><span class="line"><span class="comment">     * respectively, of the &#123;<span class="doctag">@link</span> AsyncEvent&#125; delivered to it. These objects</span></span><br><span class="line"><span class="comment">     * should not be read from or written to, respectively, at the time the</span></span><br><span class="line"><span class="comment">     * AsyncEvent is delivered, because additional wrapping may have</span></span><br><span class="line"><span class="comment">     * occurred since the given AsyncListener was registered, but may be used</span></span><br><span class="line"><span class="comment">     * in order to release any resources associated with them.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener the AsyncListener to be registered</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servletRequest the ServletRequest that will be included</span></span><br><span class="line"><span class="comment">     * in the AsyncEvent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servletResponse the ServletResponse that will be included</span></span><br><span class="line"><span class="comment">     * in the AsyncEvent</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(AsyncListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">                            ServletRequest servletRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                            ServletResponse servletResponse)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates the given &#123;<span class="doctag">@link</span> AsyncListener&#125; class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The returned AsyncListener instance may be further customized</span></span><br><span class="line"><span class="comment">     * before it is registered with this AsyncContext via a call to one of </span></span><br><span class="line"><span class="comment">     * the &lt;code&gt;addListener&lt;/code&gt; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener class must define a zero argument</span></span><br><span class="line"><span class="comment">     * constructor, which is used to instantiate it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method supports resource injection if the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;clazz&lt;/tt&gt; represents a Managed Bean.</span></span><br><span class="line"><span class="comment">     * See the Java EE platform and JSR 299 specifications for additional</span></span><br><span class="line"><span class="comment">     * details about Managed Beans and resource injection.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method supports any annotations applicable to AsyncListener.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the AsyncListener class to instantiate</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new AsyncListener instance</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException if the given &lt;tt&gt;clazz&lt;/tt&gt; fails to be</span></span><br><span class="line"><span class="comment">     * instantiated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends AsyncListener&gt; <span class="function">T <span class="title">createListener</span><span class="params">(Class&lt;T&gt; clazz)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the timeout (in milliseconds) for this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The timeout applies to this AsyncContext once the</span></span><br><span class="line"><span class="comment">     * container-initiated dispatch during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called has</span></span><br><span class="line"><span class="comment">     * returned to the container. </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The timeout will expire if neither the &#123;<span class="doctag">@link</span> #complete&#125; method</span></span><br><span class="line"><span class="comment">     * nor any of the dispatch methods are called. A timeout value of</span></span><br><span class="line"><span class="comment">     * zero or less indicates no timeout. </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If &#123;<span class="doctag">@link</span> #setTimeout&#125; is not called, then the container's</span></span><br><span class="line"><span class="comment">     * default timeout, which is available via a call to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #getTimeout&#125;, will apply.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout the timeout in milliseconds</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeout</span><span class="params">(<span class="keyword">long</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the timeout (in milliseconds) for this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method returns the container's default timeout for</span></span><br><span class="line"><span class="comment">     * asynchronous operations, or the timeout value passed to the most</span></span><br><span class="line"><span class="comment">     * recent invocation of &#123;<span class="doctag">@link</span> #setTimeout&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;A timeout value of zero or less indicates no timeout.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the timeout in milliseconds</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeout</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>比较简单，通过看代码中的注释就能知其大意了，异步就是不等待结果立即返回，这里start一般用新线程的方式，线程运行完后(#complete)，需要通知（#addListener）,以及超时检测处理（#setTimeout,由容器Tomcat来设置）
</code></pre><h6><span id="213-asynclistener监听器">2.1.3 AsyncListener监听器</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.EventListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Listener that will be notified in the event that an asynchronous</span></span><br><span class="line"><span class="comment"> * operation initiated on a ServletRequest to which the listener had been </span></span><br><span class="line"><span class="comment"> * added has completed, timed out, or resulted in an error.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncListener</span> <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation</span></span><br><span class="line"><span class="comment">     * has been completed.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that has been completed may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has been completed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation</span></span><br><span class="line"><span class="comment">     * has timed out.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that has timed out may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has timed out</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeout</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation </span></span><br><span class="line"><span class="comment">     * has failed to complete.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that failed to complete may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has failed to complete</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that a new asynchronous cycle is being</span></span><br><span class="line"><span class="comment">     * initiated via a call to one of the &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125;</span></span><br><span class="line"><span class="comment">     * methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that is being reinitialized may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This AsyncListener will not receive any events related to the</span></span><br><span class="line"><span class="comment">     * new asynchronous cycle unless it registers itself (via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener&#125;) with the AsyncContext that</span></span><br><span class="line"><span class="comment">     * is delivered as part of the given AsyncEvent.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that a new asynchronous</span></span><br><span class="line"><span class="comment">     * cycle is being initiated</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartAsync</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;     </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    监听器主要有4个事件，开始、完成、超时、错误。</p>
<h5><span id="22-springmvc中的相关组件">2.2 SpringMVC中的相关组件</span></h5><p>​    SpringMVC中异步请求相关组件 AsyncWebRequest、WebAsyncManager、WebAsyncUtils    </p>
<h6><span id="221-asyncwebrequest">2.2.1 AsyncWebRequest</span></h6><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fydgk0syd0j30u019f7aj.jpg" alt="image-20181220195645682"></p>
<p>其实现有两个，其中<code>NoSupportAsyncWebRequest</code>不支持异步，所以我们只需要关注<code>StandarServletAsyncWebRequest</code>即可。（可以看到其实主要是对Servelt中支持异步的类的一些特性进行整合）</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fydgqk142nj31bm0pawie.jpg" alt="image-20181220200306736"></p>
<blockquote>
<p>具体细节看StandarServletAsyncWebRequest的实现</p>
</blockquote>
<h6><span id="222-webasyncmanager">2.2.2 WebAsyncManager</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.context.request.async;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.AsyncTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.SimpleAsyncTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult.DeferredResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.UrlPathHelper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The central class for managing asynchronous request processing, mainly intended</span></span><br><span class="line"><span class="comment"> * as an SPI and not typically used directly by application classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An async scenario starts with request processing as usual in a thread (T1).</span></span><br><span class="line"><span class="comment"> * Concurrent request handling can be initiated by calling</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...) startCallableProcessing&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #startDeferredResultProcessing(DeferredResult, Object...) startDeferredResultProcessing&#125;,</span></span><br><span class="line"><span class="comment"> * both of which produce a result in a separate thread (T2). The result is saved</span></span><br><span class="line"><span class="comment"> * and the request dispatched to the container, to resume processing with the saved</span></span><br><span class="line"><span class="comment"> * result in a third thread (T3). Within the dispatched thread (T3), the saved</span></span><br><span class="line"><span class="comment"> * result can be accessed via &#123;<span class="doctag">@link</span> #getConcurrentResult()&#125; or its presence</span></span><br><span class="line"><span class="comment"> * detected via &#123;<span class="doctag">@link</span> #hasConcurrentResult()&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.context.request.AsyncWebRequestInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.AsyncHandlerInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.filter.OncePerRequestFilter#shouldNotFilterAsyncDispatch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.filter.OncePerRequestFilter#isAsyncDispatch</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAsyncManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object RESULT_NONE = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(WebAsyncManager.class);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UrlPathHelper urlPathHelper = <span class="keyword">new</span> UrlPathHelper();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CallableProcessingInterceptor timeoutCallableInterceptor =</span><br><span class="line">         <span class="keyword">new</span> TimeoutCallableProcessingInterceptor();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DeferredResultProcessingInterceptor timeoutDeferredResultInterceptor =</span><br><span class="line">         <span class="keyword">new</span> TimeoutDeferredResultProcessingInterceptor();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> AsyncWebRequest asyncWebRequest;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> AsyncTaskExecutor taskExecutor = <span class="keyword">new</span> SimpleAsyncTaskExecutor(<span class="keyword">this</span>.getClass().getSimpleName());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Object concurrentResult = RESULT_NONE;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Object[] concurrentResultContext;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, CallableProcessingInterceptor&gt; callableInterceptors =</span><br><span class="line">         <span class="keyword">new</span> LinkedHashMap&lt;Object, CallableProcessingInterceptor&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, DeferredResultProcessingInterceptor&gt; deferredResultInterceptors =</span><br><span class="line">         <span class="keyword">new</span> LinkedHashMap&lt;Object, DeferredResultProcessingInterceptor&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Package private constructor.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> WebAsyncUtils#getAsyncManager(javax.servlet.ServletRequest)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> WebAsyncUtils#getAsyncManager(org.springframework.web.context.request.WebRequest)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   WebAsyncManager() &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Configure the &#123;<span class="doctag">@link</span> AsyncWebRequest&#125; to use. This property may be set</span></span><br><span class="line"><span class="comment">    * more than once during a single request to accurately reflect the current</span></span><br><span class="line"><span class="comment">    * state of the request (e.g. following a forward, request/response</span></span><br><span class="line"><span class="comment">    * wrapping, etc). However, it should not be set while concurrent handling</span></span><br><span class="line"><span class="comment">    * is in progress, i.e. while &#123;<span class="doctag">@link</span> #isConcurrentHandlingStarted()&#125; is</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> asyncWebRequest the web request to use</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsyncWebRequest</span><span class="params">(<span class="keyword">final</span> AsyncWebRequest asyncWebRequest)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(asyncWebRequest, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line">      Assert.state(!isConcurrentHandlingStarted(), <span class="string">"Can't set AsyncWebRequest with concurrent handling in progress"</span>);</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest = asyncWebRequest;</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            asyncWebRequest.removeAttribute(WebAsyncUtils.WEB_ASYNC_MANAGER_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Configure an AsyncTaskExecutor for use with concurrent processing via</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...)&#125;.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;By default a &#123;<span class="doctag">@link</span> SimpleAsyncTaskExecutor&#125; instance is used.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskExecutor</span><span class="params">(AsyncTaskExecutor taskExecutor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor = taskExecutor;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether the selected handler for the current request chose to handle the</span></span><br><span class="line"><span class="comment">    * request asynchronously. A return value of "true" indicates concurrent</span></span><br><span class="line"><span class="comment">    * handling is under way and the response will remain open. A return value</span></span><br><span class="line"><span class="comment">    * of "false" means concurrent handling was either not started or possibly</span></span><br><span class="line"><span class="comment">    * that it has completed and the request was dispatched for further</span></span><br><span class="line"><span class="comment">    * processing of the concurrent result.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConcurrentHandlingStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ((<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>) &amp;&amp; <span class="keyword">this</span>.asyncWebRequest.isAsyncStarted());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether a result value exists as a result of concurrent handling.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">this</span>.concurrentResult != RESULT_NONE);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides access to the result from concurrent handling.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> an Object, possibly an &#123;<span class="doctag">@code</span> Exception&#125; or &#123;<span class="doctag">@code</span> Throwable&#125; if</span></span><br><span class="line"><span class="comment">    * concurrent handling raised one.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #clearConcurrentResult()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.concurrentResult;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides access to additional processing context saved at the start of</span></span><br><span class="line"><span class="comment">    * concurrent handling.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #clearConcurrentResult()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> Object[] getConcurrentResultContext() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.concurrentResultContext;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; registered under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the interceptor registered under that key or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CallableProcessingInterceptor <span class="title">getCallableInterceptor</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.callableInterceptors.get(key);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; registered under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the interceptor registered under that key or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DeferredResultProcessingInterceptor <span class="title">getDeferredResultInterceptor</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.deferredResultInterceptors.get(key);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptor the interceptor to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallableInterceptor</span><span class="params">(Object key, CallableProcessingInterceptor interceptor)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(key, <span class="string">"Key is required"</span>);</span><br><span class="line">      Assert.notNull(interceptor, <span class="string">"CallableProcessingInterceptor  is required"</span>);</span><br><span class="line">      <span class="keyword">this</span>.callableInterceptors.put(key, interceptor);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; without a key.</span></span><br><span class="line"><span class="comment">    * The key is derived from the class name and hashcode.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptors one or more interceptors to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallableInterceptors</span><span class="params">(CallableProcessingInterceptor... interceptors)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(interceptors, <span class="string">"A CallableProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">for</span> (CallableProcessingInterceptor interceptor : interceptors) &#123;</span><br><span class="line">         String key = interceptor.getClass().getName() + <span class="string">":"</span> + interceptor.hashCode();</span><br><span class="line">         <span class="keyword">this</span>.callableInterceptors.put(key, interceptor);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptor the interceptor to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDeferredResultInterceptor</span><span class="params">(Object key, DeferredResultProcessingInterceptor interceptor)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(key, <span class="string">"Key is required"</span>);</span><br><span class="line">      Assert.notNull(interceptor, <span class="string">"DeferredResultProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">this</span>.deferredResultInterceptors.put(key, interceptor);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; without a key.</span></span><br><span class="line"><span class="comment">    * The key is derived from the class name and hashcode.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptors one or more interceptors to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDeferredResultInterceptors</span><span class="params">(DeferredResultProcessingInterceptor... interceptors)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(interceptors, <span class="string">"A DeferredResultProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">for</span> (DeferredResultProcessingInterceptor interceptor : interceptors) &#123;</span><br><span class="line">         String key = interceptors.getClass().getName() + <span class="string">":"</span> + interceptors.hashCode();</span><br><span class="line">         <span class="keyword">this</span>.deferredResultInterceptors.put(key, interceptor);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Clear &#123;<span class="doctag">@linkplain</span> #getConcurrentResult() concurrentResult&#125; and</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@linkplain</span> #getConcurrentResultContext() concurrentResultContext&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.concurrentResult = RESULT_NONE;</span><br><span class="line">      <span class="keyword">this</span>.concurrentResultContext = <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Start concurrent request processing and execute the given task with an</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #setTaskExecutor(AsyncTaskExecutor) AsyncTaskExecutor&#125;. The result</span></span><br><span class="line"><span class="comment">    * from the task execution is saved and the request dispatched in order to</span></span><br><span class="line"><span class="comment">    * resume processing of that result. If the task raises an Exception then</span></span><br><span class="line"><span class="comment">    * the saved result will be the raised Exception.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> callable a unit of work to be executed asynchronously</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResult()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResultContext()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> &#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> Callable&lt;?&gt; callable, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Assert.notNull(callable, <span class="string">"Callable must not be null"</span>);</span><br><span class="line">      startCallableProcessing(<span class="keyword">new</span> WebAsyncTask(callable), processingContext);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Use the given &#123;<span class="doctag">@link</span> WebAsyncTask&#125; to configure the task executor as well as</span></span><br><span class="line"><span class="comment">    * the timeout value of the &#123;<span class="doctag">@code</span> AsyncWebRequest&#125; before delegating to</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> webAsyncTask a WebAsyncTask containing the target &#123;<span class="doctag">@code</span> Callable&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Assert.notNull(webAsyncTask, <span class="string">"WebAsyncTask must not be null"</span>);</span><br><span class="line">      Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">      Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">      <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">      <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.taskExecutor = executor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;CallableProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">      interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">      interceptors.addAll(<span class="keyword">this</span>.callableInterceptors.values());</span><br><span class="line">      interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">      <span class="keyword">final</span> CallableInterceptorChain interceptorChain = <span class="keyword">new</span> CallableInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            logger.debug(<span class="string">"Processing timeout"</span>);</span><br><span class="line">            Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">            <span class="keyword">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">               setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      interceptorChain.applyBeforeConcurrentHandling(asyncWebRequest, callable);</span><br><span class="line"></span><br><span class="line">      startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.taskExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Object result = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">               result = callable.call();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               result = t;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">               result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">            &#125;</span><br><span class="line">            setConcurrentResultAndDispatch(result);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setConcurrentResultAndDispatch</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (WebAsyncManager.<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (hasConcurrentResult()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         concurrentResult = result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (asyncWebRequest.isAsyncComplete()) &#123;</span><br><span class="line">         logger.error(<span class="string">"Could not complete async processing due to timeout or network error"</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      logger.debug(<span class="string">"Concurrent result value ["</span> + concurrentResult + <span class="string">"]"</span>);</span><br><span class="line">      logger.debug(<span class="string">"Dispatching request to resume processing"</span>);</span><br><span class="line"></span><br><span class="line">      asyncWebRequest.dispatch();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Start concurrent request processing and initialize the given</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> DeferredResult&#125; with a &#123;<span class="doctag">@link</span> DeferredResultHandler&#125; that saves</span></span><br><span class="line"><span class="comment">    * the result and dispatches the request to resume processing of that</span></span><br><span class="line"><span class="comment">    * result. The &#123;<span class="doctag">@code</span> AsyncWebRequest&#125; is also updated with a completion</span></span><br><span class="line"><span class="comment">    * handler that expires the &#123;<span class="doctag">@code</span> DeferredResult&#125; and a timeout handler</span></span><br><span class="line"><span class="comment">    * assuming the &#123;<span class="doctag">@code</span> DeferredResult&#125; has a default timeout result.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> deferredResult the DeferredResult instance to initialize</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResult()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResultContext()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDeferredResultProcessing</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">final</span> DeferredResult&lt;?&gt; deferredResult, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      Assert.notNull(deferredResult, <span class="string">"DeferredResult must not be null"</span>);</span><br><span class="line">      Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">      Long timeout = deferredResult.getTimeoutValue();</span><br><span class="line">      <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;DeferredResultProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;DeferredResultProcessingInterceptor&gt;();</span><br><span class="line">      interceptors.add(deferredResult.getInterceptor());</span><br><span class="line">      interceptors.addAll(<span class="keyword">this</span>.deferredResultInterceptors.values());</span><br><span class="line">      interceptors.add(timeoutDeferredResultInterceptor);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> DeferredResultInterceptorChain interceptorChain = <span class="keyword">new</span> DeferredResultInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               interceptorChain.triggerAfterTimeout(asyncWebRequest, deferredResult);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               setConcurrentResultAndDispatch(t);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, deferredResult);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      interceptorChain.applyBeforeConcurrentHandling(asyncWebRequest, deferredResult);</span><br><span class="line"></span><br><span class="line">      startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         interceptorChain.applyPreProcess(<span class="keyword">this</span>.asyncWebRequest, deferredResult);</span><br><span class="line">         deferredResult.setResultHandler(<span class="keyword">new</span> DeferredResultHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">               result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class="line">               setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         setConcurrentResultAndDispatch(t);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAsyncProcessing</span><span class="params">(Object[] processingContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      clearConcurrentResult();</span><br><span class="line">      <span class="keyword">this</span>.concurrentResultContext = processingContext;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.startAsync();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         HttpServletRequest request = <span class="keyword">this</span>.asyncWebRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">         String requestUri = urlPathHelper.getRequestUri(request);</span><br><span class="line">         logger.debug(<span class="string">"Concurrent handling starting for "</span> + request.getMethod() + <span class="string">" ["</span> + requestUri + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    类中有两个重要的方法#startCallableProcessing（用于处理Callable和WebAsyncTask类型），#startDeferredResultProcessing（用于处理DeferredResult和ListenableFuture类型）,是启动异步处理的入口方法，它们一共做了三件事</p>
<ul>
<li>启动异步处理</li>
<li>给Request设置相应属性（timeout、timeoutHandler和completionHandler）</li>
<li>在相应的位置调用相应的拦截器（CallableProcessingInterceptor和DeferredResultProcessingInterceptor都封装在相应的Chain中）</li>
</ul>
<blockquote>
<p>更多细节 可查看startCallableProcessing的执行过程</p>
</blockquote>
<h6><span id="223-webasyncutils">2.2.3 WebAsyncUtils</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.context.request.async;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.WebRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Utility methods related to processing asynchronous web requests.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAsyncUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_ASYNC_MANAGER_ATTRIBUTE = WebAsyncManager.class.getName() + <span class="string">".WEB_ASYNC_MANAGER"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;?&gt; standardAsyncRequestConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Obtain the &#123;<span class="doctag">@link</span> WebAsyncManager&#125; for the current request, or if not</span></span><br><span class="line"><span class="comment">    * found, create and associate it with the request.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebAsyncManager <span class="title">getAsyncManager</span><span class="params">(ServletRequest servletRequest)</span> </span>&#123;</span><br><span class="line">      WebAsyncManager asyncManager = (WebAsyncManager) servletRequest.getAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">         asyncManager = <span class="keyword">new</span> WebAsyncManager();</span><br><span class="line">         servletRequest.setAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, asyncManager);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> asyncManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Obtain the &#123;<span class="doctag">@link</span> WebAsyncManager&#125; for the current request, or if not</span></span><br><span class="line"><span class="comment">    * found, create and associate it with the request.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebAsyncManager <span class="title">getAsyncManager</span><span class="params">(WebRequest webRequest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> scope = RequestAttributes.SCOPE_REQUEST;</span><br><span class="line">      WebAsyncManager asyncManager = (WebAsyncManager) webRequest.getAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, scope);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">         asyncManager = <span class="keyword">new</span> WebAsyncManager();</span><br><span class="line">         webRequest.setAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, asyncManager, scope);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> asyncManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Create an AsyncWebRequest instance. By default an instance of</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> StandardServletAsyncWebRequest&#125; is created if running in Servlet</span></span><br><span class="line"><span class="comment">    * 3.0 (or higher) environment or as a fallback, an instance of</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> NoSupportAsyncWebRequest&#125; is returned.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> an AsyncWebRequest instance, never &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsyncWebRequest <span class="title">createAsyncWebRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ClassUtils.hasMethod(ServletRequest.class, <span class="string">"startAsync"</span>) ?</span><br><span class="line">            createStandardServletAsyncWebRequest(request, response) : <span class="keyword">new</span> NoSupportAsyncWebRequest(request, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AsyncWebRequest <span class="title">createStandardServletAsyncWebRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (standardAsyncRequestConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String className = <span class="string">"org.springframework.web.context.request.async.StandardServletAsyncWebRequest"</span>;</span><br><span class="line">            Class&lt;?&gt; clazz = ClassUtils.forName(className, WebAsyncUtils.class.getClassLoader());</span><br><span class="line">            standardAsyncRequestConstructor = clazz.getConstructor(HttpServletRequest.class, HttpServletResponse.class);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> (AsyncWebRequest) BeanUtils.instantiateClass(standardAsyncRequestConstructor, request, response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to instantiate StandardServletAsyncWebRequest"</span>, t);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    可以看到这个类主要是提供WebAsyncManage、AsyncWebRequest 相关的操作</p>
<h5><span id="23-springmvc中请求的支持">2.3 SpringMVC中请求的支持</span></h5><ol>
<li><p><code>FrameworkServlet</code>中添加了<code>RequestBindingInterceptor</code></p>
</li>
<li><p><code>RequestMappingHandlerAdapter</code>的<code>#invokeHandlerMethod</code> 提供了对异步请求的核心支持</p>
<p> ​    2.1 创建<code>AsyncWebRequest</code>并设置超时时间</p>
<p> ​    2.2 对当前请求<code>WebAsyncManager</code>设置了属性<code>（taskExecutor、asyncWebRequest、callabltinterceptors和deferredResultInterceptors）</code></p>
<p> ​    2.3 并判断是否有结果，如果有对结果进行处理。<code>requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</code></p>
<p> ​    2.4 然后执行方法 <code>requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</code></p>
</li>
<li><p>返回值处理器，<code>AsyncTaskMethodReturnValueHandler</code> <code>CallableMethodReturnValueHandler</code> <code>DeferredResultMethodReturnValueHandler</code> <code>ListenableFutureReturnValueHandler</code></p>
</li>
<li><p><code>DispatcherServlet</code>的<code>#doDispatcher</code>，如果是异步直接返回。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</span></span><br><span class="line"><span class="comment"> * if view resolution is required.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">invokeHandleMethod</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">   ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</span><br><span class="line"></span><br><span class="line">   WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">   ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">   ServletInvocableHandlerMethod requestMappingMethod = createRequestMappingMethod(handlerMethod, binderFactory);</span><br><span class="line"></span><br><span class="line">   ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</span><br><span class="line">   mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">   modelFactory.initModel(webRequest, mavContainer, requestMappingMethod);</span><br><span class="line">   mavContainer.setIgnoreDefaultModelOnRedirect(<span class="keyword">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line"></span><br><span class="line">   AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">   asyncWebRequest.setTimeout(<span class="keyword">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">   asyncManager.setTaskExecutor(<span class="keyword">this</span>.taskExecutor);</span><br><span class="line">   asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">   asyncManager.registerCallableInterceptors(<span class="keyword">this</span>.callableInterceptors);</span><br><span class="line">   asyncManager.registerDeferredResultInterceptors(<span class="keyword">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">      Object result = asyncManager.getConcurrentResult();</span><br><span class="line">      mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">      asyncManager.clearConcurrentResult();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5><span id="24-springwebflux-待补充">2.4 SpringWebFlux  ==待补充==</span></h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/03/servlet-springmvc/" data-id="cjtjoe4iq000uv49ca3q01hiz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/servlet/">servlet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-mvc/">spring-mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-webflux/">spring-webflux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-servlet-tomcat" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/03/servlet-tomcat/" class="article-date">
  <time datetime="2019-02-03T07:49:08.000Z" itemprop="datePublished">2019-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/03/servlet-tomcat/">servlet_tomcat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#servlet容器-tomcat">servlet容器 Tomcat</a><ul>
<li><a href="#1-tomcat的顶层结构">1 Tomcat的顶层结构</a></li>
<li><a href="#2-tomcat的启动过程">2 Tomcat的启动过程</a><ul>
<li><a href="#21catalina的启动过程">2.1Catalina的启动过程</a></li>
<li><a href="#22-server的启动过程">2.2 Server的启动过程</a></li>
<li><a href="#23-service的启动过程">2.3 Service的启动过程</a></li>
</ul>
</li>
<li><a href="#3-请求处理">3 请求处理</a><ul>
<li><a href="#31-connector的结构">3.1 Connector的结构</a></li>
<li><a href="#32-pipeline-value管道">3.2 Pipeline-Value管道</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<hr>
<h4><span id="servlet容器-tomcat">servlet容器 Tomcat</span></h4><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fztadjl1lbj31680mmtd6.jpg" alt="image-20190203155202660"></p>
<h5><span id="1-tomcat的顶层结构">1 Tomcat的顶层结构</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Catalina 管理整个Tomcat的管理类</span><br><span class="line"></span><br><span class="line">Server 最顶层容器，代表整个服务器</span><br><span class="line"></span><br><span class="line">	Service 提供具体服务 （多个）</span><br><span class="line"></span><br><span class="line">		Connector 负责网络连接、request/response的创建（可以有多个连接，从servet.xml的配置也可以看出，同时提供http和https，也可以提供相同协议不同端口的连接）</span><br><span class="line"></span><br><span class="line">		Container 具体处理Servlet</span><br></pre></td></tr></table></figure>
<h5><span id="2-tomcat的启动过程">2 Tomcat的启动过程</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`org.apache.catalina.startup.Bootstrap` 是Tomcat的入口，作用类似一个`CatalinaAdptor`，具体处理还是Catalina来完成，这样做的好处是可以把启动的入口和具体的管理类分开，从而可以很方便地创建出多种启动方式。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>BootStrap不在Tomcat依赖包下 ，而是在bin目录 通过反射 完全松耦合</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(Bootstrap.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Daemon object used by main.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Bootstrap daemon = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Daemon reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object catalinaDaemon = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    ClassLoader commonLoader = <span class="keyword">null</span>;</span><br><span class="line">    ClassLoader catalinaLoader = <span class="keyword">null</span>;</span><br><span class="line">    ClassLoader sharedLoader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClassLoaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            commonLoader = createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span>( commonLoader == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                <span class="comment">// no config file, default to this loader - we might be in a 'single' env.</span></span><br><span class="line">                commonLoader=<span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">            catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</span><br><span class="line">            sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            log.error(<span class="string">"Class loader creation threw exception"</span>, t);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String value = CatalinaProperties.getProperty(name + <span class="string">".loader"</span>);</span><br><span class="line">        <span class="keyword">if</span> ((value == <span class="keyword">null</span>) || (value.equals(<span class="string">""</span>)))</span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line"></span><br><span class="line">        value = replace(value);</span><br><span class="line"></span><br><span class="line">        List&lt;Repository&gt; repositories = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        String[] repositoryPaths = getPaths(value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</span><br><span class="line">            <span class="comment">// Check for a JAR URL repository</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">                URL url = <span class="keyword">new</span> URL(repository);</span><br><span class="line">                repositories.add(<span class="keyword">new</span> Repository(repository, RepositoryType.URL));</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Local repository</span></span><br><span class="line">            <span class="keyword">if</span> (repository.endsWith(<span class="string">"*.jar"</span>)) &#123;</span><br><span class="line">                repository = repository.substring</span><br><span class="line">                    (<span class="number">0</span>, repository.length() - <span class="string">"*.jar"</span>.length());</span><br><span class="line">                repositories.add(</span><br><span class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.GLOB));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">".jar"</span>)) &#123;</span><br><span class="line">                repositories.add(</span><br><span class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.JAR));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                repositories.add(</span><br><span class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.DIR));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialize daemon.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Fatal initialization error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        initClassLoaders();</span><br><span class="line"></span><br><span class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load our startup class and call its process() method</span></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">"Loading startup class"</span>);</span><br><span class="line">        Class&lt;?&gt; startupClass =</span><br><span class="line">            catalinaLoader.loadClass</span><br><span class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</span><br><span class="line">        Object startupInstance = startupClass.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the shared extensions class loader</span></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">"Setting startup class properties"</span>);</span><br><span class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</span><br><span class="line">        Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</span><br><span class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">        Method method =</span><br><span class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">        method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">        catalinaDaemon = startupInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Load daemon.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call the load() method</span></span><br><span class="line">        String methodName = <span class="string">"load"</span>;</span><br><span class="line">        Object param[];</span><br><span class="line">        Class&lt;?&gt; paramTypes[];</span><br><span class="line">        <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</span><br><span class="line">            paramTypes = <span class="keyword">null</span>;</span><br><span class="line">            param = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">            paramTypes[<span class="number">0</span>] = arguments.getClass();</span><br><span class="line">            param = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">            param[<span class="number">0</span>] = arguments;</span><br><span class="line">        &#125;</span><br><span class="line">        Method method =</span><br><span class="line">            catalinaDaemon.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">"Calling startup class "</span> + method);</span><br><span class="line">        method.invoke(catalinaDaemon, param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------------------------------------------------------- Main Program</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Load the Catalina daemon.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arguments Initialization arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Fatal initialization error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(String[] arguments)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">        load(arguments);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start the Catalina daemon.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Fatal start error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( catalinaDaemon==<span class="keyword">null</span> ) init();</span><br><span class="line"></span><br><span class="line">        Method method = catalinaDaemon.getClass().getMethod(<span class="string">"start"</span>, (Class [] )<span class="keyword">null</span>);</span><br><span class="line">        method.invoke(catalinaDaemon, (Object [])<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop the Catalina Daemon.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Fatal stop error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//实现略,主要通过反射调用了catalina的stop</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stop the standalone server.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Fatal stop error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//实现略,主要通过反射调用了catalina的stopServer</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set flag.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> await &lt;code&gt;true&lt;/code&gt; if the daemon should block</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Reflection error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAwait</span><span class="params">(<span class="keyword">boolean</span> await)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//实现略 ,主要通过反射调用了catalina的setAwait</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getAwait</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//实现略 ,主要通过反射调用了catalina的getAwait</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Destroy the Catalina Daemon.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// FIXME</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Main method and entry point when starting Tomcat via the provided</span></span><br><span class="line"><span class="comment">     * scripts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args Command line arguments to be processed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Don't set daemon until init() has completed</span></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bootstrap.init();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                handleThrowable(t);</span><br><span class="line">                t.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            daemon = bootstrap;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">            <span class="comment">// thread so make sure the correct class loader is used to prevent</span></span><br><span class="line">            <span class="comment">// a range of class not found exceptions.</span></span><br><span class="line">            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String command = <span class="string">"start"</span>;</span><br><span class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                command = args[args.length - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"start"</span>;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"stop"</span>;</span><br><span class="line">                daemon.stop();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">                daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"configtest"</span>)) &#123;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span>==daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">"Bootstrap: command \""</span> + command + <span class="string">"\" does not exist."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                    t.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                t = t.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tomcat 启动脚本 startup.bat 是从main方法中开始的。其中主要做了:</span><br></pre></td></tr></table></figure>
<ul>
<li><p>准备容器环境，<code>init()</code>初始化类加载器, </p>
</li>
<li><p>初始化容器，调用<code>load()</code> 实际是调用catalina里的<code>init()</code></p>
</li>
<li><p>启动容器，通过引用<code>catalinaDaemon</code> 反射射调用<code>start()</code>方法（实际还是通过catalina操作容器）</p>
<pre><code>关于类加载，我们都知道 J2EE 默认的类加载机制是双亲委派原则（详细查看如下🔎https://www.cnblogs.com/miduos/p/9250565.html）
</code></pre><p>  通过debug可以发现  commonLoader、catalinaLoader 、sharedLoader 其实三个是同一个（底层都是URLClassLoader），原因是因为<code>catalina.properties</code> 的配置中默认是空的。</p>
<p>  另外在<code>init()</code> 中 <code>Thread.currentThread().setContextClassLoader(catalinaLoader);</code> </p>
</li>
</ul>
<h6><span id="21catalina的启动过程">2.1Catalina的启动过程</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Catalina的启动主要是调用`setAwait()`、`load()`和`start()`方法来完成。</span><br></pre></td></tr></table></figure>
<ul>
<li><code>setAwait()</code> 方法用于设置Server启动完成后是否进入等待状态的标记</li>
<li><code>load()</code>方法主要是用来加载配置文件<code>conf/server.xml</code>创建Server对象 （解析是通过Digester），然后调用Server的<code>init()</code></li>
<li><code>start()</code> 主要是调用Server的 <code>start()</code></li>
</ul>
<h6><span id="22-server的启动过程">2.2 Server的启动过程</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server的默认实现`org.apache.catalina.core.StandardServer` ,在其父类中`org.apache.catalina.util.LifecycleBase` 中的`init() ` 实现如下</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZING, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        initInternal();</span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                sm.getString(<span class="string">"lifecycleBase.initFail"</span>,toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>start()</code> 实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            Exception e = <span class="keyword">new</span> LifecycleException();</span><br><span class="line">            log.debug(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</span><br><span class="line">        stop();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">            !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        setStateInternal(LifecycleState.STARTING_PREP, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        startInternal();</span><br><span class="line">        <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</span><br><span class="line">            <span class="comment">// This is a 'controlled' failure. The component put itself into the</span></span><br><span class="line">            <span class="comment">// FAILED state so call stop() to complete the clean-up.</span></span><br><span class="line">            stop();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;</span><br><span class="line">            <span class="comment">// Shouldn't be necessary but acts as a check that sub-classes are</span></span><br><span class="line">            <span class="comment">// doing what they are supposed to.</span></span><br><span class="line">            invalidTransition(Lifecycle.AFTER_START_EVENT);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setStateInternal(LifecycleState.STARTED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// This is an 'uncontrolled' failure so put the component into the</span></span><br><span class="line">        <span class="comment">// FAILED state and throw an exception.</span></span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"lifecycleBase.startFail"</span>, toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其中 `startInternal() 和 initInternal()` 为模版方法 ，查看其实现类 可以发现是循环调用了每个`service`的`start()`和`init()`</span><br></pre></td></tr></table></figure>
<h6><span id="23-service的启动过程">2.3 Service的启动过程</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">类似于Server , `StandardService`的`initInternal()`和 `startInternal()`的方法主要调用`container`、`executors`、`mapperListener`、`connectors`的`init()`和`start()`方法。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mapperListener是Mapper的监听器，可以监听container容器多变化</p>
<p>executors是用在connectors中管理线程的线程池，在server.xml配置文件中tomcatThreadPool</p>
</blockquote>
<p>下图为整个启动流程</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyasgs52ycj30wk0k6jxv.jpg" alt="image-20181218123224591"></p>
<h5><span id="3-请求处理">3 请求处理</span></h5><p>​        Connector用于接收请求并将请求封装成<code>Request</code>和<code>Response</code>来处理，最底层是使用Socket来进行连接的，封装完后交给Container进行处理（通过pipeline-Value管道来处理），Container处理完之后返回给Connector，最后Connector使用Socket将处理结果返回给客户端，整个请求就处理完了。</p>
<h6><span id="31-connector的结构">3.1 Connector的结构</span></h6><p>​    <code>Connector</code>中具体是用<code>ProtocolHandler</code>来处理请求的，有多种不同的连接类型（Ajp、HTTP和Spdy）。</p>
<p>其中有3个非常重要的组件。（<code>Connector</code>的创建过程主要是初始化<code>ProtocolHandler</code>,serverx.xml中可配置）</p>
<ul>
<li>Endpoint  用于处理底层的Socket的网络连接，用来实现TCP/IP协议</li>
<li>Processor  用于将Endpoint接收到的Socket封装成Request，用来实现HTTP协议(BIO、NIO、APR)</li>
<li>Adapter 用于将封装好的Request交给Container进行具体处理，将适配到Servlet容器（转换<code>org.apache.coyote.Request</code>为<code>org.apache.catalina.connector.Request</code> ）</li>
</ul>
<blockquote>
<p>Ajp ：连接器监听8009端口，负责和其他的HTTP服务器建立连接。在把Tomcat与其他HTTP服务器集成时，就需要用到这个连接器。</p>
<p>Apr : 是从操作系统级别解决异步IO问题，大幅度提高服务器的并发处理性能 <a href="http://tomcat.apache.org/tomcat-8.5-doc/apr.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-8.5-doc/apr.html</a></p>
<p>协议升级：在servlet 3.1之后新增 WebSocket协议，如果Processor处理之后Socket的状态是UPGRADING,则EndPoint中的handler回接着创建并调用upgrade包中的processor进行处理</p>
<p>request转换：Adapter转换后的request，其实就是封装了一层，  <code>public class Request implements org.apache.catalina.servlet4preview.http.HttpServletRequest</code></p>
</blockquote>
<h6><span id="32-pipeline-value管道">3.2 Pipeline-Value管道</span></h6><p>​    Piepeline的管道模型和普通的责任链模式稍微有点不同，区别主要如下</p>
<ul>
<li>每个pipeline都有特定的value，而且是在管道的最后一个执行，这个Value叫做BaseValue</li>
<li>上层的BaseValue（类似配货车到中转站的感觉）会调用下层容器的管道</li>
</ul>
<blockquote>
<p>每个BaseValue都有一个StandarValue的实现，例如WrapperValue的标准实现是StanderWrpperValue</p>
</blockquote>
<p>​    经过所有管道（EnginePipeline、HostPipeline、ContextPipeline、WrapperPieline）后，在最后的WrapperPieline的BaseValue中会创建<code>FilterChain</code>并调用其doFilter来处理请求，FilterChain包含着我们配置的与请求相匹配的<code>Filter</code>和<code>Servlet</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/03/servlet-tomcat/" data-id="cjtjoe4ic000mv49c4jr6dld5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/servlet/">servlet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tomcat/">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java-all" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/02/java-all/" class="article-date">
  <time datetime="2019-02-02T12:43:14.000Z" itemprop="datePublished">2019-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/02/java-all/">java_all</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2><span id="知识体系总结">知识体系总结</span></h2><hr>
<!-- toc -->
<ul>
<li><a href="#基础">基础</a><ul>
<li><a href="#英语">英语</a></li>
<li><a href="#linux-计算机基础-原理">linux / 计算机基础、原理</a></li>
<li><a href="#网络编程-tcpip协议-http">网络编程 tcp/ip协议  http</a></li>
<li><a href="#数据结构和算法">数据结构和算法</a></li>
<li><a href="#数据库mysql">数据库MySQL</a></li>
</ul>
</li>
<li><a href="#java-sejava-standard-edition">Java SE（Java Standard Edition）</a><ul>
<li><a href="#java语言语法基础">Java语言/语法基础</a></li>
<li><a href="#集合框架">集合框架</a></li>
<li><a href="#java-io网络">Java IO/网络</a></li>
<li><a href="#多线程">多线程</a></li>
<li><a href="#jvm">JVM</a></li>
<li><a href="#版本特征-待整理">版本特征 ==待整理==</a></li>
<li><a href="#其他">其他</a><ul>
<li><a href="#classloder">classLoder</a></li>
<li><a href="#java官方订阅">java官方订阅</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#java-eeenterprise-edition">Java EE（Enterprise Edition）</a><ul>
<li><a href="#spring-spring-boot">Spring /Spring boot</a></li>
<li><a href="#其他-1">其他</a><ul>
<li><a href="#web-framework框架性能">web Framework框架性能</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#重视规范">重视规范</a><ul>
<li><a href="#jvm规范">JVM规范</a></li>
<li><a href="#jsr规范">JSR规范</a></li>
<li><a href="#ietf规范">IETF规范</a></li>
<li><a href="#消息规范">消息规范</a></li>
<li><a href="#关系型数据库规范">关系型数据库规范</a></li>
<li><a href="#reactive-规范">Reactive 规范</a></li>
</ul>
</li>
<li><a href="#高效优雅">高效/优雅</a></li>
<li><a href="#框架中间件">框架/中间件</a><ul>
<li><a href="#web栈">Web栈</a></li>
<li><a href="#关系型数据库">关系型数据库</a></li>
<li><a href="#nosql">NoSQL</a></li>
<li><a href="#rpc">RPC</a></li>
<li><a href="#任务调度">任务调度</a></li>
<li><a href="#消息服务">消息服务</a></li>
<li><a href="#客户端">客户端</a></li>
<li><a href="#web容器">Web容器</a></li>
</ul>
</li>
<li><a href="#微服务演变">微服务演变</a><ul>
<li><a href="#服务调用">服务调用</a></li>
<li><a href="#分布式配置">分布式配置</a></li>
<li><a href="#服务注册发现">服务注册/发现</a></li>
<li><a href="#路由负载均衡">路由/负载均衡</a></li>
<li><a href="#熔断限流">熔断/限流</a></li>
<li><a href="#网关">网关</a></li>
<li><a href="#其他-2">其他</a></li>
<li><a href="#spring-cloud-侵入式">Spring Cloud （侵入式）</a></li>
<li><a href="#service-mesh-非侵入式">Service Mesh （非侵入式）</a></li>
</ul>
</li>
<li><a href="#大数据生态">大数据生态</a></li>
<li><a href="#其他-3">其他</a><ul>
<li><a href="#开阔视野">开阔视野</a></li>
<li><a href="#性能压力测试调优">性能/压力测试/调优</a></li>
<li><a href="#前端基础">前端基础</a></li>
<li><a href="#态度">态度</a></li>
<li><a href="#学习方法">学习方法</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<p>[TOC]</p>
<hr>
<h4><span id="基础">基础</span></h4><h5><span id="英语">英语</span></h5><p>​    了解一手资料，官方文档，github资料 </p>
<p>​    书籍📚《程序员英语》 </p>
<h5><span id="linux-计算机基础-原理">linux / 计算机基础、原理</span></h5><p>​    linux常用命令，问题定位需要知道 </p>
<p>​    计算机原理这里，基于冯诺伊曼模型建造的计算机分为4个子系统：存储器、算术逻辑单元、控制单元、和输入/输出单元</p>
<p>​    书籍📚《linux鸟哥私房菜》、《计算机原理》、《深入理解计算机原理》、《程序是怎么跑起来的》</p>
<h5><span id="网络编程-tcpip协议-http">网络编程 tcp/ip协议  http</span></h5><p>​    TPC/IP协议是传输层协议，主要解决数据如何在网络中传输，而HTTP是应用层协议，主要解决如何包装数据，IP想像成一种高速公路，TCP和UDP是高速公路上的“卡车”，它们携带的货物就是像HTTP，HTTP协议即超文本传送协议(Hypertext Transfer Protocol )</p>
<p>​    书籍📚《http权威指南》、《tcp/ip详解》、《图解http》、《网络是怎么链接的》</p>
<h5><span id="数据结构和算法">数据结构和算法</span></h5><p>​    数据结构和算法，常见的排序类型，知道时间复杂度，空间复杂度等概念，==实现方面可以看jdk的集合类==</p>
<p>​    书籍📚 《算法》</p>
<h5><span id="数据库mysql">数据库MySQL</span></h5><p>​    关系型数据库，事务隔离级别、对应解决的问题，懂的索引（b+ tree 以及相关优化）、锁（MVCC实现相关、 间隙锁），调优，定位问题</p>
<p>​    书籍📚 《高性能MySQL》</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql分析。—-》https://mp.weixin.qq.com/s/213sPk-0RtWwwX6YotN6eQ</span><br><span class="line">原因</span><br><span class="line">1.硬件问题。如网络速度慢，内存不足，I/O吞吐量小，磁盘空间满了等。</span><br><span class="line"></span><br><span class="line">2.没有索引或者索引失效。（一般在互联网公司，DBA会在半夜把表锁了，重新建立一遍索引，因为当你删除某个数据的时候，索引的树结构就不完整了。所以互联网公司的数据做的是假删除.一是为了做数据分析,二是为了不破坏索引 ）</span><br><span class="line"></span><br><span class="line">3.数据过多（分库分表）</span><br><span class="line"></span><br><span class="line">4.服务器调优及各个参数设置（调整my.cnf</span><br><span class="line">切入点</span><br><span class="line">1.先观察，开启慢查询日志，设置相应的阈值（比如超过3秒就是慢SQL），在生产环境跑上个一天过后，看看哪些SQL比较慢。</span><br><span class="line"></span><br><span class="line">2.Explain和慢SQL分析。比如SQL语句写的烂，索引没有或失效，关联查询太多（有时候是设计缺陷或者不得以的需求）等等。</span><br><span class="line"></span><br><span class="line">3.Show Profile是比Explain更近一步的执行细节，可以查询到执行每一个SQL都干了什么事，这些事分别花了多少秒。</span><br><span class="line"></span><br><span class="line">4.找DBA或者运维对MySQL进行服务器的参数调优。</span><br></pre></td></tr></table></figure>
<h4><span id="java-sejava-standard-edition">Java SE（Java Standard Edition）</span></h4><h5><span id="java语言语法基础">Java语言/语法基础</span></h5><p>​    对象：封装性、派生性、多态性</p>
<p>​    切面： Java动态代理 字节码提升</p>
<p>​    元编程 ：泛型、 反射、 注解</p>
<p>​    函数编程：函数式编程、Stream API设计</p>
<p>​    书籍📚 《Thinking in java》 《core Java》 《SCJP考试指南》《java8函数式编程》</p>
<p>​    文档 官方指导文档：<a href="https://docs.oracle.com/javase/tutorial/index.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/tutorial/index.html</a></p>
<h5><span id="集合框架">集合框架</span></h5><p>​    Java Collections Framework Java Collections主要包括以下三部分：接口（Interface）、实现（Implemention）和算法（Algorithm）</p>
<h5><span id="java-io网络">Java IO/网络</span></h5><p>​     文件流、 java网络编程  、阻塞IO、非阻塞IO</p>
<p>​    书籍📚《NIO与Socket》、《Netty权威指南》、《Netty实战》</p>
<p>​    可以沿着这个路线深入学习，socket -&gt; Netty  -&gt; dubbo </p>
<p>​    Socket是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口。在设计模式中，Socket其实就是一个门面模式，它把复杂的TCP/IP协议族隐藏在Socket接口后面，对用户来说，一组简单的接口就是全部，让Socket去组织数据，以符合指定的协议。Socket 只是个接口不是协议</p>
<p>​    netty资料：==待整理==</p>
<p><a href="https://mp.weixin.qq.com/s/nVqjSbocs4kFFz2pJqovhQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/nVqjSbocs4kFFz2pJqovhQ</a><br><a href="https://mp.weixin.qq.com/s/WBV4Tm-I5VNWXqjxMgw0yw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/WBV4Tm-I5VNWXqjxMgw0yw</a><br><a href="https://www.jianshu.com/p/cde27461c226" target="_blank" rel="noopener">https://www.jianshu.com/p/cde27461c226</a><br><a href="https://mp.weixin.qq.com/s/zf_LY0MSD4S4p0wXKOyhZg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/zf_LY0MSD4S4p0wXKOyhZg</a></p>
<h5><span id="多线程">多线程</span></h5><p>​    ==J.U.C== ，多线程的整个体系基于volatile 、cas -&gt;aqs，通常需要了解的 JMM内存模型、锁、线程池、工具类 </p>
<p>​    书籍📚《Java并发编程艺术》 、《并发编程实践》 翻译不太好，建议看英文版、《Concurrent_Programming_in_Java》并发框架的作者DougLea写的</p>
<h5><span id="jvm">JVM</span></h5><p>​    调优，问题定位，常用的工具，jstack 等，字节码、编译过程、垃圾收集器、即时编译等、虚拟机规范</p>
<p>​    书籍📚《深入理解 Java 虚拟机》</p>
<h5><span id="版本特征-待整理">版本特征 ==待整理==</span></h5><p>​    JDK发展史：从几个角度看 jvm特性、并发工具、语言特性 ，例如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">JDK1.0版本：JAVA 虚拟机、AWT</span><br><span class="line">JDK1.1版本:JAR文件格式、JDBC、JavaBeans、RMI、Java语法：内部类（Inner Class）和反射（Reflection）</span><br><span class="line">JDK1.2版本:Java技术体系拆分为3个方向（面向桌面应用开发J2SE/面向企业级开发的J2EE/面向手机等移动端开发的J2ME）</span><br><span class="line">      代表性技术：EJB、Java plugin-in、JavaIDL、Swing</span><br><span class="line">      虚拟机中内置了JIT(JUST IN TIME)编译器、3个虚拟机并存（Classic VM /HotSpot VM/Exact VM）</span><br><span class="line">      语言和API级别上：添加了strictfp关键字与Collections集合类</span><br><span class="line">JDK1.3版本:一些类库（数学运算和新的Timer API）/JNDI服务作为平台级服务提供、使用CORBA IIOP来实现RMI通信/添加了JavaSound类库</span><br><span class="line">JDK1.4版本：正则表达式、异常链、NIO、日志类、XML解析器、XSLT转换器</span><br><span class="line">JDK1.5版本：语法：自动装箱、泛型、动态注解、枚举、可变长参数、遍历循环（foreach循环）jmx 元数据(注解); 引入Instrumentation(Agent，jvm级别的AOP)</span><br><span class="line">      虚拟机和API:改进了Java的内存模型、提供了Java.util.concurrent并发包</span><br><span class="line">JDK1.6版本：终结了J2ME/J2SE/J2EE的命名方式，启用Java SE6/Java EE6/Java ME6的命名方式</span><br><span class="line">      提供动态语言支持（通过内置的Mozilla javaScript Rhion引擎实现）</span><br><span class="line">      提供编译API和微型HTTP服务器API，增强Instrumentation，虚拟机启动后的</span><br><span class="line">      虚拟机改进：锁与同步、垃圾收集、类加载</span><br><span class="line">JDK1.7版本：nio2 try resource autocloseable JVM新增了一套叫做invokedynamic的指令为为支持动态类型化程序语言的实现；并发API新增了轻量级的分支/合并（Fork/Join）框架</span><br><span class="line">      Java开源</span><br><span class="line">      提供新的G1收集器（G1在发布时依然处于Experimental状态）</span><br><span class="line">      加强对非Java语言的调用支持（JSR-292到目前没有完全实现定型）、升级类加载架构</span><br><span class="line">JDK1.8版本：Lambda表达式、Coin</span><br><span class="line">JDK1.9版本：flow reative 模块化</span><br><span class="line">JDK10版本：var 垃圾收集改进</span><br><span class="line">JDK11版本：httpclient 垃圾收集改进 Epsilon 垃圾收集器被称为“no-op”收集器，将处理内存分配而不实施任何实际的内存回收机制</span><br></pre></td></tr></table></figure>
<h5><span id="其他">其他</span></h5><h6><span id="classloder">classLoder</span></h6><p>​    双亲委派，以及怎么破坏双亲委派，在spring和tomcat中的体现</p>
<p>​    文档：<a href="https://zhuanlan.zhihu.com/p/51374915?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/51374915?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336</a></p>
<h6><span id="java官方订阅">java官方订阅</span></h6><p>​    获取了解最新变化情况</p>
<p>​    文档：mail.openjdk.java.net Mailing Lists</p>
<h4><span id="java-eeenterprise-edition">Java EE（Enterprise Edition）</span></h4><p>​    常用的技术栈spring + springmvc + mybatis(或者其他的orm框架) ，这里建议学习j2ee的常用规范</p>
<h5><span id="spring-spring-boot">Spring /Spring boot</span></h5><p>​    ==注意关注版本特征==</p>
<p>​    spring 实现了大部分的j2ee规范，本身主要是DI（管理对象之间的关系）和AOP（切面编程） ，深度学习源码和理解它的优秀思想（简单，开放），springmvc</p>
<p>​    SpringBoot的简化配置，部署，自动装配。</p>
<p>​    书籍📚《spring实战》、《spring技术内幕》、《spring源码剖析》、《Expert One-on-One J2EE Design and Development》《Expert One-on-One J2EE Development without EJB》 spring作者写的书</p>
<p>​    文档：spring 动态代理 <a href="https://mp.weixin.qq.com/s/vCZP8sPrtnXWvg6IlcHQOg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/vCZP8sPrtnXWvg6IlcHQOg</a></p>
<p>​            特性 <a href="https://mp.weixin.qq.com/s/09lMCJKvACOU_umkzu2StQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/09lMCJKvACOU_umkzu2StQ</a></p>
<h5><span id="其他">其他</span></h5><h6><span id="web-framework框架性能">web Framework框架性能</span></h6><p>​    关注常用框架性能</p>
<p>​    文档 <a href="https://www.techempower.com/benchmarks/#section=data-r17" target="_blank" rel="noopener">https://www.techempower.com/benchmarks/#section=data-r17</a>    </p>
<h4><span id="重视规范">重视规范</span></h4><h5><span id="jvm规范">JVM规范</span></h5><p>​    Java语言规范、Java虚拟机规范、Java内存模型规范</p>
<p>​    书籍📚/文档：官方文档 ==待补充==</p>
<h5><span id="jsr规范">JSR规范</span></h5><p>​    Servlet、REST、JDBC、JNDI、JPA、JTA、Bean Validation、JMS等</p>
<p>​    书籍📚/文档：JSR <a href="https://jcp.org/en/jsr/platform" target="_blank" rel="noopener">https://jcp.org/en/jsr/platform</a></p>
<p>​    Servlet :  servlet规范 -&gt; springMVC -&gt; servelt容器 tomcat jetty</p>
<p>​    JNDI: Java Naming and Directory Interface，JNDI避免了程序与数据库之间的紧耦合，使应用更加易于配置、易于部署。 SPI  <a href="https://www.zhihu.com/question/49667892/answer/404097870" target="_blank" rel="noopener">https://www.zhihu.com/question/49667892/answer/404097870</a>    /   <a href="https://blog.hhui.top/hexblog/2017/05/26/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E4%B8%80%EF%BC%9A%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D/#%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%9A-Z-blog" target="_blank" rel="noopener">https://blog.hhui.top/hexblog/2017/05/26/SPI%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E4%B9%8B%E6%97%85%E4%B8%80%EF%BC%9A%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D/#%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%EF%BC%9A-Z-blog</a></p>
<p>​    restful风格 —–》〉 <a href="https://mp.weixin.qq.com/s/_CeSX_lSoyg9zPxs52twRA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/_CeSX_lSoyg9zPxs52twRA</a></p>
<h5><span id="ietf规范">IETF规范</span></h5><p>​    URL/URI、HTTP、REST、WebSockets等</p>
<p>​    书籍📚/文档：RFC 2616 新标准</p>
<h5><span id="消息规范">消息规范</span></h5><p>​    AMQP、MQTT</p>
<p>​    书籍📚/文档：官方文档 ==待补充==</p>
<h5><span id="关系型数据库规范">关系型数据库规范</span></h5><p>​    SQL99、SQL03等</p>
<p>​    书籍📚/文档：官方文档 ==待补充==</p>
<h5><span id="reactive-规范">Reactive 规范</span></h5><p>​    Reactive Manifesto、Reactive Streams    </p>
<p>​    书籍📚/文档：官方文档 ==待补充==</p>
<h4><span id="高效优雅">高效/优雅</span></h4><p>​    多看，多写模仿，例如spring中的设计模式，tomcat中的设计模式</p>
<p>​    常用工具Git、Maven 、Nginx</p>
<p>​    书籍📚/文档 ：《Maven实战》、《Effective Java》、《重构》、《Head First设计模式》、《测试驱动开发 by Example》、《程序员修炼之道》翻译不太好</p>
<h4><span id="框架中间件">框架/中间件</span></h4><p>​    关注常用框架，以及生命周期Attic—–&gt; <a href="https://attic.apache.org/，注意主流框架的版本特征" target="_blank" rel="noopener">https://attic.apache.org/，注意主流框架的版本特征</a> / 使用了什么设计模式</p>
<h5><span id="web栈">Web栈</span></h5><p>​    Struts、 Spring </p>
<h5><span id="关系型数据库">关系型数据库</span></h5><p>​     MyBatis、Hiberante、JPA</p>
<h5><span id="nosql">NoSQL</span></h5><p>​      Redis 、Mongo、 ELasticSearch、Hbase</p>
<h5><span id="rpc">RPC</span></h5><p>​    CXF(WebServices)、Spring Cloud Feign(REST)、Dubbo (多协议)</p>
<h5><span id="任务调度">任务调度</span></h5><p>​    Java Timer/ScheduleExecutorService、 Spring @Scheduled</p>
<h5><span id="消息服务">消息服务</span></h5><p>​    ActiveMQ（JMS）、RabbitMQ（AMQP）、Kafka</p>
<h5><span id="客户端">客户端</span></h5><p>​    HttpClient(HTTP) 、Spring RestTemplate ( REST )</p>
<h5><span id="web容器">Web容器</span></h5><p>​    Tomcat、Jetty​    </p>
<p>书籍📚/资料</p>
<p>​    《大型网络架构与中间件》、《Tomcat架构解析》</p>
<p>​         tomcat设计模式 <a href="https://www.cnblogs.com/coldridgeValley/p/6606271.html" target="_blank" rel="noopener">https://www.cnblogs.com/coldridgeValley/p/6606271.html</a></p>
<p>​    </p>
<h4><span id="微服务演变">微服务演变</span></h4><p>​    SOA向微服务的演变，衍生了许多技术，CAP 、BASE理论</p>
<h5><span id="服务调用">服务调用</span></h5><p>​    如何高并发、高可用</p>
<h5><span id="分布式配置">分布式配置</span></h5><p>​    Nacos、Spring Cloud Feign</p>
<h5><span id="服务注册发现">服务注册/发现</span></h5><p>​    zk、Eureka Consul。对比，使用场景。 cp、ap</p>
<p>​    书籍📚：《proxys到zookeeper一致性协议》</p>
<h5><span id="路由负载均衡">路由/负载均衡</span></h5><p>​    Netflix Ribbon</p>
<h5><span id="熔断限流">熔断/限流</span></h5><p>​    Spring Cloud Hystrix</p>
<p>相关技术：</p>
<p>​    限流 -》RateLimiter是Guava的concurrent包下的一个用于限制访问频率的类.</p>
<h5><span id="网关">网关</span></h5><p>​    Spring Cloud Zuul     </p>
<h5><span id="其他">其他</span></h5><p>​    分布式锁    </p>
<p>​    分布式事务 <a href="https://mp.weixin.qq.com/s/oKOzvN49zOhl8cwliy3SEg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/oKOzvN49zOhl8cwliy3SEg</a></p>
<p>​        XA两阶段提交的不足  XA三阶段</p>
<p>​    解决一致性问题，raft、Gossip （redis）、Paxos(zk)</p>
<h5><span id="spring-cloud-侵入式">Spring Cloud （侵入式）</span></h5><p>​    可以看看springCloud都做了些什么实现</p>
<p>​    Compare with k8s  <a href="https://en.wikipedia.org/wiki/Kubernetes#Comparison_to_Spring_Cloud" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Kubernetes#Comparison_to_Spring_Cloud</a></p>
<p>​    相关文档/书籍📚：《领域驱动》、《SpringCloud微服务实践》</p>
<h5><span id="service-mesh-非侵入式">Service Mesh （非侵入式）</span></h5><p>​    kubernetes 为基础，docker为容器（<a href="https://zhuanlan.zhihu.com/p/54512286?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336）" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/54512286?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336）</a></p>
<p>​    相关技术：CI/CD 持续集成</p>
<p>相关文档/书籍📚：《Docker进阶与实战》</p>
<h4><span id="大数据生态">大数据生态</span></h4><p>​    Kafka zookeeper flume</p>
<p>​    实时 sparker</p>
<p>​    离线 hive</p>
<h4><span id="其他">其他</span></h4><h6><span id="开阔视野">开阔视野</span></h6><p>​    正所谓站的高看得远，多关注业界发展。 </p>
<p>​    相关资料：<a href="https://www.zhihu.com/question/305924723/answer/556971474?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336" target="_blank" rel="noopener">https://www.zhihu.com/question/305924723/answer/556971474?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=557574927448846336</a></p>
<p>​    <a href="https://mp.weixin.qq.com/s/CPUaB60pue0Zf3fUL9xqvw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/CPUaB60pue0Zf3fUL9xqvw</a></p>
<p>​    <a href="http://www.iocoder.cn/chinese-comment-repository/?xing" target="_blank" rel="noopener">http://www.iocoder.cn/chinese-comment-repository/?xing</a></p>
<h6><span id="性能压力测试调优">性能/压力测试/调优</span></h6><p>​    懂常用性能指标，以及如何预估性能</p>
<p>​    相关资料：</p>
<p>​    <a href="https://mp.weixin.qq.com/s/w0TxuFQZAIED879JRax8vg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/w0TxuFQZAIED879JRax8vg</a></p>
<p>​    <a href="https://mp.weixin.qq.com/s/Lz4cEt0LY_Fvqz2zAgOafw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Lz4cEt0LY_Fvqz2zAgOafw</a></p>
<h6><span id="前端基础">前端基础</span></h6><p>​    除了html、css、javascript 相关、 一些前端框架也需要了解Vue、React</p>
<p>​    前后端分离/单页面应用—》〉<a href="https://blog.csdn.net/Nicorui/article/details/74945839" target="_blank" rel="noopener">https://blog.csdn.net/Nicorui/article/details/74945839</a></p>
<p>​    书籍📚《Javascript DOM编程艺术》</p>
<h6><span id="态度">态度</span></h6><p>​    保持自我驱动和热情/不满足于完成预期</p>
<h6><span id="学习方法">学习方法</span></h6><p>是什么 </p>
<p>​    官方、wiki、同类技术对比、组成部分</p>
<p>为什么</p>
<p>​    解决了什么问题、没有出现之前怎么做</p>
<p>怎么做</p>
<p>​    官方示例/文档 、相关学习视频、写Demo、带着问题看源码、实践</p>
<p>输出</p>
<p>​    写blog、分享</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/02/java-all/" data-id="cjtjoe4hu0003v49cvs8pkupj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/summary/">summary</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-j2ee_servlet" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/02/j2ee_servlet/" class="article-date">
  <time datetime="2019-02-02T10:05:54.000Z" itemprop="datePublished">2019-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/02/j2ee_servlet/">j2ee_servlet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->
<ul>
<li><a href="#1servlet-31规范概览">1.servlet 3.1规范概览</a><ul>
<li><a href="#11-what-is-servlet">1.1 What is servlet</a></li>
<li><a href="#12-history">1.2 History</a></li>
<li><a href="#13-servlet-life-cycle">1.3 Servlet Life Cycle</a></li>
<li><a href="#14-servlet-继承结构">1.4 Servlet 继承结构</a></li>
<li><a href="#15-servletcontext">1.5 ServletContext</a></li>
<li><a href="#16-request">1.6 Request</a></li>
<li><a href="#17-response">1.7 Response</a></li>
<li><a href="#18-filter">1.8 Filter</a></li>
<li><a href="#19-lifecycle-events">1.9 Lifecycle Events</a></li>
<li><a href="#110-session">1.10 Session</a></li>
</ul>
</li>
<li><a href="#2-servlet">2. Servlet</a><ul>
<li><a href="#21-servlet接口">2.1 Servlet接口</a></li>
<li><a href="#22-servletconfig接口">2.2 ServletConfig接口</a></li>
<li><a href="#23-generieservlet">2.3 GenerieServlet</a></li>
<li><a href="#24-httpservlet">2.4 HttpServlet</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<hr>
<h4><span id="1servlet-31规范概览">1.servlet 3.1规范概览</span></h4><h6><span id="11-what-is-servlet">1.1 What is servlet</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A servlet is a JavaTM technology-based Web component, managed by a container, that generates dynamic content.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>From servlet 3.1</p>
</blockquote>
<h6><span id="12-history">1.2 History</span></h6><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fy9oye7wq4j31pm0hyarl.jpg" alt=""></p>
<blockquote>
<p>From wiki</p>
</blockquote>
<h6><span id="13-servlet-life-cycle">1.3 Servlet Life Cycle</span></h6><ul>
<li><p>Loading and Instantiation</p>
<p>  When the servlet engine is started, needed servlet classes must be located by the<br>  servlet container(WEB-INF/lib)</p>
</li>
<li><p>Initialization</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The container initializes the servlet instance by calling the init method of the Servlet interface with a unique (per servlet declaration) object implementing the ServletConfig interface</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>（ServletConfig used by Servlet）</p>
<ul>
<li><p>Request Handling</p>
<p>  After a servlet is properly initialized, the servlet container may use it to handle client<br>  requests. </p>
</li>
<li><p>End of Service</p>
</li>
</ul>
<h6><span id="14-servlet-继承结构">1.4 Servlet 继承结构</span></h6><p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fycf0mk9d5j30u00u6dqo.jpg" alt="image-20181219221816845"></p>
<h6><span id="15-servletcontext">1.5 ServletContext</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The ServletContext interface defines a servlet’s view of the Web application within which the servlet is running.  (web.xml) The Container Provider is responsible for providing an implementation of the ServletContext interface in the servlet container.</span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">InitParameter</span><br><span class="line">config </span><br><span class="line"><span class="code">	-Filter</span></span><br><span class="line"><span class="code">	-Listenr</span></span><br><span class="line"><span class="code">	-Servlet</span></span><br><span class="line">Attribute</span><br><span class="line">Resource</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>see : ApplicationContext、ApplicationContextFacade (tomcat)</p>
</blockquote>
<h6><span id="16-request">1.6 Request</span></h6><p>HttpServletRequest</p>
<ul>
<li><p>HTTP Protocol Parameters</p>
<blockquote>
<p>■ getParameter</p>
<p>■ getParameterNames </p>
<p>■ getParameterValues </p>
<p>■ getParameterMap</p>
</blockquote>
</li>
<li><p>File upload </p>
<p>  content-type : multipart/form-data </p>
</li>
<li><p>Attributes </p>
</li>
<li><p>Headers</p>
</li>
<li><p>Request Path Elements</p>
<blockquote>
<p>requestURI = contextPath + servletPath + pathInfo</p>
</blockquote>
</li>
<li><p>Path Translation Methods</p>
<blockquote>
<p>■ ServletContext.getRealPath  </p>
<p>■ HttpServletRequest.getPathTranslated</p>
</blockquote>
</li>
<li><p>Non Blocking IO</p>
<p>  Non-blocking IO only works with async request processing in Servlets and Filters</p>
</li>
<li><p>Cookies</p>
</li>
<li><p>SSL</p>
</li>
<li><p>Internationalization</p>
<p>  Accept-Language : zh-cn</p>
</li>
<li><blockquote>
<p>■ getLocale<br>■ getLocales</p>
</blockquote>
</li>
<li><p>Request data encoding </p>
<p>  The default encoding of a request the container uses to create the request reader and parse POST data must be “ISO-8859-1” if none has been specified by the client request. </p>
</li>
<li><p>Lifetime of the Request Object </p>
<p>  Each request object is valid only within the scope of a servlet’s service method, or within the scope of a filter’s doFilter method, unless the asynchronous processing is enabled for the component and the startAsync method is invoked on the request object. </p>
</li>
</ul>
<h6><span id="17-response">1.7 Response</span></h6><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fyceza35scj30lc0luwf3.jpg" alt="image-20181219221656097"></p>
<h6><span id="18-filter">1.8 Filter</span></h6><pre><code>what is Filter? 
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A filter is a reusable piece of code that can transform the content of HTTP requests,responses, and header information.</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; org.springframework.web.servlet.HandlerInterceptor</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6><span id="19-lifecycle-events">1.9 Lifecycle Events</span></h6><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Event</span><br><span class="line">	-Servlet</span><br><span class="line">	-Session</span><br><span class="line">	-Request</span><br><span class="line">EventListener</span><br><span class="line">	-Servlet</span><br><span class="line">	-Session</span><br><span class="line">	-Request</span><br></pre></td></tr></table></figure>
<p>Example : <code>ServletContextListener</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextLoaderListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ContextLoader contextLoader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContextLoaderListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.contextLoader = <span class="keyword">this</span>.createContextLoader();</span><br><span class="line">        <span class="keyword">this</span>.contextLoader.initWebApplicationContext(event.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ContextLoader <span class="title">createContextLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ContextLoader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ContextLoader <span class="title">getContextLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.contextLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.contextLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.contextLoader.closeWebApplicationContext(event.getServletContext());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6><span id="110-session">1.10 Session</span></h6><h4><span id="2-servlet">2. Servlet</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server + Applet 的缩写，表示一个服务器应用</span><br></pre></td></tr></table></figure>
<h6><span id="21-servlet接口">2.1 Servlet接口</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> ServletException, IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Load-on-startup 为负的话不会在容器启动调用</p>
</blockquote>
<h6><span id="22-servletconfig接口">2.2 ServletConfig接口</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A servlet configuration object used by a servlet container</span></span><br><span class="line"><span class="comment"> * to pass information to a servlet during initialization. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getInitParameterNames</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--web.xml--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>application-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>demoDispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.Dispatcher<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>demo-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在Servlet中 可以分别通过它们的getInitParameter方法获取，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String contextLocation = getServletConfig().getServletContext().getInitParameter(</span><br><span class="line">    <span class="string">"contextConfigLocation"</span>);</span><br><span class="line">String servletLocation = getServletConfig().getInitParameter(<span class="string">"contextConfigLocation"</span>);</span><br></pre></td></tr></table></figure>
<h6><span id="23-generieservlet">2.3 GenerieServlet</span></h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`Servlet`的默认实现，同时实现了`ServletConfig`接口、`Serializable`接口，所以可以直接调用`ServletConfig`里面的方法。详细可参考如下类注释。</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Defines a generic, protocol-independent</span></span><br><span class="line"><span class="comment"> * servlet. To write an HTTP servlet for use on the</span></span><br><span class="line"><span class="comment"> * Web, extend &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServlet&#125; instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;code&gt;GenericServlet&lt;/code&gt; implements the &lt;code&gt;Servlet&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * and &lt;code&gt;ServletConfig&lt;/code&gt; interfaces. &lt;code&gt;GenericServlet&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * may be directly extended by a servlet, although it's more common to extend</span></span><br><span class="line"><span class="comment"> * a protocol-specific subclass such as &lt;code&gt;HttpServlet&lt;/code&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;code&gt;GenericServlet&lt;/code&gt; makes writing servlets</span></span><br><span class="line"><span class="comment"> * easier. It provides simple versions of the lifecycle methods </span></span><br><span class="line"><span class="comment"> * &lt;code&gt;init&lt;/code&gt; and &lt;code&gt;destroy&lt;/code&gt; and of the methods </span></span><br><span class="line"><span class="comment"> * in the &lt;code&gt;ServletConfig&lt;/code&gt; interface. &lt;code&gt;GenericServlet&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * also implements the &lt;code&gt;log&lt;/code&gt; method, declared in the</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;ServletContext&lt;/code&gt; interface. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;To write a generic servlet, you need only</span></span><br><span class="line"><span class="comment"> * override the abstract &lt;code&gt;service&lt;/code&gt; method. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericServlet</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Servlet</span>, <span class="title">ServletConfig</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericServlet</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getServletConfig().getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration <span class="title">getInitParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getServletConfig().getInitParameterNames();</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getServletConfig().getServletContext();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.config = config;</span><br><span class="line">		<span class="keyword">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">		getServletContext().log(getServletName() + <span class="string">": "</span>+ msg);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">		getServletContext().log(getServletName() + <span class="string">": "</span> + message, t);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getServletName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>附：为什么需要实现 <code>java.io.Serializable</code> 接口？</p>
<hr>
<p>答：在 Servlet 2.4 规范的 7.7.2 Distributed Environments 章节中，有一句这样的描述：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The distributed servlet container must support the mechanism necessary for</span><br><span class="line">migrating objects that implement Serializable.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>按照规范的设计，Servlet 有一个钝化的特性，类似于 Servlet 持久化到文件，然后当容器 Crash 回复后，可以重新恢复保存前的状态。</p>
</blockquote>
<h6><span id="24-httpservlet">2.4 HttpServlet</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ....;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides an abstract class to be subclassed to create</span></span><br><span class="line"><span class="comment"> * an HTTP servlet suitable for a Web site. A subclass of</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;HttpServlet&lt;/code&gt; must override at least </span></span><br><span class="line"><span class="comment"> * one method, usually one of these:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;doGet&lt;/code&gt;, if the servlet supports HTTP GET requests</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;doPost&lt;/code&gt;, for HTTP POST requests</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;doPut&lt;/code&gt;, for HTTP PUT requests</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;doDelete&lt;/code&gt;, for HTTP DELETE requests</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;init&lt;/code&gt; and &lt;code&gt;destroy&lt;/code&gt;, </span></span><br><span class="line"><span class="comment"> * to manage resources that are held for the life of the servlet</span></span><br><span class="line"><span class="comment"> * &lt;li&gt; &lt;code&gt;getServletInfo&lt;/code&gt;, which the servlet uses to</span></span><br><span class="line"><span class="comment"> * provide information about itself </span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;There's almost no reason to override the &lt;code&gt;service&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * method. &lt;code&gt;service&lt;/code&gt; handles standard HTTP</span></span><br><span class="line"><span class="comment"> * requests by dispatching them to the handler methods</span></span><br><span class="line"><span class="comment"> * for each HTTP request type (the &lt;code&gt;do&lt;/code&gt;&lt;i&gt;XXX&lt;/i&gt;</span></span><br><span class="line"><span class="comment"> * methods listed above).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Likewise, there's almost no reason to override the </span></span><br><span class="line"><span class="comment"> * &lt;code&gt;doOptions&lt;/code&gt; and &lt;code&gt;doTrace&lt;/code&gt; methods.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServlet</span> <span class="keyword">extends</span> <span class="title">GenericServlet</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_DELETE = <span class="string">"DELETE"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_HEAD = <span class="string">"HEAD"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_GET = <span class="string">"GET"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_OPTIONS = <span class="string">"OPTIONS"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_POST = <span class="string">"POST"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_PUT = <span class="string">"PUT"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_TRACE = <span class="string">"TRACE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_IFMODSINCE = <span class="string">"If-Modified-Since"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_LASTMOD = <span class="string">"Last-Modified"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Resource bundles contain locale-specific objects.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LSTRING_FILE =</span><br><span class="line">	<span class="string">"javax.servlet.http.LocalStrings"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ResourceBundle lStrings =</span><br><span class="line">	ResourceBundle.getBundle(LSTRING_FILE);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpServlet</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        String protocol = req.getProtocol();</span><br><span class="line">        String msg = lStrings.getString(<span class="string">"http.method_get_not_supported"</span>);</span><br><span class="line">        <span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doHead</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        NoBodyResponse response = <span class="keyword">new</span> NoBodyResponse(resp);</span><br><span class="line"></span><br><span class="line">        doGet(req, response);</span><br><span class="line">        response.setContentLength();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        String protocol = req.getProtocol();</span><br><span class="line">        String msg = lStrings.getString(<span class="string">"http.method_post_not_supported"</span>);</span><br><span class="line">        <span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">       <span class="comment">//略,类似doPost</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(HttpServletRequest req,</span></span></span><br><span class="line"><span class="function"><span class="params">			    HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">       <span class="comment">//略,类似doPost</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOptions</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">      <span class="comment">//略,主要用于调试,输出允许类型</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        String method = req.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class="line">            <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">            <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// servlet doesn't support if-modified-since, no reason</span></span><br><span class="line">            <span class="comment">// to go through further expensive logic</span></span><br><span class="line">            doGet(req, resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</span><br><span class="line">            <span class="keyword">if</span> (ifModifiedSince &lt; (lastModified / <span class="number">1000</span> * <span class="number">1000</span>)) &#123;</span><br><span class="line">                <span class="comment">// If the servlet mod time is later, call doGet()</span></span><br><span class="line">                        <span class="comment">// Round down to the nearest second for a proper compare</span></span><br><span class="line">                        <span class="comment">// A ifModifiedSince of -1 will always be less</span></span><br><span class="line">                maybeSetLastModified(resp, lastModified);</span><br><span class="line">                doGet(req, resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class="line">            <span class="keyword">long</span> lastModified = getLastModified(req);</span><br><span class="line">            maybeSetLastModified(resp, lastModified);</span><br><span class="line">            doHead(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class="line">            doPost(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class="line">            doPut(req, resp);	</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class="line">            doDelete(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class="line">            doOptions(req,resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class="line">            doTrace(req,resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Note that this means NO servlet supports whatever</span></span><br><span class="line">            <span class="comment">// method was requested, anywhere on this server.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            String errMsg = lStrings.getString(<span class="string">"http.method_not_implemented"</span>);</span><br><span class="line">            Object[] errArgs = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">            errArgs[<span class="number">0</span>] = method;</span><br><span class="line">            errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class="line">            resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        HttpServletRequest	request;</span><br><span class="line">        HttpServletResponse	response;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            request = (HttpServletRequest) req;</span><br><span class="line">            response = (HttpServletResponse) res;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"non-HTTP request or response"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A response that includes no body, for use in (dumb) "HEAD" support.</span></span><br><span class="line"><span class="comment"> * This just swallows that body, counting the bytes in order to set</span></span><br><span class="line"><span class="comment"> * the content length appropriately.  All other methods delegate directly</span></span><br><span class="line"><span class="comment"> * to the HTTP Servlet Response object used to construct this one.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// file private</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoBodyResponse</span> <span class="keyword">extends</span> <span class="title">HttpServletResponseWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NoBodyOutputStream		noBody;</span><br><span class="line">    <span class="keyword">private</span> PrintWriter			writer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>			didSetContentLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// file private</span></span><br><span class="line">    NoBodyResponse(HttpServletResponse r) &#123;</span><br><span class="line">        <span class="keyword">super</span>(r);</span><br><span class="line">	noBody = <span class="keyword">new</span> NoBodyOutputStream();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ....</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Servlet output stream that gobbles up all its data.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// file private</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoBodyOutputStream</span> <span class="keyword">extends</span> <span class="title">ServletOutputStream</span> </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">doXXX 都是模板方法，如果子类没有实现将抛出异常</span><br><span class="line"></span><br><span class="line">doGet 方法前还会对是否过期做检查，如果没有过期，则直接返回304状态码做缓存。</span><br><span class="line"></span><br><span class="line">doHead调用了doGet的请求，然后返回空body的response</span><br><span class="line"></span><br><span class="line">doOptions和doTrace 主要是用来做一些调试工作</span><br></pre></td></tr></table></figure>
<p>####</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/02/j2ee_servlet/" data-id="cjtjoe4hq0001v49cu9fj8q43" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/j2ee/">j2ee</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/servlet/">servlet</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ejb/">ejb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ioc/">ioc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/j2ee/">j2ee</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servlet/">servlet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-mvc/">spring-mvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-webflux/">spring-webflux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/summary/">summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ejb/" style="font-size: 10px;">ejb</a> <a href="/tags/ioc/" style="font-size: 10px;">ioc</a> <a href="/tags/j2ee/" style="font-size: 15px;">j2ee</a> <a href="/tags/servlet/" style="font-size: 15px;">servlet</a> <a href="/tags/spring/" style="font-size: 20px;">spring</a> <a href="/tags/spring-mvc/" style="font-size: 10px;">spring-mvc</a> <a href="/tags/spring-webflux/" style="font-size: 10px;">spring-webflux</a> <a href="/tags/summary/" style="font-size: 10px;">summary</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/03/10/Expert One-on-One-J2EE-Development-without-EJB/">Expert One-on-One J2EE Development without EJB</a>
          </li>
        
          <li>
            <a href="/2019/03/10/Expert-One-on-One-J2EE-Design-and-Development-总结/">Expert One-on-One J2EE Design and Development</a>
          </li>
        
          <li>
            <a href="/2019/03/03/spring-ioc/">spring-ioc</a>
          </li>
        
          <li>
            <a href="/2019/03/02/spring/">spring</a>
          </li>
        
          <li>
            <a href="/2019/02/03/servlet-springmvc/">servlet_spring-mvc</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 zhengyumin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>