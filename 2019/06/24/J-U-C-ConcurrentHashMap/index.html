<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="keywords" content="juc,map">
<meta property="og:type" content="article">
<meta property="og:title" content="J.U.C_ConcurrentHashMap">
<meta property="og:url" content="http://yoursite.com/2019/06/24/J-U-C-ConcurrentHashMap/index.html">
<meta property="og:site_name" content="Zyumin">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006tNc79gy1g4cgatpl82j30qo0k03zd.jpg">
<meta property="og:updated_time" content="2019-06-26T10:07:10.108Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="J.U.C_ConcurrentHashMap">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006tNc79gy1g4cgatpl82j30qo0k03zd.jpg">






  <link rel="canonical" href="http://yoursite.com/2019/06/24/J-U-C-ConcurrentHashMap/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>J.U.C_ConcurrentHashMap | Zyumin</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemsope="" itemtype="http://schema.org/WPHeader">
	  <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zyumin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">自驱和热情</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/Zyumin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/24/J-U-C-ConcurrentHashMap/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhengyumin">
      <meta itemprop="description" content="为了将事情做好，首先你得喜欢做这件事，而不是喜欢这件事的结果，那仅仅是第二位。">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zyumin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">J.U.C_ConcurrentHashMap

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-24 19:03:29" itemprop="dateCreated datePublished" datetime="2019-06-24T19:03:29+08:00">2019-06-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-26 18:07:10" itemprop="dateModified" datetime="2019-06-26T18:07:10+08:00">2019-06-26</time>
              
            
          </span>

          

          
            
            
          

          
          
            <span id="/2019/06/24/J-U-C-ConcurrentHashMap/" class="leancloud_visitors" data-flag-title="J.U.C_ConcurrentHashMap">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">44k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">40 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g4cgatpl82j30qo0k03zd.jpg" alt="img"></p>
<a id="more"></a>
<h2 id="preface"><a href="#preface" class="headerlink" title="preface"></a>preface</h2><p>​    做为办公室的游泳健将,鱼是不可能不摸的. 今天在查找接口文档的时候,发现一些业务,像商详、秒杀,这些抗流都是使用的本地缓存,  第二层再是redis. </p>
<p>​    那么本地缓存一般会使用的都是Map结构(例如key为skuId), 现在使用最多的就是Guava Cache,  然而Spring5即将放弃掉Guava Cache作为缓存机制，而改用Caffeine作为新的本地Cache的组件.(至于为啥,不是一两句能够讲清的 主要是性能,其次是语言方面 函数式编程) 这些实现都是基于今天要讲的CHM</p>
<p>​    PS:以下内容基于JDK 1.8</p>
<h2 id="Map-Implementations"><a href="#Map-Implementations" class="headerlink" title="Map Implementations"></a>Map Implementations</h2><p>CHM是Map 的一种实现, 这里再简单说说Map的其他实现. Map的实现分为通用实现(General-Purpose Map Implementations)，专用实现(Special-Purpose Map Implementations)和并发实现(Concurrent Map Implementations)。</p>
<p><a href="https://docs.oracle.com/javase/tutorial/collections/implementations/map.html" target="_blank" rel="noopener">More see here</a>  (Map接口在1.8有挺多改动的,例如complete 、merge)</p>
<h3 id="General-Purpose-Map-Implementations"><a href="#General-Purpose-Map-Implementations" class="headerlink" title="General-Purpose Map Implementations"></a>General-Purpose Map Implementations</h3><blockquote>
<p>The three general-purpose <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener"><code>Map</code></a> implementations are <a href="https://docs.oracle.com/javase/8/docs/api/java/util/HashMap.html" target="_blank" rel="noopener"><code>HashMap</code></a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/TreeMap.html" target="_blank" rel="noopener"><code>TreeMap</code></a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/LinkedHashMap.html" target="_blank" rel="noopener"><code>LinkedHashMap</code></a>.If you need <code>SortedMap</code> operations or key-ordered <code>Collection</code>-view iteration, use <code>TreeMap</code>; if you want maximum speed and don’t care about iteration order, use <code>HashMap</code>; if you want near-<code>HashMap</code> performance and insertion-order iteration, use <code>LinkedHashMap</code></p>
</blockquote>
<p>TreeMap 用于排序 </p>
<p>LinkedHashMap 额外维护一个队列, 可以用它来简单实现一个LRU算法</p>
<h3 id="Special-Purpose-Map-Implementations"><a href="#Special-Purpose-Map-Implementations" class="headerlink" title="Special-Purpose Map Implementations"></a>Special-Purpose Map Implementations</h3><blockquote>
<p>There are three special-purpose Map implementations — <a href="https://docs.oracle.com/javase/8/docs/api/java/util/EnumMap.html" target="_blank" rel="noopener"><code>EnumMap</code></a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/WeakHashMap.html" target="_blank" rel="noopener"><code>WeakHashMap</code></a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/IdentityHashMap.html" target="_blank" rel="noopener"><code>IdentityHashMap</code></a>. <code>EnumMap</code>, which is internally implemented as an <code>array</code>, is a high-performance <code>Map</code> implementation for use with enum keys. This implementation combines the richness and safety of the <code>Map</code> interface with a speed approaching that of an array. If you want to map an enum to a value, you should always use an <code>EnumMap</code> in preference to an array.</p>
<p><code>WeakHashMap</code> is an implementation of the <code>Map</code> interface that stores only weak references to its keys. Storing only weak references allows a key-value pair to be garbage-collected when its key is no longer referenced outside of the <code>WeakHashMap</code>. This class provides the easiest way to harness the power of weak references. It is useful for implementing “registry-like” data structures, where the utility of an entry vanishes when its key is no longer reachable by any thread.</p>
<p><code>IdentityHashMap</code> is an identity-based <code>Map</code> implementation based on a hash table. This class is useful for topology-preserving object graph transformations, such as serialization or deep-copying. To perform such transformations, you need to maintain an identity-based “node table” that keeps track of which objects have already been seen. Identity-based maps are also used to maintain object-to-meta-information mappings in dynamic debuggers and similar systems. Finally, identity-based maps are useful in thwarting “spoof attacks” that are a result of intentionally perverse <code>equals</code> methods because <code>IdentityHashMap</code> never invokes the <code>equals</code> method on its keys. An added benefit of this implementation is that it is fast</p>
</blockquote>
<p>IdentityHashMap 不用调用equals ,而是使用==判断</p>
<h3 id="Concurrent-Map-Implementations"><a href="#Concurrent-Map-Implementations" class="headerlink" title="Concurrent Map Implementations"></a>Concurrent Map Implementations</h3><blockquote>
<p><code>ConcurrentHashMap</code> is a highly concurrent, high-performance implementation backed up by a hash table. This implementation never blocks when performing retrievals and allows the client to select the concurrency level for updates. It is intended as a drop-in replacement for <code>Hashtable</code>: in addition to implementing <code>ConcurrentMap</code>, it supports all the legacy methods peculiar to <code>Hashtable</code>. Again, if you don’t need the legacy operations, be careful to manipulate it with the <code>ConcurrentMap</code> interface.</p>
</blockquote>
<p>​    CHM是Hashtable的代替者, 至于原因嘛, 当然是性能啦. Hashtable 的实现是简单的在方法上面加synchronized ,这样会导致锁的竞争对象是实例本身.(如果是static 方法 锁的是整个类对象)</p>
<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p>通常我们应该站在实现者的角度,而不仅仅是使用者的角度, 通过猜测作者的意图, 换位思考,换成我来实现我会怎么做</p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Overview:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The primary design goal of this hash table is to maintain</span></span><br><span class="line"><span class="comment">     * concurrent readability (typically method get(), but also</span></span><br><span class="line"><span class="comment">     * iterators and related methods) while minimizing update</span></span><br><span class="line"><span class="comment">     * contention. Secondary goals are to keep space consumption about</span></span><br><span class="line"><span class="comment">     * the same or better than java.util.HashMap, and to support high</span></span><br><span class="line"><span class="comment">     * initial insertion rates on an empty table by many threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This map usually acts as a binned (bucketed) hash table.  Each</span></span><br><span class="line"><span class="comment">     * key-value mapping is held in a Node.  Most nodes are instances</span></span><br><span class="line"><span class="comment">     * of the basic Node class with hash, key, value, and next</span></span><br><span class="line"><span class="comment">     * fields. However, various subclasses exist: TreeNodes are</span></span><br><span class="line"><span class="comment">     * arranged in balanced trees, not lists.  TreeBins hold the roots</span></span><br><span class="line"><span class="comment">     * of sets of TreeNodes. ForwardingNodes are placed at the heads</span></span><br><span class="line"><span class="comment">     * of bins during resizing. ReservationNodes are used as</span></span><br><span class="line"><span class="comment">     * placeholders while establishing values in computeIfAbsent and</span></span><br><span class="line"><span class="comment">     * related methods.  The types TreeBin, ForwardingNode, and</span></span><br><span class="line"><span class="comment">     * ReservationNode do not hold normal user keys, values, or</span></span><br><span class="line"><span class="comment">     * hashes, and are readily distinguishable during search etc</span></span><br><span class="line"><span class="comment">     * because they have negative hash fields and null key and value</span></span><br><span class="line"><span class="comment">     * fields. (These special nodes are either uncommon or transient,</span></span><br><span class="line"><span class="comment">     * so the impact of carrying around some unused fields is</span></span><br><span class="line"><span class="comment">     * insignificant.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The table is lazily initialized to a power-of-two size upon the</span></span><br><span class="line"><span class="comment">     * first insertion.  Each bin in the table normally contains a</span></span><br><span class="line"><span class="comment">     * list of Nodes (most often, the list has only zero or one Node).</span></span><br><span class="line"><span class="comment">     * Table accesses require volatile/atomic reads, writes, and</span></span><br><span class="line"><span class="comment">     * CASes.  Because there is no other way to arrange this without</span></span><br><span class="line"><span class="comment">     * adding further indirections, we use intrinsics</span></span><br><span class="line"><span class="comment">     * (sun.misc.Unsafe) operations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * We use the top (sign) bit of Node hash fields for control</span></span><br><span class="line"><span class="comment">     * purposes -- it is available anyway because of addressing</span></span><br><span class="line"><span class="comment">     * constraints.  Nodes with negative hash fields are specially</span></span><br><span class="line"><span class="comment">     * handled or ignored in map methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Insertion (via put or its variants) of the first node in an</span></span><br><span class="line"><span class="comment">     * empty bin is performed by just CASing it to the bin.  This is</span></span><br><span class="line"><span class="comment">     * by far the most common case for put operations under most</span></span><br><span class="line"><span class="comment">     * key/hash distributions.  Other update operations (insert,</span></span><br><span class="line"><span class="comment">     * delete, and replace) require locks.  We do not want to waste</span></span><br><span class="line"><span class="comment">     * the space required to associate a distinct lock object with</span></span><br><span class="line"><span class="comment">     * each bin, so instead use the first node of a bin list itself as</span></span><br><span class="line"><span class="comment">     * a lock. Locking support for these locks relies on builtin</span></span><br><span class="line"><span class="comment">     * "synchronized" monitors.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Using the first node of a list as a lock does not by itself</span></span><br><span class="line"><span class="comment">     * suffice though: When a node is locked, any update must first</span></span><br><span class="line"><span class="comment">     * validate that it is still the first node after locking it, and</span></span><br><span class="line"><span class="comment">     * retry if not. Because new nodes are always appended to lists,</span></span><br><span class="line"><span class="comment">     * once a node is first in a bin, it remains first until deleted</span></span><br><span class="line"><span class="comment">     * or the bin becomes invalidated (upon resizing).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The main disadvantage of per-bin locks is that other update</span></span><br><span class="line"><span class="comment">     * operations on other nodes in a bin list protected by the same</span></span><br><span class="line"><span class="comment">     * lock can stall, for example when user equals() or mapping</span></span><br><span class="line"><span class="comment">     * functions take a long time.  However, statistically, under</span></span><br><span class="line"><span class="comment">     * random hash codes, this is not a common problem.  Ideally, the</span></span><br><span class="line"><span class="comment">     * frequency of nodes in bins follows a Poisson distribution</span></span><br><span class="line"><span class="comment">     * (http://en.wikipedia.org/wiki/Poisson_distribution) with a</span></span><br><span class="line"><span class="comment">     * parameter of about 0.5 on average, given the resizing threshold</span></span><br><span class="line"><span class="comment">     * of 0.75, although with a large variance because of resizing</span></span><br><span class="line"><span class="comment">     * granularity. Ignoring variance, the expected occurrences of</span></span><br><span class="line"><span class="comment">     * list size k are (exp(-0.5) * pow(0.5, k) / factorial(k)). The</span></span><br><span class="line"><span class="comment">     * first values are:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 0:    0.60653066</span></span><br><span class="line"><span class="comment">     * 1:    0.30326533</span></span><br><span class="line"><span class="comment">     * 2:    0.07581633</span></span><br><span class="line"><span class="comment">     * 3:    0.01263606</span></span><br><span class="line"><span class="comment">     * 4:    0.00157952</span></span><br><span class="line"><span class="comment">     * 5:    0.00015795</span></span><br><span class="line"><span class="comment">     * 6:    0.00001316</span></span><br><span class="line"><span class="comment">     * 7:    0.00000094</span></span><br><span class="line"><span class="comment">     * 8:    0.00000006</span></span><br><span class="line"><span class="comment">     * more: less than 1 in ten million</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Lock contention probability for two threads accessing distinct</span></span><br><span class="line"><span class="comment">     * elements is roughly 1 / (8 * #elements) under random hashes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Actual hash code distributions encountered in practice</span></span><br><span class="line"><span class="comment">     * sometimes deviate significantly from uniform randomness.  This</span></span><br><span class="line"><span class="comment">     * includes the case when N &gt; (1&lt;&lt;30), so some keys MUST collide.</span></span><br><span class="line"><span class="comment">     * Similarly for dumb or hostile usages in which multiple keys are</span></span><br><span class="line"><span class="comment">     * designed to have identical hash codes or ones that differs only</span></span><br><span class="line"><span class="comment">     * in masked-out high bits. So we use a secondary strategy that</span></span><br><span class="line"><span class="comment">     * applies when the number of nodes in a bin exceeds a</span></span><br><span class="line"><span class="comment">     * threshold. These TreeBins use a balanced tree to hold nodes (a</span></span><br><span class="line"><span class="comment">     * specialized form of red-black trees), bounding search time to</span></span><br><span class="line"><span class="comment">     * O(log N).  Each search step in a TreeBin is at least twice as</span></span><br><span class="line"><span class="comment">     * slow as in a regular list, but given that N cannot exceed</span></span><br><span class="line"><span class="comment">     * (1&lt;&lt;64) (before running out of addresses) this bounds search</span></span><br><span class="line"><span class="comment">     * steps, lock hold times, etc, to reasonable constants (roughly</span></span><br><span class="line"><span class="comment">     * 100 nodes inspected per operation worst case) so long as keys</span></span><br><span class="line"><span class="comment">     * are Comparable (which is very common -- String, Long, etc).</span></span><br><span class="line"><span class="comment">     * TreeBin nodes (TreeNodes) also maintain the same "next"</span></span><br><span class="line"><span class="comment">     * traversal pointers as regular nodes, so can be traversed in</span></span><br><span class="line"><span class="comment">     * iterators in the same way.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The table is resized when occupancy exceeds a percentage</span></span><br><span class="line"><span class="comment">     * threshold (nominally, 0.75, but see below).  Any thread</span></span><br><span class="line"><span class="comment">     * noticing an overfull bin may assist in resizing after the</span></span><br><span class="line"><span class="comment">     * initiating thread allocates and sets up the replacement array.</span></span><br><span class="line"><span class="comment">     * However, rather than stalling, these other threads may proceed</span></span><br><span class="line"><span class="comment">     * with insertions etc.  The use of TreeBins shields us from the</span></span><br><span class="line"><span class="comment">     * worst case effects of overfilling while resizes are in</span></span><br><span class="line"><span class="comment">     * progress.  Resizing proceeds by transferring bins, one by one,</span></span><br><span class="line"><span class="comment">     * from the table to the next table. However, threads claim small</span></span><br><span class="line"><span class="comment">     * blocks of indices to transfer (via field transferIndex) before</span></span><br><span class="line"><span class="comment">     * doing so, reducing contention.  A generation stamp in field</span></span><br><span class="line"><span class="comment">     * sizeCtl ensures that resizings do not overlap. Because we are</span></span><br><span class="line"><span class="comment">     * using power-of-two expansion, the elements from each bin must</span></span><br><span class="line"><span class="comment">     * either stay at same index, or move with a power of two</span></span><br><span class="line"><span class="comment">     * offset. We eliminate unnecessary node creation by catching</span></span><br><span class="line"><span class="comment">     * cases where old nodes can be reused because their next fields</span></span><br><span class="line"><span class="comment">     * won't change.  On average, only about one-sixth of them need</span></span><br><span class="line"><span class="comment">     * cloning when a table doubles. The nodes they replace will be</span></span><br><span class="line"><span class="comment">     * garbage collectable as soon as they are no longer referenced by</span></span><br><span class="line"><span class="comment">     * any reader thread that may be in the midst of concurrently</span></span><br><span class="line"><span class="comment">     * traversing table.  Upon transfer, the old table bin contains</span></span><br><span class="line"><span class="comment">     * only a special forwarding node (with hash field "MOVED") that</span></span><br><span class="line"><span class="comment">     * contains the next table as its key. On encountering a</span></span><br><span class="line"><span class="comment">     * forwarding node, access and update operations restart, using</span></span><br><span class="line"><span class="comment">     * the new table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Each bin transfer requires its bin lock, which can stall</span></span><br><span class="line"><span class="comment">     * waiting for locks while resizing. However, because other</span></span><br><span class="line"><span class="comment">     * threads can join in and help resize rather than contend for</span></span><br><span class="line"><span class="comment">     * locks, average aggregate waits become shorter as resizing</span></span><br><span class="line"><span class="comment">     * progresses.  The transfer operation must also ensure that all</span></span><br><span class="line"><span class="comment">     * accessible bins in both the old and new table are usable by any</span></span><br><span class="line"><span class="comment">     * traversal.  This is arranged in part by proceeding from the</span></span><br><span class="line"><span class="comment">     * last bin (table.length - 1) up towards the first.  Upon seeing</span></span><br><span class="line"><span class="comment">     * a forwarding node, traversals (see class Traverser) arrange to</span></span><br><span class="line"><span class="comment">     * move to the new table without revisiting nodes.  To ensure that</span></span><br><span class="line"><span class="comment">     * no intervening nodes are skipped even when moved out of order,</span></span><br><span class="line"><span class="comment">     * a stack (see class TableStack) is created on first encounter of</span></span><br><span class="line"><span class="comment">     * a forwarding node during a traversal, to maintain its place if</span></span><br><span class="line"><span class="comment">     * later processing the current table. The need for these</span></span><br><span class="line"><span class="comment">     * save/restore mechanics is relatively rare, but when one</span></span><br><span class="line"><span class="comment">     * forwarding node is encountered, typically many more will be.</span></span><br><span class="line"><span class="comment">     * So Traversers use a simple caching scheme to avoid creating so</span></span><br><span class="line"><span class="comment">     * many new TableStack nodes. (Thanks to Peter Levart for</span></span><br><span class="line"><span class="comment">     * suggesting use of a stack here.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The traversal scheme also applies to partial traversals of</span></span><br><span class="line"><span class="comment">     * ranges of bins (via an alternate Traverser constructor)</span></span><br><span class="line"><span class="comment">     * to support partitioned aggregate operations.  Also, read-only</span></span><br><span class="line"><span class="comment">     * operations give up if ever forwarded to a null table, which</span></span><br><span class="line"><span class="comment">     * provides support for shutdown-style clearing, which is also not</span></span><br><span class="line"><span class="comment">     * currently implemented.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Lazy table initialization minimizes footprint until first use,</span></span><br><span class="line"><span class="comment">     * and also avoids resizings when the first operation is from a</span></span><br><span class="line"><span class="comment">     * putAll, constructor with map argument, or deserialization.</span></span><br><span class="line"><span class="comment">     * These cases attempt to override the initial capacity settings,</span></span><br><span class="line"><span class="comment">     * but harmlessly fail to take effect in cases of races.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The element count is maintained using a specialization of</span></span><br><span class="line"><span class="comment">     * LongAdder. We need to incorporate a specialization rather than</span></span><br><span class="line"><span class="comment">     * just use a LongAdder in order to access implicit</span></span><br><span class="line"><span class="comment">     * contention-sensing that leads to creation of multiple</span></span><br><span class="line"><span class="comment">     * CounterCells.  The counter mechanics avoid contention on</span></span><br><span class="line"><span class="comment">     * updates but can encounter cache thrashing if read too</span></span><br><span class="line"><span class="comment">     * frequently during concurrent access. To avoid reading so often,</span></span><br><span class="line"><span class="comment">     * resizing under contention is attempted only upon adding to a</span></span><br><span class="line"><span class="comment">     * bin already holding two or more nodes. Under uniform hash</span></span><br><span class="line"><span class="comment">     * distributions, the probability of this occurring at threshold</span></span><br><span class="line"><span class="comment">     * is around 13%, meaning that only about 1 in 8 puts check</span></span><br><span class="line"><span class="comment">     * threshold (and after resizing, many fewer do so).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * TreeBins use a special form of comparison for search and</span></span><br><span class="line"><span class="comment">     * related operations (which is the main reason we cannot use</span></span><br><span class="line"><span class="comment">     * existing collections such as TreeMaps). TreeBins contain</span></span><br><span class="line"><span class="comment">     * Comparable elements, but may contain others, as well as</span></span><br><span class="line"><span class="comment">     * elements that are Comparable but not necessarily Comparable for</span></span><br><span class="line"><span class="comment">     * the same T, so we cannot invoke compareTo among them. To handle</span></span><br><span class="line"><span class="comment">     * this, the tree is ordered primarily by hash value, then by</span></span><br><span class="line"><span class="comment">     * Comparable.compareTo order if applicable.  On lookup at a node,</span></span><br><span class="line"><span class="comment">     * if elements are not comparable or compare as 0 then both left</span></span><br><span class="line"><span class="comment">     * and right children may need to be searched in the case of tied</span></span><br><span class="line"><span class="comment">     * hash values. (This corresponds to the full list search that</span></span><br><span class="line"><span class="comment">     * would be necessary if all elements were non-Comparable and had</span></span><br><span class="line"><span class="comment">     * tied hashes.) On insertion, to keep a total ordering (or as</span></span><br><span class="line"><span class="comment">     * close as is required here) across rebalancings, we compare</span></span><br><span class="line"><span class="comment">     * classes and identityHashCodes as tie-breakers. The red-black</span></span><br><span class="line"><span class="comment">     * balancing code is updated from pre-jdk-collections</span></span><br><span class="line"><span class="comment">     * (http://gee.cs.oswego.edu/dl/classes/collections/RBCell.java)</span></span><br><span class="line"><span class="comment">     * based in turn on Cormen, Leiserson, and Rivest "Introduction to</span></span><br><span class="line"><span class="comment">     * Algorithms" (CLR).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * TreeBins also require an additional locking mechanism.  While</span></span><br><span class="line"><span class="comment">     * list traversal is always possible by readers even during</span></span><br><span class="line"><span class="comment">     * updates, tree traversal is not, mainly because of tree-rotations</span></span><br><span class="line"><span class="comment">     * that may change the root node and/or its linkages.  TreeBins</span></span><br><span class="line"><span class="comment">     * include a simple read-write lock mechanism parasitic on the</span></span><br><span class="line"><span class="comment">     * main bin-synchronization strategy: Structural adjustments</span></span><br><span class="line"><span class="comment">     * associated with an insertion or removal are already bin-locked</span></span><br><span class="line"><span class="comment">     * (and so cannot conflict with other writers) but must wait for</span></span><br><span class="line"><span class="comment">     * ongoing readers to finish. Since there can be only one such</span></span><br><span class="line"><span class="comment">     * waiter, we use a simple scheme using a single "waiter" field to</span></span><br><span class="line"><span class="comment">     * block writers.  However, readers need never block.  If the root</span></span><br><span class="line"><span class="comment">     * lock is held, they proceed along the slow traversal path (via</span></span><br><span class="line"><span class="comment">     * next-pointers) until the lock becomes available or the list is</span></span><br><span class="line"><span class="comment">     * exhausted, whichever comes first. These cases are not fast, but</span></span><br><span class="line"><span class="comment">     * maximize aggregate expected throughput.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Maintaining API and serialization compatibility with previous</span></span><br><span class="line"><span class="comment">     * versions of this class introduces several oddities. Mainly: We</span></span><br><span class="line"><span class="comment">     * leave untouched but unused constructor arguments refering to</span></span><br><span class="line"><span class="comment">     * concurrencyLevel. We accept a loadFactor constructor argument,</span></span><br><span class="line"><span class="comment">     * but apply it only to initial table capacity (which is the only</span></span><br><span class="line"><span class="comment">     * time that we can guarantee to honor it.) We also declare an</span></span><br><span class="line"><span class="comment">     * unused "Segment" class that is instantiated in minimal form</span></span><br><span class="line"><span class="comment">     * only when serializing.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Also, solely for compatibility with previous versions of this</span></span><br><span class="line"><span class="comment">     * class, it extends AbstractMap, even though all of its methods</span></span><br><span class="line"><span class="comment">     * are overridden, so it is just useless baggage.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This file is organized to make things a little easier to follow</span></span><br><span class="line"><span class="comment">     * while reading than they might otherwise: First the main static</span></span><br><span class="line"><span class="comment">     * declarations and utilities, then fields, then main public</span></span><br><span class="line"><span class="comment">     * methods (with a few factorings of multiple public methods into</span></span><br><span class="line"><span class="comment">     * internal ones), then sizing methods, trees, traversers, and</span></span><br><span class="line"><span class="comment">     * bulk operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>
<p>以上内容摘自 java.util.concurrent.ConcurrentHashMap 的Overview 部分,下面是基于这段的一个简单翻译</p>
<h4 id="Design-golds"><a href="#Design-golds" class="headerlink" title="Design golds"></a>Design golds</h4><ol>
<li>The primary design goal of this hash table is to maintain concurrent readability (typically method get(), but also iterators and related methods) while minimizing update contention(竞争). </li>
<li>Secondary goals are to keep space consumption(消耗) about the same or better tha java.util.HashMap, and to support high initial insertion rates on an empty table by many threads.</li>
</ol>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This map usually acts as a binned (bucketed) hash table.  Each</span></span><br><span class="line"><span class="comment"> * key-value mapping is held in a Node.  Most nodes are instances</span></span><br><span class="line"><span class="comment"> * of the basic Node class with hash, key, value, and next</span></span><br><span class="line"><span class="comment"> * fields. However, various subclasses exist: TreeNodes are</span></span><br><span class="line"><span class="comment"> * arranged in balanced trees, not lists.  TreeBins hold the roots</span></span><br><span class="line"><span class="comment"> * of sets of TreeNodes. ForwardingNodes are placed at the heads</span></span><br><span class="line"><span class="comment"> * of bins during resizing. ReservationNodes are used as</span></span><br><span class="line"><span class="comment"> * placeholders while establishing values in computeIfAbsent and</span></span><br><span class="line"><span class="comment"> * related methods.  The types TreeBin, ForwardingNode, and</span></span><br><span class="line"><span class="comment"> * ReservationNode do not hold normal user keys, values, or</span></span><br><span class="line"><span class="comment"> * hashes, and are readily distinguishable during search etc</span></span><br><span class="line"><span class="comment"> * because they have negative hash fields and null key and value</span></span><br><span class="line"><span class="comment"> * fields. (These special nodes are either uncommon or transient,</span></span><br><span class="line"><span class="comment"> * so the impact of carrying around some unused fields is</span></span><br><span class="line"><span class="comment"> * insignificant.)</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>其底层实现形式也是bucket数组的形式，且&lt;key, value&gt;存储在Node中。Node存在以下子类，包括TreeBin、TreeNode、ForwardingNode、ReservationNode，后三种一般有其特殊用途。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The table is lazily initialized to a power-of-two size upon the</span></span><br><span class="line"><span class="comment"> * first insertion.  Each bin in the table normally contains a</span></span><br><span class="line"><span class="comment"> * list of Nodes (most often, the list has only zero or one Node).</span></span><br><span class="line"><span class="comment"> * Table accesses require volatile/atomic reads, writes, and</span></span><br><span class="line"><span class="comment"> * CASes.  Because there is no other way to arrange this without</span></span><br><span class="line"><span class="comment"> * adding further indirections, we use intrinsics</span></span><br><span class="line"><span class="comment"> * (sun.misc.Unsafe) operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>ConcurrentHashMap使用延迟初始化策略，在第一次insert时，才分配一个2^n大小的bucket数组，一般的bucket为list形式，通过Node中next属性来实现链表(通常链表为空或者只有一个)。</p>
<p>通过volatie 和CAS 来控制其原子性,底层使用的是sun.misc.Unsafe</p>
<h4 id="hash-conflict"><a href="#hash-conflict" class="headerlink" title="hash conflict"></a>hash conflict</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We use the top (sign) bit of Node hash fields for control</span></span><br><span class="line"><span class="comment"> * purposes -- it is available anyway because of addressing</span></span><br><span class="line"><span class="comment"> * constraints.  Nodes with negative hash fields are specially</span></span><br><span class="line"><span class="comment"> * handled or ignored in map methods.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>使用bit的高位来存储的目的是为了减少冲突</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Insertion (via put or its variants) of the first node in an</span></span><br><span class="line"><span class="comment"> * empty bin is performed by just CASing it to the bin.  This is</span></span><br><span class="line"><span class="comment"> * by far the most common case for put operations under most</span></span><br><span class="line"><span class="comment"> * key/hash distributions.  Other update operations (insert,</span></span><br><span class="line"><span class="comment"> * delete, and replace) require locks.  We do not want to waste</span></span><br><span class="line"><span class="comment"> * the space required to associate a distinct lock object with</span></span><br><span class="line"><span class="comment"> * each bin, so instead use the first node of a bin list itself as</span></span><br><span class="line"><span class="comment"> * a lock. Locking support for these locks relies on builtin</span></span><br><span class="line"><span class="comment"> * "synchronized" monitors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Using the first node of a list as a lock does not by itself</span></span><br><span class="line"><span class="comment"> * suffice though: When a node is locked, any update must first</span></span><br><span class="line"><span class="comment"> * validate that it is still the first node after locking it, and</span></span><br><span class="line"><span class="comment"> * retry if not. Because new nodes are always appended to lists,</span></span><br><span class="line"><span class="comment"> * once a node is first in a bin, it remains first until deleted</span></span><br><span class="line"><span class="comment"> * or the bin becomes invalidated (upon resizing).</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    当在一个空bin中insert第一个node时，其使用CAS操作来同步，而对于其他的update操作(insert,delete, and replace)则需要使用锁来同步。而在每一个bucket中，一般使用此bin中第一个node作为这个bin的锁，锁住整个bucket。（因为新放入bin的node总会添加到list的末尾，故除了delete掉第一个节点或resize数组之外，这个节点总是此bin的第一个node，具有稳定性）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The main disadvantage of per-bin locks is that other update</span></span><br><span class="line"><span class="comment"> * operations on other nodes in a bin list protected by the same</span></span><br><span class="line"><span class="comment"> * lock can stall, for example when user equals() or mapping</span></span><br><span class="line"><span class="comment"> * functions take a long time.  However, statistically, under</span></span><br><span class="line"><span class="comment"> * random hash codes, this is not a common problem.  Ideally, the</span></span><br><span class="line"><span class="comment"> * frequency of nodes in bins follows a Poisson distribution</span></span><br><span class="line"><span class="comment"> * (http://en.wikipedia.org/wiki/Poisson_distribution) with a</span></span><br><span class="line"><span class="comment"> * parameter of about 0.5 on average, given the resizing threshold</span></span><br><span class="line"><span class="comment"> * of 0.75, although with a large variance because of resizing</span></span><br><span class="line"><span class="comment"> * granularity. Ignoring variance, the expected occurrences of</span></span><br><span class="line"><span class="comment"> * list size k are (exp(-0.5)  * pow(0.5, k) / factorial(k)). The</span></span><br><span class="line"><span class="comment"> * first values are:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 0:    0.60653066</span></span><br><span class="line"><span class="comment"> * 1:    0.30326533</span></span><br><span class="line"><span class="comment"> * 2:    0.07581633</span></span><br><span class="line"><span class="comment"> * 3:    0.01263606</span></span><br><span class="line"><span class="comment"> * 4:    0.00157952</span></span><br><span class="line"><span class="comment"> * 5:    0.00015795</span></span><br><span class="line"><span class="comment"> * 6:    0.00001316</span></span><br><span class="line"><span class="comment"> * 7:    0.00000094</span></span><br><span class="line"><span class="comment"> * 8:    0.00000006</span></span><br><span class="line"><span class="comment"> * more: less than 1 in ten million</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Lock contention probability for two threads accessing distinct</span></span><br><span class="line"><span class="comment"> * elements is roughly 1 / (8  * #elements) under random hashes.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    当使用锁,锁住bin节点的第一个节点的时候, 最大的问题是其他访问这个bin需要等待(例如equals 和mapping 的过程花费了很长时间 ) 然而,  其实就像上面提到过的通常链表为空或者只有一个.  因为冲突的概率很低</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Actual hash code distributions encountered in practice</span></span><br><span class="line"><span class="comment"> * sometimes deviate significantly from uniform randomness.  This</span></span><br><span class="line"><span class="comment"> * includes the case when N &gt; (1&lt;&lt;30), so some keys MUST collide.</span></span><br><span class="line"><span class="comment"> * Similarly for dumb or hostile usages in which multiple keys are</span></span><br><span class="line"><span class="comment"> * designed to have identical hash codes or ones that differs only</span></span><br><span class="line"><span class="comment"> * in masked-out high bits. So we use a secondary strategy that</span></span><br><span class="line"><span class="comment"> * applies when the number of nodes in a bin exceeds a</span></span><br><span class="line"><span class="comment"> * threshold. These TreeBins use a balanced tree to hold nodes (a</span></span><br><span class="line"><span class="comment"> * specialized form of red-black trees), bounding search time to</span></span><br><span class="line"><span class="comment"> * O(log N).  Each search step in a TreeBin is at least twice as</span></span><br><span class="line"><span class="comment"> * slow as in a regular list, but given that N cannot exceed</span></span><br><span class="line"><span class="comment"> * (1&lt;&lt;64) (before running out of addresses) this bounds search</span></span><br><span class="line"><span class="comment"> * steps, lock hold times, etc, to reasonable constants (roughly</span></span><br><span class="line"><span class="comment"> * 100 nodes inspected per operation worst case) so long as keys</span></span><br><span class="line"><span class="comment"> * are Comparable (which is very common -- String, Long, etc).</span></span><br><span class="line"><span class="comment"> * TreeBin nodes (TreeNodes) also maintain the same "next"</span></span><br><span class="line"><span class="comment"> * traversal pointers as regular nodes, so can be traversed in</span></span><br><span class="line"><span class="comment"> * iterators in the same way.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>在实际使用中,哈希码分布有时会明显偏离均匀随机性。像一些错误使用,使用相同的hash codes,或低位不同会导致该问题.为了解决该问题,引入了红黑树</p>
<h4 id="resized"><a href="#resized" class="headerlink" title="resized"></a>resized</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The table is resized when occupancy exceeds a percentage</span></span><br><span class="line"><span class="comment"> * threshold (nominally, 0.75, but see below).  Any thread</span></span><br><span class="line"><span class="comment"> * noticing an overfull bin may assist in resizing after the</span></span><br><span class="line"><span class="comment"> * initiating thread allocates and sets up the replacement array.</span></span><br><span class="line"><span class="comment"> * However, rather than stalling, these other threads may proceed</span></span><br><span class="line"><span class="comment"> * with insertions etc.  The use of TreeBins shields us from the</span></span><br><span class="line"><span class="comment"> * worst case effects of overfilling while resizes are in</span></span><br><span class="line"><span class="comment"> * progress.  Resizing proceeds by transferring bins, one by one,</span></span><br><span class="line"><span class="comment"> * from the table to the next table. However, threads claim small</span></span><br><span class="line"><span class="comment"> * blocks of indices to transfer (via field transferIndex) before</span></span><br><span class="line"><span class="comment"> * doing so, reducing contention.  A generation stamp in field</span></span><br><span class="line"><span class="comment"> * sizeCtl ensures that resizings do not overlap. Because we are</span></span><br><span class="line"><span class="comment"> * using power-of-two expansion, the elements from each bin must</span></span><br><span class="line"><span class="comment"> * either stay at same index, or move with a power of two</span></span><br><span class="line"><span class="comment"> * offset. We eliminate unnecessary node creation by catching</span></span><br><span class="line"><span class="comment"> * cases where old nodes can be reused because their next fields</span></span><br><span class="line"><span class="comment"> * won't change.  On average, only about one-sixth of them need</span></span><br><span class="line"><span class="comment"> * cloning when a table doubles. The nodes they replace will be</span></span><br><span class="line"><span class="comment"> * garbage collectable as soon as they are no longer referenced by</span></span><br><span class="line"><span class="comment"> * any reader thread that may be in the midst of concurrently</span></span><br><span class="line"><span class="comment"> * traversing table.  Upon transfer, the old table bin contains</span></span><br><span class="line"><span class="comment"> * only a special forwarding node (with hash field "MOVED") that</span></span><br><span class="line"><span class="comment"> * contains the next table as its key. On encountering a</span></span><br><span class="line"><span class="comment"> * forwarding node, access and update operations restart, using</span></span><br><span class="line"><span class="comment"> * the new table.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>重新扩容当负载因子超过0.75  , 扩容通常是power-of-two ,渐进式的方式,多次扩容(通过transferIndex)  ,</p>
<p>使用字段sizeCtl来确保不会重复扩容. </p>
<p>这种扩容通常是相同的索引,或者移动power-of-two 位置(1/6的概率需要cloning) 旧表只包含forwarding node（具有散列字段“MOVED”）做为新表的key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Each bin transfer requires its bin lock, which can stall</span></span><br><span class="line"><span class="comment"> * waiting for locks while resizing. However, because other</span></span><br><span class="line"><span class="comment"> * threads can join in and help resize rather than contend for</span></span><br><span class="line"><span class="comment"> * locks, average aggregate waits become shorter as resizing</span></span><br><span class="line"><span class="comment"> * progresses.  The transfer operation must also ensure that all</span></span><br><span class="line"><span class="comment"> * accessible bins in both the old and new table are usable by any</span></span><br><span class="line"><span class="comment"> * traversal.  This is arranged in part by proceeding from the</span></span><br><span class="line"><span class="comment"> * last bin (table.length - 1) up towards the first.  Upon seeing</span></span><br><span class="line"><span class="comment"> * a forwarding node, traversals (see class Traverser) arrange to</span></span><br><span class="line"><span class="comment"> * move to the new table without revisiting nodes.  To ensure that</span></span><br><span class="line"><span class="comment"> * no intervening nodes are skipped even when moved out of order,</span></span><br><span class="line"><span class="comment"> * a stack (see class TableStack) is created on first encounter of</span></span><br><span class="line"><span class="comment"> * a forwarding node during a traversal, to maintain its place if</span></span><br><span class="line"><span class="comment"> * later processing the current table. The need for these</span></span><br><span class="line"><span class="comment"> * save/restore mechanics is relatively rare, but when one</span></span><br><span class="line"><span class="comment"> * forwarding node is encountered, typically many more will be.</span></span><br><span class="line"><span class="comment"> * So Traversers use a simple caching scheme to avoid creating so</span></span><br><span class="line"><span class="comment"> * many new TableStack nodes. (Thanks to Peter Levart for</span></span><br><span class="line"><span class="comment"> * suggesting use of a stack here.)</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    调整大小时,每个bin移动的时候都需要对bin锁定。但是，因为其他线程可以加入并帮助调整大小而不是争用锁，总耗时会更多(多线程帮助扩容)。扩容时还必须确保旧表和新表中的所有可访问的bin都可以被任何遍历使用更多细节看<code>TableStack</code>、 <code>Traverser</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The element count is maintained using a specialization of</span></span><br><span class="line"><span class="comment"> * LongAdder. We need to incorporate a specialization rather than</span></span><br><span class="line"><span class="comment"> * just use a LongAdder in order to access implicit</span></span><br><span class="line"><span class="comment"> * contention-sensing that leads to creation of multiple</span></span><br><span class="line"><span class="comment"> * CounterCells.  The counter mechanics avoid contention on</span></span><br><span class="line"><span class="comment"> * updates but can encounter cache thrashing if read too</span></span><br><span class="line"><span class="comment"> * frequently during concurrent access. To avoid reading so often,</span></span><br><span class="line"><span class="comment"> * resizing under contention is attempted only upon adding to a</span></span><br><span class="line"><span class="comment"> * bin already holding two or more nodes. Under uniform hash</span></span><br><span class="line"><span class="comment"> * distributions, the probability of this occurring at threshold</span></span><br><span class="line"><span class="comment"> * is around 13%, meaning that only about 1 in 8 puts check</span></span><br><span class="line"><span class="comment"> * threshold (and after resizing, many fewer do so).</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    使用<code>LongAdder</code> 来统计元素的个数</p>
<h4 id="TreeBins"><a href="#TreeBins" class="headerlink" title="TreeBins"></a>TreeBins</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * TreeBins use a special form of comparison for search and</span></span><br><span class="line"><span class="comment"> * related operations (which is the main reason we cannot use</span></span><br><span class="line"><span class="comment"> * existing collections such as TreeMaps). TreeBins contain</span></span><br><span class="line"><span class="comment"> * Comparable elements, but may contain others, as well as</span></span><br><span class="line"><span class="comment"> * elements that are Comparable but not necessarily Comparable for</span></span><br><span class="line"><span class="comment"> * the same T, so we cannot invoke compareTo among them. To handle</span></span><br><span class="line"><span class="comment"> * this, the tree is ordered primarily by hash value, then by</span></span><br><span class="line"><span class="comment"> * Comparable.compareTo order if applicable.  On lookup at a node,</span></span><br><span class="line"><span class="comment"> * if elements are not comparable or compare as 0 then both left</span></span><br><span class="line"><span class="comment"> * and right children may need to be searched in the case of tied</span></span><br><span class="line"><span class="comment"> * hash values. (This corresponds to the full list search that</span></span><br><span class="line"><span class="comment"> * would be necessary if all elements were non-Comparable and had</span></span><br><span class="line"><span class="comment"> * tied hashes.) On insertion, to keep a total ordering (or as</span></span><br><span class="line"><span class="comment"> * close as is required here) across rebalancings, we compare</span></span><br><span class="line"><span class="comment"> * classes and identityHashCodes as tie-breakers. The red-black</span></span><br><span class="line"><span class="comment"> * balancing code is updated from pre-jdk-collections</span></span><br><span class="line"><span class="comment"> * (http://gee.cs.oswego.edu/dl/classes/collections/RBCell.java)</span></span><br><span class="line"><span class="comment"> * based in turn on Cormen, Leiserson, and Rivest "Introduction to</span></span><br><span class="line"><span class="comment"> * Algorithms" (CLR).</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * TreeBins also require an additional locking mechanism.  While</span></span><br><span class="line"><span class="comment"> * list traversal is always possible by readers even during</span></span><br><span class="line"><span class="comment"> * updates, tree traversal is not, mainly because of tree-rotations</span></span><br><span class="line"><span class="comment"> * that may change the root node and/or its linkages.  TreeBins</span></span><br><span class="line"><span class="comment"> * include a simple read-write lock mechanism parasitic on the</span></span><br><span class="line"><span class="comment"> * main bin-synchronization strategy: Structural adjustments</span></span><br><span class="line"><span class="comment"> * associated with an insertion or removal are already bin-locked</span></span><br><span class="line"><span class="comment"> * (and so cannot conflict with other writers) but must wait for</span></span><br><span class="line"><span class="comment"> * ongoing readers to finish. Since there can be only one such</span></span><br><span class="line"><span class="comment"> * waiter, we use a simple scheme using a single "waiter" field to</span></span><br><span class="line"><span class="comment"> * block writers.  However, readers need never block.  If the root</span></span><br><span class="line"><span class="comment"> * lock is held, they proceed along the slow traversal path (via</span></span><br><span class="line"><span class="comment"> * next-pointers) until the lock becomes available or the list is</span></span><br><span class="line"><span class="comment"> * exhausted, whichever comes first. These cases are not fast, but</span></span><br><span class="line"><span class="comment"> * maximize aggregate expected throughput.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    TreeBins , On insertion, to keep a total ordering (or as close as is required here) across rebalancings, we compare classes and identityHashCodes as tie-breakers.</p>
<p>​    TreeBins还需要额外的锁定机制。 尽管在更新期间readers总是可以进行列表遍历，但是树遍历不是，主要是因为可以改变根节点和/或其链接的树旋转。使用读写锁实现,读不会阻塞</p>
<h4 id="baggage"><a href="#baggage" class="headerlink" title="baggage"></a>baggage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*     </span></span><br><span class="line"><span class="comment"> * Maintaining API and serialization compatibility with previous</span></span><br><span class="line"><span class="comment"> * versions of this class introduces several oddities. Mainly: We</span></span><br><span class="line"><span class="comment"> * leave untouched but unused constructor arguments refering to</span></span><br><span class="line"><span class="comment"> * concurrencyLevel. We accept a loadFactor constructor argument,</span></span><br><span class="line"><span class="comment"> * but apply it only to initial table capacity (which is the only</span></span><br><span class="line"><span class="comment"> * time that we can guarantee to honor it.) We also declare an</span></span><br><span class="line"><span class="comment"> * unused "Segment" class that is instantiated in minimal form</span></span><br><span class="line"><span class="comment"> * only when serializing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Also, solely for compatibility with previous versions of this</span></span><br><span class="line"><span class="comment"> * class, it extends AbstractMap, even though all of its methods</span></span><br><span class="line"><span class="comment"> * are overridden, so it is just useless baggage.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>一些兼容API ,  concurrencyLevel ,loadFactor,Segment (1.7的实现分段锁) , 继承了AbstractMap,但重写了所有方法</p>
<h3 id="Sources-Code"><a href="#Sources-Code" class="headerlink" title="Sources Code"></a>Sources Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*     </span></span><br><span class="line"><span class="comment"> * This file is organized to make things a little easier to follow</span></span><br><span class="line"><span class="comment"> * while reading than they might otherwise: First the main static</span></span><br><span class="line"><span class="comment"> * declarations and utilities, then fields, then main public</span></span><br><span class="line"><span class="comment"> * methods (with a few factorings of multiple public methods into</span></span><br><span class="line"><span class="comment"> * internal ones), then sizing methods, trees, traversers, and</span></span><br><span class="line"><span class="comment"> * bulk operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>​    ConcurrentHashMap 的源码可读性非常高,按照如上方式组织代码</p>
<h4 id="main-declarations"><a href="#main-declarations" class="headerlink" title="main declarations"></a>main declarations</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认bin数组的大小，必须为2的n次方</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;            </span><br><span class="line"></span><br><span class="line"><span class="comment">//默认装填因子</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当bin中大于8个node时，将此bin由list转换为tree</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//tree退化</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//大于64个bucket了，才会考虑tree化</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//to place bounds on some sizings</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** For serialization compatibility.  兼容*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = &#123;</span><br><span class="line">   <span class="keyword">new</span> ObjectStreamField(<span class="string">"segments"</span>, Segment[].class),</span><br><span class="line">   <span class="keyword">new</span> ObjectStreamField(<span class="string">"segmentMask"</span>, Integer.TYPE),</span><br><span class="line">   <span class="keyword">new</span> ObjectStreamField(<span class="string">"segmentShift"</span>, Integer.TYPE)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//兼容</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CONCURRENCY_LEVEL = <span class="number">16</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br></pre></td></tr></table></figure>
<h4 id="Node-1"><a href="#Node-1" class="headerlink" title="Node"></a>Node</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V val;</span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + val; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        Object k, v, u; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">        <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (k == key || k.equals(key)) &amp;&amp;</span><br><span class="line">                (v == (u = val) || v.equals(u)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Virtualized support for map.get(); overridden in subclasses.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; e = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                K ek;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Static-utilities"><a href="#Static-utilities" class="headerlink" title="Static utilities"></a>Static utilities</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Spreads (XORs) higher bits of hash to lower and also forces top</span></span><br><span class="line"><span class="comment"> * bit to 0. Because the table uses power-of-two masking, sets of</span></span><br><span class="line"><span class="comment"> * hashes that vary only in bits above the current mask will</span></span><br><span class="line"><span class="comment"> * always collide. (Among known examples are sets of Float keys</span></span><br><span class="line"><span class="comment"> * holding consecutive whole numbers in small tables.)  So we</span></span><br><span class="line"><span class="comment"> * apply a transform that spreads the impact of higher bits</span></span><br><span class="line"><span class="comment"> * downward. There is a tradeoff between speed, utility, and</span></span><br><span class="line"><span class="comment"> * quality of bit-spreading. Because many common sets of hashes</span></span><br><span class="line"><span class="comment"> * are already reasonably distributed (so don't benefit from</span></span><br><span class="line"><span class="comment"> * spreading), and because we use trees to handle large sets of</span></span><br><span class="line"><span class="comment"> * collisions in bins, we just XOR some shifted bits in the</span></span><br><span class="line"><span class="comment"> * cheapest possible way to reduce systematic lossage, as well as</span></span><br><span class="line"><span class="comment"> * to incorporate impact of the highest bits that would otherwise</span></span><br><span class="line"><span class="comment"> * never be used in index calculations because of table bounds.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a power of two table size for the given desired capacity.</span></span><br><span class="line"><span class="comment"> * See Hackers Delight, sec 3.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns x's Class if it is of the form "class C implements</span></span><br><span class="line"><span class="comment"> * Comparable&lt;C&gt;", else null.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line">    <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line">        Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line">        <span class="keyword">if</span> ((c = x.getClass()) == String.class) <span class="comment">// bypass checks</span></span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;</span><br><span class="line">                    ((p = (ParameterizedType)t).getRawType() ==</span><br><span class="line">                     Comparable.class) &amp;&amp;</span><br><span class="line">                    (as = p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c) <span class="comment">// type arg is c</span></span><br><span class="line">                    <span class="keyword">return</span> c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns k.compareTo(x) if x matches kc (k's screened comparable</span></span><br><span class="line"><span class="comment"> * class), else 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;) <span class="comment">// for cast to Comparable</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareComparables</span><span class="params">(Class&lt;?&gt; kc, Object k, Object x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x == <span class="keyword">null</span> || x.getClass() != kc ? <span class="number">0</span> :</span><br><span class="line">            ((Comparable)k).compareTo(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Main-public-methods"><a href="#Main-public-methods" class="headerlink" title="Main public methods"></a>Main public methods</h4><h5 id="Construct"><a href="#Construct" class="headerlink" title="Construct"></a>Construct</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with the default initial table size (16).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with an initial table size</span></span><br><span class="line"><span class="comment"> * accommodating the specified number of elements without the need</span></span><br><span class="line"><span class="comment"> * to dynamically resize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new map with the same mappings as the given map.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">    putAll(m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with an initial table size based on</span></span><br><span class="line"><span class="comment"> * the given number of elements (&#123;<span class="doctag">@code</span> initialCapacity&#125;) and</span></span><br><span class="line"><span class="comment"> * initial table density (&#123;<span class="doctag">@code</span> loadFactor&#125;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class="line"><span class="comment"> * performs internal sizing to accommodate this many elements,</span></span><br><span class="line"><span class="comment"> * given the specified load factor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loadFactor the load factor (table density) for</span></span><br><span class="line"><span class="comment"> * establishing the initial table size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class="line"><span class="comment"> * elements is negative or the load factor is nonpositive</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, loadFactor, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with an initial table size based on</span></span><br><span class="line"><span class="comment"> * the given number of elements (&#123;<span class="doctag">@code</span> initialCapacity&#125;), table</span></span><br><span class="line"><span class="comment"> * density (&#123;<span class="doctag">@code</span> loadFactor&#125;), and number of concurrently</span></span><br><span class="line"><span class="comment"> * updating threads (&#123;<span class="doctag">@code</span> concurrencyLevel&#125;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class="line"><span class="comment"> * performs internal sizing to accommodate this many elements,</span></span><br><span class="line"><span class="comment"> * given the specified load factor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loadFactor the load factor (table density) for</span></span><br><span class="line"><span class="comment"> * establishing the initial table size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> concurrencyLevel the estimated number of concurrently</span></span><br><span class="line"><span class="comment"> * updating threads. The implementation may use this value as</span></span><br><span class="line"><span class="comment"> * a sizing hint.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is</span></span><br><span class="line"><span class="comment"> * negative or the load factor or concurrencyLevel are</span></span><br><span class="line"><span class="comment"> * nonpositive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Size"><a href="#Size" class="headerlink" title="Size"></a>Size</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> n = sumCount();</span><br><span class="line">    <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">            (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">            (<span class="keyword">int</span>)n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ---------------- Counter support -------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment"> * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(key) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; </span><br><span class="line">    Node&lt;K,V&gt; e, p; </span><br><span class="line">    <span class="keyword">int</span> n, eh; </span><br><span class="line">    K ek;</span><br><span class="line">    <span class="comment">//通过位运算取得bit高位来使key分布更均匀,当key=null时，会抛出空指针异常</span></span><br><span class="line">    <span class="keyword">int</span> h = spread(key.hashCode());    </span><br><span class="line">                                                            </span><br><span class="line">    <span class="comment">//e 取得bin中的first node</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp; (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;                                      </span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历链表</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;      </span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Put"><a href="#Put" class="headerlink" title="Put"></a>Put</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">   	     <span class="comment">//延迟初始化</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();   </span><br><span class="line">   				     <span class="comment">//当向empty bin 中添加node时，并不使用锁，而使用CAS操作来添加</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处于扩容状态,帮助扩容</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">       	     <span class="comment">//锁住bin节点</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//先插入再转换成tree</span></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到ConcurrentHashMap 为了提高性能做了很多事情</p>
<ul>
<li>​    只有哈希冲突才会锁住bin,否则使用CAS </li>
<li>​    多线程帮助扩容</li>
<li>​    当链表过长树化,提高查询速度,防止锁住时间过长    </li>
</ul>
<p>More details to continues …..</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/juc/" rel="tag"># juc</a>
          
            <a href="/tags/map/" rel="tag"># map</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/19/JVM-Garbage-Collection/" rel="next" title="JVM_Garbage Collection">
                <i class="fa fa-chevron-left"></i> JVM_Garbage Collection
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/26/Overview_Elasticsearch/" rel="prev" title="Overview_Elasticsearch">
                Overview_Elasticsearch <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MzM0Ny8xOTg4OA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="zhengyumin">
            
              <p class="site-author-name" itemprop="name">zhengyumin</p>
              <div class="site-description motion-element" itemprop="description">为了将事情做好，首先你得喜欢做这件事，而不是喜欢这件事的结果，那仅仅是第二位。</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Zyumin" title="GitHub &rarr; https://github.com/Zyumin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#preface"><span class="nav-number">1.</span> <span class="nav-text">preface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Map-Implementations"><span class="nav-number">2.</span> <span class="nav-text">Map Implementations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#General-Purpose-Map-Implementations"><span class="nav-number">2.1.</span> <span class="nav-text">General-Purpose Map Implementations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Special-Purpose-Map-Implementations"><span class="nav-number">2.2.</span> <span class="nav-text">Special-Purpose Map Implementations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Concurrent-Map-Implementations"><span class="nav-number">2.3.</span> <span class="nav-text">Concurrent Map Implementations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConcurrentHashMap"><span class="nav-number">3.</span> <span class="nav-text">ConcurrentHashMap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview"><span class="nav-number">3.1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Design-golds"><span class="nav-number">3.1.1.</span> <span class="nav-text">Design golds</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Node"><span class="nav-number">3.1.2.</span> <span class="nav-text">Node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hash-conflict"><span class="nav-number">3.1.3.</span> <span class="nav-text">hash conflict</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resized"><span class="nav-number">3.1.4.</span> <span class="nav-text">resized</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TreeBins"><span class="nav-number">3.1.5.</span> <span class="nav-text">TreeBins</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#baggage"><span class="nav-number">3.1.6.</span> <span class="nav-text">baggage</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sources-Code"><span class="nav-number">3.2.</span> <span class="nav-text">Sources Code</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main-declarations"><span class="nav-number">3.2.1.</span> <span class="nav-text">main declarations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Node-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">Node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Static-utilities"><span class="nav-number">3.2.3.</span> <span class="nav-text">Static utilities</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Main-public-methods"><span class="nav-number">3.2.4.</span> <span class="nav-text">Main public methods</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Construct"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">Construct</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Size"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">Size</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Get"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">Get</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Put"><span class="nav-number">3.2.4.4.</span> <span class="nav-text">Put</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengyumin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">477k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">7:14</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  
    <script>
  window.livereOptions = {
    refer: '2019/06/24/J-U-C-ConcurrentHashMap/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  




  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'D2GGMftjnaihnt6xGsBOCK1T-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'D2GGMftjnaihnt6xGsBOCK1T-gzGzoHsz',
                'X-LC-Key': '42G22rkOJK422bv0XSJhBrW6',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
