<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="阅读的目的？我想要从中获得什么？ ​    对springmvc 流程对分析，代码的分析总结">
<meta name="keywords" content="spring,servlet,spring-mvc,spring-webflux">
<meta property="og:type" content="article">
<meta property="og:title" content="servlet_spring-mvc">
<meta property="og:url" content="http://yoursite.com/2019/02/03/servlet-springmvc/index.html">
<meta property="og:site_name" content="Zyumin">
<meta property="og:description" content="阅读的目的？我想要从中获得什么？ ​    对springmvc 流程对分析，代码的分析总结">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/006tNbRwgy1fyc0ein61sj31m20u0adx.jpg">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwly1fyc839v8vdj31l20u043g.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNbRwly1fyc7lnlrzmj318o0u042e.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNbRwly1fydcs34e4rj31y60qu11o.jpg">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwly1fyc6u9xp9nj30zn0u0ag3.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNbRwly1fycat4mrudj310q0u043a.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNbRwly1fycdyq4kmxj31ta0u0ahy.jpg">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwly1fyce346qynj30zc0u0q9t.jpg">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwgy1fybvzj6p72j30u00ynju2.jpg">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNbRwly1fydgk0syd0j30u019f7aj.jpg">
<meta property="og:image" content="https://ws2.sinaimg.cn/large/006tNbRwly1fydgqk142nj31bm0pawie.jpg">
<meta property="og:updated_time" content="2019-03-23T03:50:14.354Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="servlet_spring-mvc">
<meta name="twitter:description" content="阅读的目的？我想要从中获得什么？ ​    对springmvc 流程对分析，代码的分析总结">
<meta name="twitter:image" content="https://ws3.sinaimg.cn/large/006tNbRwgy1fyc0ein61sj31m20u0adx.jpg">






  <link rel="canonical" href="http://yoursite.com/2019/02/03/servlet-springmvc/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>servlet_spring-mvc | Zyumin</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/Zyumin"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full 		size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemsope="" itemtype="http://schema.org/WPHeader">
	  <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zyumin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">保持自驱和热情</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/03/servlet-springmvc/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhengyumin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zyumin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">servlet_spring-mvc

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-03 15:50:16" itemprop="dateCreated datePublished" datetime="2019-02-03T15:50:16+08:00">2019-02-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-23 11:50:14" itemprop="dateModified" datetime="2019-03-23T11:50:14+08:00">2019-03-23</time>
              
            
          </span>

          

          
            
            
          

          
          
            <span id="/2019/02/03/servlet-springmvc/" class="leancloud_visitors" data-flag-title="servlet_spring-mvc">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article"></span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time"></span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>阅读的目的？我想要从中获得什么？</p>
<p>​    对springmvc 流程对分析，代码的分析总结</p>
<a id="more"></a>
<!-- toc -->
<ul>
<li><a href="#1-springmvc-核心servlet-dispatcherservlet">1. springMVC 核心servlet —DispatcherServlet</a><ul>
<li><a href="#11-整体结构">1.1 整体结构</a></li>
<li><a href="#12-创建过程">1.2 创建过程</a><ul>
<li><a href="#121-httpservletbean的创建">1.2.1 HttpServletBean的创建</a></li>
<li><a href="#122-framewordkservlet的创建">1.2.2 FramewordkServlet的创建</a></li>
<li><a href="#123-dispatcherservlet的创建">1.2.3 DispatcherServlet的创建</a></li>
</ul>
</li>
<li><a href="#13-组件概览">1.3 组件概览</a><ul>
<li><a href="#131-handlermapping">1.3.1 HandlerMapping</a></li>
<li><a href="#132-handleradapter">1.3.2 HandlerAdapter</a></li>
<li><a href="#133-handlerexceptionresolver">1.3.3 HandlerExceptionResolver</a></li>
<li><a href="#134-viewresolver">1.3.4 ViewResolver</a></li>
<li><a href="#135-requesttoviewnametranslator">1.3.5 RequestToViewNameTranslator</a></li>
<li><a href="#136-localeresolver">1.3.6 LocaleResolver</a></li>
<li><a href="#137-themeresolver">1.3.7 ThemeResolver</a></li>
<li><a href="#138-multipartresolver">1.3.8 MultipartResolver</a></li>
<li><a href="#139-flashmapmanager">1.3.9 FlashMapManager</a></li>
</ul>
</li>
<li><a href="#14-处理请求">1.4 处理请求</a><ul>
<li><a href="#141-frameworkservlet">1.4.1 FrameworkServlet</a></li>
<li><a href="#142-dispatcherservlet">1.4.2 DispatcherServlet</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-异步请求">2. 异步请求</a><ul>
<li><a href="#21-servlet异步支持">2.1 servlet异步支持</a><ul>
<li><a href="#211servletrequest">2.1.1ServletRequest</a></li>
<li><a href="#212-异步容器asynccontext">2.1.2 异步容器AsyncContext</a></li>
<li><a href="#213-asynclistener监听器">2.1.3 AsyncListener监听器</a></li>
</ul>
</li>
<li><a href="#22-springmvc中的相关组件">2.2 SpringMVC中的相关组件</a><ul>
<li><a href="#221-asyncwebrequest">2.2.1 AsyncWebRequest</a></li>
<li><a href="#222-webasyncmanager">2.2.2 WebAsyncManager</a></li>
<li><a href="#223-webasyncutils">2.2.3 WebAsyncUtils</a></li>
</ul>
</li>
<li><a href="#23-springmvc中请求的支持">2.3 SpringMVC中请求的支持</a></li>
<li><a href="#24-springwebflux-待补充">2.4 SpringWebFlux  ==待补充==</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<hr>
<h4><span id="1-springmvc-核心servlet-dispatcherservlet">1. springMVC 核心servlet —DispatcherServlet</span></h4><p>​    <code>基于spring-webmvc 4.0.3.RELEASE</code></p>
<h5><span id="11-整体结构">1.1 整体结构</span></h5><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fyc0ein61sj31m20u0adx.jpg" alt="image-20181219135235499"></p>
<blockquote>
<p>Aware：如果某个类想使用Spring的一些东西，就可以实现Aware接口</p>
<p>Capable:具有spring某个类的能力</p>
</blockquote>
<h5><span id="12-创建过程">1.2 创建过程</span></h5><h6><span id="121-httpservletbean的创建">1.2.1 HttpServletBean的创建</span></h6><p>​        实现了<code>EnvironmentCapable</code>、<code>EnvironmentAware</code> ，主要作用是将Servlet中配置的参数设置到相应的</p>
<h6><span id="122-framewordkservlet的创建">1.2.2 FramewordkServlet的创建</span></h6><p>​        实现了<code>ApplicationContextAware</code>，其主要作用是调用<code>initWebApplicationContext()</code>初始化<code>WebApplicationContext</code></p>
<ul>
<li>获取spring的根工期rootContext</li>
<li>设置webApplicationContext并根据情况调用onRefresh方法</li>
<li>将WebApplicationContext设置到ServletContext中            </li>
</ul>
<h6><span id="123-dispatcherservlet的创建">1.2.3 DispatcherServlet的创建</span></h6><p>​    onRefresh方法是DispatcherServlet的入口方法，onRefresh中调用了initStrategies()方法来初始化一些策略组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.initStrategies(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the strategy objects that this servlet uses.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;May be overridden in subclasses in order to initialize further strategy objects.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">    initMultipartResolver(context);</span><br><span class="line">    initLocaleResolver(context);</span><br><span class="line">    initThemeResolver(context);</span><br><span class="line">    initHandlerMappings(context);</span><br><span class="line">    initHandlerAdapters(context);</span><br><span class="line">    initHandlerExceptionResolvers(context);</span><br><span class="line">    initRequestToViewNameTranslator(context);</span><br><span class="line">    initViewResolvers(context);</span><br><span class="line">    initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有配置相关，会使用默认的配置，在DispatcherServlet.properties文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Default implementation classes for DispatcherServlet&apos;s strategy interfaces.</span><br><span class="line"># Used as fallback when no matching beans are found in the DispatcherServlet context.</span><br><span class="line"># Not meant to be customized by application developers.</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.LocaleResolver=org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ThemeResolver=org.springframework.web.servlet.theme.FixedThemeResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerMapping=org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerAdapter=org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter,\</span><br><span class="line">   org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerExceptionResolver=org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerExceptionResolver,\</span><br><span class="line">   org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver,\</span><br><span class="line">   org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.RequestToViewNameTranslator=org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ViewResolver=org.springframework.web.servlet.view.InternalResourceViewResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.FlashMapManager=org.springframework.web.servlet.support.SessionFlashMapManager</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips：If no bean is defined with the given name in the BeanFactory for this namespace, no multipart handling is provided.</p>
</blockquote>
<h5><span id="13-组件概览">1.3 组件概览</span></h5><h6><span id="131-handlermapping">1.3.1 HandlerMapping</span></h6><p>​    它的作用是根据request找到对应的处理器handler和Interceptors ,首先看下接口信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects that define a mapping between</span></span><br><span class="line"><span class="comment"> * requests and handler objects.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.core.Ordered</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.AbstractHandlerMapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.SimpleUrlHandlerMapping</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMapping</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   String PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".pathWithinHandlerMapping"</span>;</span><br><span class="line"></span><br><span class="line">   String BEST_MATCHING_PATTERN_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".bestMatchingPattern"</span>;</span><br><span class="line"></span><br><span class="line">   String INTROSPECT_TYPE_LEVEL_MAPPING = HandlerMapping.class.getName() + <span class="string">".introspectTypeLevelMapping"</span>;</span><br><span class="line"></span><br><span class="line">   String URI_TEMPLATE_VARIABLES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".uriTemplateVariables"</span>;</span><br><span class="line"></span><br><span class="line">   String MATRIX_VARIABLES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".matrixVariables"</span>;</span><br><span class="line"></span><br><span class="line">   String PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE = HandlerMapping.class.getName() + <span class="string">".producibleMediaTypes"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Return a handler and any interceptors for this request. The choice may be made</span></span><br><span class="line"><span class="comment">    * on request URL, session state, or any factor the implementing class chooses.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;The returned HandlerExecutionChain contains a handler Object, rather than</span></span><br><span class="line"><span class="comment">    * even a tag interface, so that handlers are not constrained in any way.</span></span><br><span class="line"><span class="comment">    * For example, a HandlerAdapter could be written to allow another framework's</span></span><br><span class="line"><span class="comment">    * handler objects to be used.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Returns &#123;<span class="doctag">@code</span> null&#125; if no match was found. This is not an error.</span></span><br><span class="line"><span class="comment">    * The DispatcherServlet will query all registered HandlerMapping beans to find</span></span><br><span class="line"><span class="comment">    * a match, and only decide there is an error if none can find a handler.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a HandlerExecutionChain instance containing handler object and</span></span><br><span class="line"><span class="comment">    * any interceptors, or &#123;<span class="doctag">@code</span> null&#125; if no mapping found</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if there is an internal error</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以常用接口实现为例，RequestMappingHandlerMapping</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyc839v8vdj31l20u043g.jpg" alt="image-20181219181838287"></p>
<blockquote>
<p>这里提供了Ordered接口，可以确定匹配的顺序，同时通过继承WebApplicationObjectSupport抽象类，可以获取相关Bean（handler）,更多细节可查看 类AbstractHandlerMapping。</p>
</blockquote>
<h6><span id="132-handleradapter">1.3.2 HandlerAdapter</span></h6><p>​    之所以要使用HandlerAdapter，是为SpringMVC中并没有对处理器做任何的限制，可以是个类，方法（HandlerMethod）这点从hanlder是Object就可以看出，首先是接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVC framework SPI interface, allowing parameterization of core MVC workflow.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Interface that must be implemented for each handler type to handle a request.</span></span><br><span class="line"><span class="comment"> * This interface is used to allow the &#123;<span class="doctag">@link</span> DispatcherServlet&#125; to be indefinitely</span></span><br><span class="line"><span class="comment"> * extensible. The DispatcherServlet accesses all installed handlers through this</span></span><br><span class="line"><span class="comment"> * interface, meaning that it does not contain code specific to any handler type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note that a handler can be of type &#123;<span class="doctag">@code</span> Object&#125;. This is to enable</span></span><br><span class="line"><span class="comment"> * handlers from other frameworks to be integrated with this framework without</span></span><br><span class="line"><span class="comment"> * custom coding, as well as to allow for annotation handler objects that do</span></span><br><span class="line"><span class="comment"> * not obey any specific Java interface.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This interface is not intended for application developers. It is available</span></span><br><span class="line"><span class="comment"> * to handlers who want to develop their own web workflow.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: HandlerAdaptger implementators may implement the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.core.Ordered&#125; interface to be able to specify a</span></span><br><span class="line"><span class="comment"> * sorting order (and thus a priority) for getting applied by DispatcherServlet.</span></span><br><span class="line"><span class="comment"> * Non-Ordered instances get treated as lowest priority.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.handler.SimpleServletHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Given a handler instance, return whether or not this HandlerAdapter can</span></span><br><span class="line"><span class="comment">    * support it. Typical HandlerAdapters will base the decision on the handler</span></span><br><span class="line"><span class="comment">    * type. HandlerAdapters will usually only support one handler type each.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;A typical implementation:</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">    * return (handler instanceof MyHandler);</span></span><br><span class="line"><span class="comment">    * &#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler object to check</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> whether or not this object can use the given handler</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Use the given handler to handle this request.</span></span><br><span class="line"><span class="comment">    * The workflow that is required may vary widely.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler to use. This object must have previously been passed</span></span><br><span class="line"><span class="comment">    * to the &#123;<span class="doctag">@code</span> supports&#125; method of this interface, which must have</span></span><br><span class="line"><span class="comment">    * returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ModelAndView object with the name of the view and the required</span></span><br><span class="line"><span class="comment">    * model data, or &#123;<span class="doctag">@code</span> null&#125; if the request has been handled directly</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Same contract as for HttpServlet's &#123;<span class="doctag">@code</span> getLastModified&#125; method.</span></span><br><span class="line"><span class="comment">    * Can simply return -1 if there's no support in the handler class.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler handler to use</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the lastModified value for the given handler</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServlet#getLastModified</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> org.springframework.web.servlet.mvc.LastModified#getLastModified</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中一个实现类<code>SimpleControllerHandlerAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.mvc;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adapter to use the plain &#123;<span class="doctag">@link</span> Controller&#125; workflow interface with</span></span><br><span class="line"><span class="comment"> * the generic &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;.</span></span><br><span class="line"><span class="comment"> * Supports handlers that implement the &#123;<span class="doctag">@link</span> LastModified&#125; interface.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This is an SPI class, not used directly by application code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.DispatcherServlet</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Controller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> LastModified</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> HttpRequestHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleControllerHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">HandlerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (handler <span class="keyword">instanceof</span> Controller);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ((Controller) handler).handleRequest(request, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> LastModified) &#123;</span><br><span class="line">         <span class="keyword">return</span> ((LastModified) handler).getLastModified(request);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般默认使用的是 RequestMappingHandlerAdapter ,在其父类中有这样一句设置Order</p>
<p><code>private int order = Ordered.LOWEST_PRECEDENCE;</code></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fyc7lnlrzmj318o0u042e.jpg" alt="image-20181219180136155"></p>
<blockquote>
<p>HandlerAdapter implementators may implement the Order，使用时候是遍历 handlerAdapters ，调用supports判断直接返回（除了设置的，默认的实现有3个）。注意Order是越低优先级越高的。更多细节可以查看#afterPropertiesSet()方法</p>
</blockquote>
<p>总结一下，主要做了三件事，解析参数、执行请求，处理返回结果</p>
<ul>
<li>解析参数的过程中用到的参数来源有多个，大体可分为两类，一类是从Model来的（通过FlashMapManager和ModelFactory），另一类是从Request来的, 具体使用HandlerMethodArgumentResolver进行解析（有的是@InitBinder WebDataBinder）</li>
<li>执行请求的是用HandlerMethod的子类ServletInvocableHandlerMethod</li>
<li>返回值用HandlerMethodReturnValueHandler进行解析。</li>
</ul>
<p>另外，整个处理过程中ModelAndViewContainer起着参数传递的作用。</p>
<p>​    这里还有一个需要注意的，就是<code>RequestMappingHandlerAdapter</code> 是怎么注入的，通过debug发现，默认的实现HandlerAdapter 有 3个 ,除了前者还有<code>HttpRequestHandlerAdapte</code>、<code>SimpleControllerHandlerAdapte</code>的，<a href="https://docs.spring.io/spring/docs/3.2.10.RELEASE/spring-framework-reference/html/mvc.html#mvc-config-enable" target="_blank" rel="noopener">通过查询官方文档发现</a>，只要在配置文件配置了<code>mvc:annotation-driven</code> ，会自动生成相关@RequestMapping的类。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fydcs34e4rj31y60qu11o.jpg" alt="image-20181220174621313"></p>
<blockquote>
<p>官方文档的截图</p>
</blockquote>
<h6><span id="133-handlerexceptionresolver">1.3.3 HandlerExceptionResolver</span></h6><p>​    根据异常设置ModelAndView，之后交给render方法去渲染，这里要注意它是在render之前工作，所以只作用于解析对请求做处理过程中的产生的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects than can resolve exceptions thrown</span></span><br><span class="line"><span class="comment"> * during handler mapping or execution, in the typical case to error views.</span></span><br><span class="line"><span class="comment"> * Implementors are typically registered as beans in the application context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Error views are analogous to the error page JSPs, but can be used with</span></span><br><span class="line"><span class="comment"> * any kind of exception including any checked exception, with potentially</span></span><br><span class="line"><span class="comment"> * fine-granular mappings for specific handlers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 22.11.2003</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Try to resolve the given exception that got thrown during on handler execution,</span></span><br><span class="line"><span class="comment">    * returning a ModelAndView that represents a specific error page if appropriate.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;The returned ModelAndView may be &#123;<span class="doctag">@linkplain</span> ModelAndView#isEmpty() empty&#125;</span></span><br><span class="line"><span class="comment">    * to indicate that the exception has been resolved successfully but that no view</span></span><br><span class="line"><span class="comment">    * should be rendered, for instance by setting a status code.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler the executed handler, or &#123;<span class="doctag">@code</span> null&#125; if none chosen at the</span></span><br><span class="line"><span class="comment">    * time of the exception (for example, if multipart resolution failed)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ex the exception that got thrown during handler execution</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a corresponding ModelAndView to forward to,</span></span><br><span class="line"><span class="comment">    * or &#123;<span class="doctag">@code</span> null&#125; for default processing</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实现SimpleMappingExceptionResolver 可以通过扩展配置，设置自定义类型</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyc6u9xp9nj30zn0u0ag3.jpg" alt="image-20181219173520333"></p>
<blockquote>
<p>可以配合定制自定义Exception，前端统一展示等</p>
</blockquote>
<h6><span id="134-viewresolver">1.3.4 ViewResolver</span></h6><p>​    通过viewName来找到 对应的View，View是用来渲染页面的，主要解决用什么模版和用什么规则填入参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface to be implemented by objects that can resolve views by name.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;View state doesn't change during the running of the application,</span></span><br><span class="line"><span class="comment"> * so implementations are free to cache views.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Implementations are encouraged to support internationalization,</span></span><br><span class="line"><span class="comment"> * i.e. localized view resolution.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rod Johnson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.InternalResourceViewResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.ResourceBundleViewResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.view.XmlViewResolver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Resolve the given view by name.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Note: To allow for ViewResolver chaining, a ViewResolver should</span></span><br><span class="line"><span class="comment">    * return &#123;<span class="doctag">@code</span> null&#125; if a view with the given name is not defined in it.</span></span><br><span class="line"><span class="comment">    * However, this is not required: Some ViewResolvers will always attempt</span></span><br><span class="line"><span class="comment">    * to build View objects with the given name, unable to return &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    * (rather throwing an exception when View creation failed).</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> viewName name of the view to resolve</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> locale Locale in which to resolve the view.</span></span><br><span class="line"><span class="comment">    * ViewResolvers that support internationalization should respect this.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the View object, or &#123;<span class="doctag">@code</span> null&#125; if not found</span></span><br><span class="line"><span class="comment">    * (optional, to allow for ViewResolver chaining)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception if the view cannot be resolved</span></span><br><span class="line"><span class="comment">    * (typically in case of problems creating an actual View object)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用的jsp解析</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fycat4mrudj310q0u043a.jpg" alt="image-20181219195241323"></p>
<p>按照类图可以把继承<code>AbstractCachingViewResolver</code>(里面两个Map的方式值得学习)分成两类</p>
<ul>
<li><code>ResourceBundleViewResolver</code>  可以同时支持多种类型的视图，需要将每一个视图名和对应的视图类型配置到相应的properties文件中,该类的注释中，解释了其用法,</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &lt;p&gt;This &#123;@code ViewResolver&#125; supports localized view definitions,</span></span><br><span class="line"><span class="comment">* using the default support of &#123;@link java.util.PropertyResourceBundle&#125;.</span></span><br><span class="line"><span class="comment">* For example, the basename "views" will be resolved as class path resources</span></span><br><span class="line"><span class="comment">* "views_de_AT.properties", "views_de.properties", "views.properties" -</span></span><br><span class="line"><span class="comment">* for a given Locale "de_AT"./</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>UrlBasedViewResolver</code>系列的解析器都是对单一视图进行解析的，只需找到模版就行，例如</li>
</ul>
<p><code>InternalResourceViewResolver</code> 是专门用来解析jsp，<code>FreeMarkerViewResolver</code>只针对FreeMarker</p>
<blockquote>
<p>相关扩展ExecelViewResolver、SimpleMapViewResolver</p>
<p>默认实现是 InternalResourceViewResolver</p>
</blockquote>
<h6><span id="135-requesttoviewnametranslator">1.3.5 RequestToViewNameTranslator</span></h6><p>比较简单，当handler处理完后，没有View和ViewName的会调用该方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Do we need view name translation?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyDefaultViewName</span><span class="params">(HttpServletRequest request, ModelAndView mv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.hasView()) &#123;</span><br><span class="line">      mv.setViewName(getDefaultViewName(request));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Translate the supplied request into a default view name.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP servlet request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the view name (or &#123;<span class="doctag">@code</span> null&#125; if no default found)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception if view name translation failed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getDefaultViewName</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.viewNameTranslator.getViewName(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>​    默认实现是RequestToViewNameTranslator</p>
</blockquote>
<h6><span id="136-localeresolver">1.3.6 LocaleResolver</span></h6><p>​    用于从request中解析出Locale,默认实现是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.i18n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.LocaleResolver;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> LocaleResolver&#125; implementation that simply uses the primary locale</span></span><br><span class="line"><span class="comment"> * specified in the "accept-language" header of the HTTP request (that is,</span></span><br><span class="line"><span class="comment"> * the locale sent by the client browser, normally that of the client's OS).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: Does not support &#123;<span class="doctag">@code</span> setLocale&#125;, since the accept header</span></span><br><span class="line"><span class="comment"> * can only be changed through changing the client's locale settings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 27.02.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getLocale()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptHeaderLocaleResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> request.getLocale();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">            <span class="string">"Cannot change HTTP accept header - use a different locale resolution strategy"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    在DispatcherServlet#doSerive()方法中， <code>request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);</code> 放进request中，这里除了视图解析的时候需要用到，在使用国际化主题的时候也会用到</p>
<blockquote>
<p>切换相关，可查看 LocaleChangeInterceptor</p>
</blockquote>
<h6><span id="137-themeresolver">1.3.7 ThemeResolver</span></h6><p>​    SpringMVC中和主题相关的类有如下</p>
<ul>
<li>ThemeResolver 作用是从request中解析出主题名,默认实现FixedThemeResolver</li>
<li>ThemeSource 根据主题名找到对应的主题 ，默认使用WebApplicationContext</li>
<li>Theme 就是主题，包含了具体资源</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.theme;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.ThemeResolver&#125; implementation</span></span><br><span class="line"><span class="comment"> * that simply uses a fixed theme. The fixed name can be defined via</span></span><br><span class="line"><span class="comment"> * the "defaultThemeName" property; out of the box, it is "theme".</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: Does not support &#123;<span class="doctag">@code</span> setThemeName&#125;, as the fixed theme</span></span><br><span class="line"><span class="comment"> * cannot be changed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Jean-Pierre Pawlak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 17.06.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setDefaultThemeName</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedThemeResolver</span> <span class="keyword">extends</span> <span class="title">AbstractThemeResolver</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getDefaultThemeName();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot change theme - use a different theme resolution strategy"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>切换相关，可查看 ThemeChangeInterceptor</p>
</blockquote>
<h6><span id="138-multipartresolver">1.3.8 MultipartResolver</span></h6><p>​    用于处理文件上传，注意这个组件在DispatcherServlet.properties 中 没有默认实现,首先是接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.multipart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A strategy interface for multipart file upload resolution in accordance</span></span><br><span class="line"><span class="comment"> * with &lt;a href="http://www.ietf.org/rfc/rfc1867.txt"&gt;RFC 1867&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> * Implementations are typically usable both within an application context</span></span><br><span class="line"><span class="comment"> * and standalone.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;There are two concrete implementations included in Spring, as of Spring 3.1:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> org.springframework.web.multipart.commons.CommonsMultipartResolver&#125; for Jakarta Commons FileUpload</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.StandardServletMultipartResolver&#125; for Servlet 3.0 Part API</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;There is no default resolver implementation used for Spring</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet DispatcherServlets&#125;,</span></span><br><span class="line"><span class="comment"> * as an application might choose to parse its multipart requests itself. To define</span></span><br><span class="line"><span class="comment"> * an implementation, create a bean with the id "multipartResolver" in a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet DispatcherServlet's&#125;</span></span><br><span class="line"><span class="comment"> * application context. Such a resolver gets applied to all requests handled</span></span><br><span class="line"><span class="comment"> * by that &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;If a &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125; detects</span></span><br><span class="line"><span class="comment"> * a multipart request, it will resolve it via the configured</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; and pass on a</span></span><br><span class="line"><span class="comment"> * wrapped &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125;.</span></span><br><span class="line"><span class="comment"> * Controllers can then cast their given request to the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartHttpServletRequest&#125;</span></span><br><span class="line"><span class="comment"> * interface, which permits access to any</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartFile MultipartFiles&#125;.</span></span><br><span class="line"><span class="comment"> * Note that this cast is only supported in case of an actual multipart request.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre class="code"&gt;</span></span><br><span class="line"><span class="comment"> * public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) &#123;</span></span><br><span class="line"><span class="comment"> *   MultipartHttpServletRequest multipartRequest = (MultipartHttpServletRequest) request;</span></span><br><span class="line"><span class="comment"> *   MultipartFile multipartFile = multipartRequest.getFile("image");</span></span><br><span class="line"><span class="comment"> *   ...</span></span><br><span class="line"><span class="comment"> * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Instead of direct access, command or form controllers can register a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.ByteArrayMultipartFileEditor&#125;</span></span><br><span class="line"><span class="comment"> * or &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.StringMultipartFileEditor&#125;</span></span><br><span class="line"><span class="comment"> * with their data binder, to automatically apply multipart content to command</span></span><br><span class="line"><span class="comment"> * bean properties.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;As an alternative to using a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; with a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.DispatcherServlet&#125;,</span></span><br><span class="line"><span class="comment"> * a &#123;<span class="doctag">@link</span> org.springframework.web.multipart.support.MultipartFilter&#125; can be</span></span><br><span class="line"><span class="comment"> * registered in &#123;<span class="doctag">@code</span> web.xml&#125;. It will delegate to a corresponding</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; bean in the root</span></span><br><span class="line"><span class="comment"> * application context. This is mainly intended for applications that do not</span></span><br><span class="line"><span class="comment"> * use Spring's own web MVC framework.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note: There is hardly ever a need to access the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartResolver&#125; itself</span></span><br><span class="line"><span class="comment"> * from application code. It will simply do its work behind the scenes,</span></span><br><span class="line"><span class="comment"> * making</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> MultipartHttpServletRequest MultipartHttpServletRequests&#125;</span></span><br><span class="line"><span class="comment"> * available to controllers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Trevor D. Cook</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 29.09.2003</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MultipartHttpServletRequest</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MultipartFile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.commons.CommonsMultipartResolver</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.support.ByteArrayMultipartFileEditor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.multipart.support.StringMultipartFileEditor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.DispatcherServlet</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Determine if the given request contains multipart content.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Will typically check for content type "multipart/form-data", but the actually</span></span><br><span class="line"><span class="comment">    * accepted requests might depend on the capabilities of the resolver implementation.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the servlet request to be evaluated</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> whether the request contains multipart content</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isMultipart</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the given HTTP request into multipart files and parameters,</span></span><br><span class="line"><span class="comment">    * and wrap the request inside a</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> org.springframework.web.multipart.MultipartHttpServletRequest&#125; object</span></span><br><span class="line"><span class="comment">    * that provides access to file descriptors and makes contained</span></span><br><span class="line"><span class="comment">    * parameters accessible via the standard ServletRequest methods.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the servlet request to wrap (must be of a multipart content type)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the wrapped servlet request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> MultipartException if the servlet request is not multipart, or if</span></span><br><span class="line"><span class="comment">    * implementation-specific problems are encountered (such as exceeding file size limits)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFile</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFileNames</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> MultipartHttpServletRequest#getFileMap</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameter</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameterNames</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> javax.servlet.http.HttpServletRequest#getParameterMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">MultipartHttpServletRequest <span class="title">resolveMultipart</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Cleanup any resources used for the multipart handling,</span></span><br><span class="line"><span class="comment">    * like a storage for the uploaded files.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the request to cleanup resources for</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用实现CommonsMultipartResolver</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fycdyq4kmxj31ta0u0ahy.jpg" alt="image-20181219214146380"></p>
<blockquote>
<p>对于上传类型判断是 multipart/form-data</p>
<p>两种实现，一种是Servlet的标准实现StandardServletMultipartResolver 一种是Apache的commons-fileupload方式</p>
</blockquote>
<h6><span id="139-flashmapmanager">1.3.9 FlashMapManager</span></h6><p>​    FlashMap主要用于redirect中传递参数，FlashMapManage是用来管理FlashMap的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A strategy interface for retrieving and saving FlashMap instances.</span></span><br><span class="line"><span class="comment"> * See &#123;<span class="doctag">@link</span> FlashMap&#125; for a general overview of flash attributes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> FlashMap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlashMapManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Find a FlashMap saved by a previous request that matches to the current</span></span><br><span class="line"><span class="comment">    * request, remove it from underlying storage, and also remove other</span></span><br><span class="line"><span class="comment">    * expired FlashMap instances.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method is invoked in the beginning of every request in contrast</span></span><br><span class="line"><span class="comment">    * to &#123;<span class="doctag">@link</span> #saveOutputFlashMap&#125;, which is invoked only when there are</span></span><br><span class="line"><span class="comment">    * flash attributes to be saved - i.e. before a redirect.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a FlashMap matching the current request or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">FlashMap <span class="title">retrieveAndUpdate</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Save the given FlashMap, in some underlying storage and set the start</span></span><br><span class="line"><span class="comment">    * of its expiration period.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;&lt;strong&gt;<span class="doctag">NOTE:</span>&lt;/strong&gt; Invoke this method prior to a redirect in order</span></span><br><span class="line"><span class="comment">    * to allow saving the FlashMap in the HTTP session or in a response</span></span><br><span class="line"><span class="comment">    * cookie before the response is committed.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> flashMap the FlashMap to save</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">saveOutputFlashMap</span><span class="params">(FlashMap flashMap, HttpServletRequest request, HttpServletResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    两个方法，分别是retrieveAndUpdate 用于恢复参数，saveOutputFlashMap用于保存参数</p>
<p>类图也比较简单</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyce346qynj30zc0u0q9t.jpg" alt="image-20181219214559988"></p>
<blockquote>
<p>默认实现是SessionFlashMapManager</p>
</blockquote>
<p>整个redirects 的参数通过FlashMap传递的过程分三步</p>
<ol>
<li>首先，RequestMappingHandlerAapter会将其设置到<code>outputFlashMap</code>中，如果是redirect类型的返回类型值（将需要传递的参数设置到<code>outputFlashMap</code>中，也可以是RedirectAttributes类型的参数中）</li>
<li>在RedirectView中会调用<code>#saveOutputFlashMap()</code>方法，将<code>outputFlashMap</code>中的参数设置到Session</li>
<li>请求redirect后，DispatcherServlet会调有你<code>#retrieveAndUpdate()</code>方法从Session中获取<code>inputFlashMap</code>并设置到Request的属性中备用，同时从Session中删除</li>
</ol>
<h5><span id="14-处理请求">1.4 处理请求</span></h5><h6><span id="141-frameworkservlet">1.4.1 FrameworkServlet</span></h6><p>​    Servlet的处理过程，首先是从Servlet接口的service，然后在HttpServlet的service方法中根据请求的类型不同将请求路由到了doGet、doHead等方法。</p>
<p>​    FrameworkServlet中重写了doGet等方法。将请求集中到processRequest方法进行统一处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Override the parent class implementation in order to intercept PATCH</span></span><br><span class="line"><span class="comment"> * requests.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    String method = request.getMethod();</span><br><span class="line">    <span class="keyword">if</span> (method.equalsIgnoreCase(RequestMethod.PATCH.name())) &#123;</span><br><span class="line">        processRequest(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate GET requests to processRequest/doService.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Will also be invoked by HttpServlet's default implementation of &#123;<span class="doctag">@code</span> doHead&#125;,</span></span><br><span class="line"><span class="comment"> * with a &#123;<span class="doctag">@code</span> NoBodyResponse&#125; that just captures the content length.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doHead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    processRequest这个方法主要做了两件事情(当然还有doService，和对异步请求对处理)</p>
<ul>
<li>对LocaleContext（获取locale）和RequestAttributes(管理request和session属性)的设置及恢复</li>
<li>处理完后发布ServletRequestHandledEvent消息</li>
</ul>
<p>LocaleContextHolder 、RequestContextHolder </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LocaleContextHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal localeContextHolder = <span class="keyword">new</span> NamedThreadLocal(<span class="string">"Locale context"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal inheritableLocaleContextHolder = <span class="keyword">new</span> NamedInheritableThreadLocal(<span class="string">"Locale context"</span>);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里比较有意思的地方是这是个抽象类，里面的方法实现都是静态方法，只能调用不能实例化。RequestContextHolder的实现类似，封装的是ServletRequestAttributes</p>
<blockquote>
<p>这里之所以需要对LocaleContext和RequestAttributes恢复，是因为在Servlet外面可能还有别等操作，例如Filter（Spring-MVC的HandlerInterceptor）,为了不影响那些操作。</p>
</blockquote>
<h6><span id="142-dispatcherservlet">1.4.2 DispatcherServlet</span></h6><p>​    DispatcherServlet是FrameworkServlet的子类，实现了doService方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exposes the DispatcherServlet-specific request attributes and delegates to &#123;<span class="doctag">@link</span> #doDispatch&#125;</span></span><br><span class="line"><span class="comment"> * for the actual dispatching.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class="line">    <span class="comment">// to be able to restore the original attributes after the include.</span></span><br><span class="line">    Map&lt;String, Object&gt; attributesSnapshot = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">        attributesSnapshot = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">        <span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">            String attrName = (String) attrNames.nextElement();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.cleanupAfterInclude || attrName.startsWith(<span class="string">"org.springframework.web.servlet"</span>)) &#123;</span><br><span class="line">                attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make framework objects available to handlers and view objects.</span></span><br><span class="line">    request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">    request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.localeResolver);</span><br><span class="line">    request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.themeResolver);</span><br><span class="line">    request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Pass paramter use to Redirect</span></span><br><span class="line">    FlashMap inputFlashMap = <span class="keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">    <span class="keyword">if</span> (inputFlashMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">    &#125;</span><br><span class="line">    request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> FlashMap());</span><br><span class="line">    request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="keyword">this</span>.flashMapManager);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doDispatch(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class="line">        <span class="keyword">if</span> (attributesSnapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">            restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在doDispatch之前做了</p>
<ul>
<li>判断是否include请求，是的话保存快照（attributesSnapshot）</li>
<li>为request设置默认的属性，在后面的handlers和view中需要使用</li>
</ul>
<p>下面是doDispatch的方法的实现，主要的功能是 Process the actual dispatching to the handler.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the actual dispatching to the handler.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The handler will be obtained by applying the servlet's HandlerMappings in order.</span></span><br><span class="line"><span class="comment"> * The HandlerAdapter will be obtained by querying the servlet's installed HandlerAdapters</span></span><br><span class="line"><span class="comment"> * to find the first that supports the handler class.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;All HTTP methods are handled by this method. It's up to HandlerAdapters or handlers</span></span><br><span class="line"><span class="comment"> * themselves to decide which methods are acceptable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response current HTTP response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception in case of any kind of processing failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    HttpServletRequest processedRequest = request;</span><br><span class="line">    HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">        Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processedRequest = checkMultipart(request);</span><br><span class="line">            multipartRequestParsed = processedRequest != request;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            <span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span> || mappedHandler.getHandler() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">            String method = request.getMethod();</span><br><span class="line">            <span class="keyword">boolean</span> isGet = <span class="string">"GET"</span>.equals(method);</span><br><span class="line">            <span class="keyword">if</span> (isGet || <span class="string">"HEAD"</span>.equals(method)) &#123;</span><br><span class="line">                <span class="keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Last-Modified value for ["</span> + getRequestUri(request) + <span class="string">"] is: "</span> + lastModified);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">                mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            applyDefaultViewName(request, mv);</span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">        triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">            mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">        <span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">            cleanupMultipart(processedRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个处理过程最核心的代码只有4句</p>
<ul>
<li>根据request请求在HandlerMapping找到对应的Handler </li>
<li>根据Handler找到对应的HandlerAdapter</li>
<li>用HandlerAdapter处理Handler,返回一个ModelAndView(Controller就是在这个地方执行)</li>
<li>根据ModelAndView的信息（或异常处理），通过ViewResolver找到View,并根据Model中的数据渲染输出后给用户</li>
</ul>
<p>整个<code>#doDispatcher()</code>处理流程如下</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fybvzj6p72j30u00ynju2.jpg" alt="image-20181219111943655"></p>
<blockquote>
<p>​    从请求开始的话，当请求到达服务器，服务器(Tomcat connector)分配一个socket线程来连接，创建request和response ，然后交给对应的servlet处理（中间经过Pipeline,Filter），这样请求就从容器(Tomcat)到Servlet（springMVC）</p>
</blockquote>
<p>​    </p>
<h4><span id="2-异步请求">2. 异步请求</span></h4><p>​    http协议是单向的，只能客户端自己拉，不能服务端主动推。异步请求一般有两种方式，定时轮询或长链接。Servlet对异步的支持是通过长链接的方式。</p>
<h5><span id="21-servlet异步支持">2.1 servlet异步支持</span></h5><h6><span id="211servletrequest">2.1.1ServletRequest</span></h6><p>​    首先是在 3.0后的 ServletRequest 中可以找到<code>#startAsync()</code> 返回一个异步容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Defines an object to provide client request information to a servlet.  The</span></span><br><span class="line"><span class="comment"> * servlet container creates a &lt;code&gt;ServletRequest&lt;/code&gt; object and passes</span></span><br><span class="line"><span class="comment"> * it as an argument to the servlet's &lt;code&gt;service&lt;/code&gt; method.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;A &lt;code&gt;ServletRequest&lt;/code&gt; object provides data including</span></span><br><span class="line"><span class="comment"> * parameter name and values, attributes, and an input stream.</span></span><br><span class="line"><span class="comment"> * Interfaces that extend &lt;code&gt;ServletRequest&lt;/code&gt; can provide</span></span><br><span class="line"><span class="comment"> * additional protocol-specific data (for example, HTTP data is</span></span><br><span class="line"><span class="comment"> * provided by &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 	Various</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> 	javax.servlet.http.HttpServletRequest</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletRequest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Puts this request into asynchronous mode, and initializes its</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncContext&#125; with the original (unwrapped) ServletRequest</span></span><br><span class="line"><span class="comment">     * and ServletResponse objects.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Calling this method will cause committal of the associated</span></span><br><span class="line"><span class="comment">     * response to be delayed until &#123;<span class="doctag">@link</span> AsyncContext#complete&#125; is</span></span><br><span class="line"><span class="comment">     * called on the returned &#123;<span class="doctag">@link</span> AsyncContext&#125;, or the asynchronous</span></span><br><span class="line"><span class="comment">     * operation has timed out.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Calling &#123;<span class="doctag">@link</span> AsyncContext#hasOriginalRequestAndResponse()&#125; on</span></span><br><span class="line"><span class="comment">     * the returned AsyncContext will return &lt;code&gt;true&lt;/code&gt;. Any filters</span></span><br><span class="line"><span class="comment">     * invoked in the &lt;i&gt;outbound&lt;/i&gt; direction after this request was put</span></span><br><span class="line"><span class="comment">     * into asynchronous mode may use this as an indication that any request</span></span><br><span class="line"><span class="comment">     * and/or response wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt;</span></span><br><span class="line"><span class="comment">     * invocation need not stay around for the duration of the asynchronous</span></span><br><span class="line"><span class="comment">     * operation, and therefore any of their associated resources may be</span></span><br><span class="line"><span class="comment">     * released.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method clears the list of &#123;<span class="doctag">@link</span> AsyncListener&#125; instances</span></span><br><span class="line"><span class="comment">     * (if any) that were registered with the AsyncContext returned by the</span></span><br><span class="line"><span class="comment">     * previous call to one of the startAsync methods, after calling each</span></span><br><span class="line"><span class="comment">     * AsyncListener at its &#123;<span class="doctag">@link</span> AsyncListener#onStartAsync onStartAsync&#125;</span></span><br><span class="line"><span class="comment">     * method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Subsequent invocations of this method, or its overloaded </span></span><br><span class="line"><span class="comment">     * variant, will return the same AsyncContext instance, reinitialized</span></span><br><span class="line"><span class="comment">     * as appropriate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the (re)initialized AsyncContext</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this request is within the scope of</span></span><br><span class="line"><span class="comment">     * a filter or servlet that does not support asynchronous operations</span></span><br><span class="line"><span class="comment">     * (that is, &#123;<span class="doctag">@link</span> #isAsyncSupported&#125; returns false),</span></span><br><span class="line"><span class="comment">     * or if this method is called again without any asynchronous dispatch</span></span><br><span class="line"><span class="comment">     * (resulting from one of the &#123;<span class="doctag">@link</span> AsyncContext#dispatch&#125; methods),</span></span><br><span class="line"><span class="comment">     * is called outside the scope of any such dispatch, or is called again</span></span><br><span class="line"><span class="comment">     * within the scope of the same dispatch, or if the response has</span></span><br><span class="line"><span class="comment">     * already been closed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncContext <span class="title">startAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6><span id="212-异步容器asynccontext">2.1.2  异步容器AsyncContext</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class representing the execution context for an asynchronous operation</span></span><br><span class="line"><span class="comment"> * that was initiated on a ServletRequest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An AsyncContext is created and initialized by a call to</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment"> * Repeated invocations of these methods will return the same AsyncContext</span></span><br><span class="line"><span class="comment"> * instance, reinitialized as appropriate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;In the event that an asynchronous operation has timed out, the</span></span><br><span class="line"><span class="comment"> * container must run through these steps:</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;Invoke, at their &#123;<span class="doctag">@link</span> AsyncListener#onTimeout onTimeout&#125; method, all</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> AsyncListener&#125; instances registered with the ServletRequest</span></span><br><span class="line"><span class="comment"> * on which the asynchronous operation was initiated.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If none of the listeners called &#123;<span class="doctag">@link</span> #complete&#125; or any of the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #dispatch&#125; methods, perform an error dispatch with a status code</span></span><br><span class="line"><span class="comment"> * equal to &lt;tt&gt;HttpServletResponse.SC_INTERNAL_SERVER_ERROR&lt;/tt&gt;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no matching error page was found, or the error page did not call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #complete&#125; or any of the &#123;<span class="doctag">@link</span> #dispatch&#125; methods, call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #complete&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * request URI is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_REQUEST_URI = <span class="string">"javax.servlet.async.request_uri"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * context path is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_CONTEXT_PATH = <span class="string">"javax.servlet.async.context_path"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * path info is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_PATH_INFO = <span class="string">"javax.servlet.async.path_info"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * servlet path is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125;  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_SERVLET_PATH = <span class="string">"javax.servlet.async.servlet_path"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request attribute under which the original</span></span><br><span class="line"><span class="comment">     * query string is made available to the target of a</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch(String)&#125; or &#123;<span class="doctag">@link</span> #dispatch(ServletContext,String)&#125; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_QUERY_STRING = <span class="string">"javax.servlet.async.query_string"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the request that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     * by calling &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the request that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRequest <span class="title">getRequest</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the response that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     * by calling &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the response that was used to initialize this AsyncContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletResponse <span class="title">getResponse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if this AsyncContext was initialized with the original or</span></span><br><span class="line"><span class="comment">     * application-wrapped request and response objects.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This information may be used by filters invoked in the</span></span><br><span class="line"><span class="comment">     * &lt;i&gt;outbound&lt;/i&gt; direction, after a request was put into</span></span><br><span class="line"><span class="comment">     * asynchronous mode, to determine whether any request and/or response</span></span><br><span class="line"><span class="comment">     * wrappers that they added during their &lt;i&gt;inbound&lt;/i&gt; invocation need</span></span><br><span class="line"><span class="comment">     * to be preserved for the duration of the asynchronous operation, or may</span></span><br><span class="line"><span class="comment">     * be released.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if this AsyncContext was initialized with the original</span></span><br><span class="line"><span class="comment">     * request and response objects by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125;, or if it was initialized by</span></span><br><span class="line"><span class="comment">     * calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and neither the ServletRequest nor ServletResponse arguments </span></span><br><span class="line"><span class="comment">     * carried any application-provided wrappers; false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasOriginalRequestAndResponse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the servlet container.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If the asynchronous cycle was started with</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and the request passed is an instance of HttpServletRequest,</span></span><br><span class="line"><span class="comment">     * then the dispatch is to the URI returned by</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest#getRequestURI&#125;.</span></span><br><span class="line"><span class="comment">     * Otherwise, the dispatch is to the URI of the request when it was</span></span><br><span class="line"><span class="comment">     * last dispatched by the container.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The following sequence illustrates how this will work:</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;&lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * // REQUEST dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * AsyncContext ac = request.startAsync();</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * // FORWARD dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * getRequestDispatcher("/url/B").forward(request,response);</span></span><br><span class="line"><span class="comment">     * // Start async operation from within the target of the FORWARD</span></span><br><span class="line"><span class="comment">     * // dispatch</span></span><br><span class="line"><span class="comment">     * ac = request.startAsync();</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/A</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * // FORWARD dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * getRequestDispatcher("/url/B").forward(request,response);</span></span><br><span class="line"><span class="comment">     * // Start async operation from within the target of the FORWARD</span></span><br><span class="line"><span class="comment">     * // dispatch</span></span><br><span class="line"><span class="comment">     * ac = request.startAsync(request,response);</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ac.dispatch(); // ASYNC dispatch to /url/B</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method returns immediately after passing the request</span></span><br><span class="line"><span class="comment">     * and response objects to a container managed thread, on which the</span></span><br><span class="line"><span class="comment">     * dispatch operation will be performed.</span></span><br><span class="line"><span class="comment">     * If this method is called before the container-initiated dispatch</span></span><br><span class="line"><span class="comment">     * that called &lt;tt&gt;startAsync&lt;/tt&gt; has returned to the container, the</span></span><br><span class="line"><span class="comment">     * dispatch operation will be delayed until after the container-initiated</span></span><br><span class="line"><span class="comment">     * dispatch has returned to the container.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The dispatcher type of the request is set to</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;DispatcherType.ASYNC&lt;/tt&gt;. Unlike</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> RequestDispatcher#forward(ServletRequest, ServletResponse)</span></span><br><span class="line"><span class="comment">     * forward dispatches&#125;, the response buffer and</span></span><br><span class="line"><span class="comment">     * headers will not be reset, and it is legal to dispatch even if the</span></span><br><span class="line"><span class="comment">     * response has already been committed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Control over the request and response is delegated</span></span><br><span class="line"><span class="comment">     * to the dispatch target, and the response will be closed when the</span></span><br><span class="line"><span class="comment">     * dispatch target has completed execution, unless</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;</span></span><br><span class="line"><span class="comment">     * are called.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Any errors or exceptions that may occur during the execution</span></span><br><span class="line"><span class="comment">     * of this method must be caught and handled by the container, as</span></span><br><span class="line"><span class="comment">     * follows:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;Invoke, at their &#123;<span class="doctag">@link</span> AsyncListener#onError onError&#125; method, all</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncListener&#125; instances registered with the ServletRequest</span></span><br><span class="line"><span class="comment">     * for which this AsyncContext was created, and make the caught </span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;Throwable&lt;/tt&gt; available via &#123;<span class="doctag">@link</span> AsyncEvent#getThrowable&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If none of the listeners called &#123;<span class="doctag">@link</span> #complete&#125; or any of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #dispatch&#125; methods, perform an error dispatch with a status code</span></span><br><span class="line"><span class="comment">     * equal to &lt;tt&gt;HttpServletResponse.SC_INTERNAL_SERVER_ERROR&lt;/tt&gt;, and</span></span><br><span class="line"><span class="comment">     * make the above &lt;tt&gt;Throwable&lt;/tt&gt; available as the value of the</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;RequestDispatcher.ERROR_EXCEPTION&lt;/tt&gt; request attribute.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;If no matching error page was found, or the error page did not call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #complete&#125; or any of the &#123;<span class="doctag">@link</span> #dispatch&#125; methods, call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #complete&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the given &lt;tt&gt;path&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &lt;tt&gt;path&lt;/tt&gt; parameter is interpreted in the same way </span></span><br><span class="line"><span class="comment">     * as in &#123;<span class="doctag">@link</span> ServletRequest#getRequestDispatcher(String)&#125;, within</span></span><br><span class="line"><span class="comment">     * the scope of the &#123;<span class="doctag">@link</span> ServletContext&#125; from which this</span></span><br><span class="line"><span class="comment">     * AsyncContext was initialized.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;All path related query methods of the request must reflect the</span></span><br><span class="line"><span class="comment">     * dispatch target, while the original request URI, context path,</span></span><br><span class="line"><span class="comment">     * path info, servlet path, and query string may be recovered from</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #ASYNC_REQUEST_URI&#125;, &#123;<span class="doctag">@link</span> #ASYNC_CONTEXT_PATH&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_PATH_INFO&#125;, &#123;<span class="doctag">@link</span> #ASYNC_SERVLET_PATH&#125;, and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_QUERY_STRING&#125; attributes of the request. These</span></span><br><span class="line"><span class="comment">     * attributes will always reflect the original path elements, even under</span></span><br><span class="line"><span class="comment">     * repeated dispatches.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;See &#123;<span class="doctag">@link</span> #dispatch()&#125; for additional details, including error</span></span><br><span class="line"><span class="comment">     * handling.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path the path of the dispatch target, scoped to the</span></span><br><span class="line"><span class="comment">     * ServletContext from which this AsyncContext was initialized</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Dispatches the request and response objects of this AsyncContext</span></span><br><span class="line"><span class="comment">     * to the given &lt;tt&gt;path&lt;/tt&gt; scoped to the given &lt;tt&gt;context&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &lt;tt&gt;path&lt;/tt&gt; parameter is interpreted in the same way </span></span><br><span class="line"><span class="comment">     * as in &#123;<span class="doctag">@link</span> ServletRequest#getRequestDispatcher(String)&#125;, except that</span></span><br><span class="line"><span class="comment">     * it is scoped to the given &lt;tt&gt;context&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;All path related query methods of the request must reflect the</span></span><br><span class="line"><span class="comment">     * dispatch target, while the original request URI, context path,</span></span><br><span class="line"><span class="comment">     * path info, servlet path, and query string may be recovered from</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #ASYNC_REQUEST_URI&#125;, &#123;<span class="doctag">@link</span> #ASYNC_CONTEXT_PATH&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_PATH_INFO&#125;, &#123;<span class="doctag">@link</span> #ASYNC_SERVLET_PATH&#125;, and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #ASYNC_QUERY_STRING&#125; attributes of the request. These</span></span><br><span class="line"><span class="comment">     * attributes will always reflect the original path elements, even under</span></span><br><span class="line"><span class="comment">     * repeated dispatches.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;There can be at most one asynchronous dispatch operation per</span></span><br><span class="line"><span class="comment">     * asynchronous cycle, which is started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods. Any attempt to perform an</span></span><br><span class="line"><span class="comment">     * additional asynchronous dispatch operation within the same</span></span><br><span class="line"><span class="comment">     * asynchronous cycle will result in an IllegalStateException.</span></span><br><span class="line"><span class="comment">     * If startAsync is subsequently called on the dispatched request,</span></span><br><span class="line"><span class="comment">     * then any of the dispatch or &#123;<span class="doctag">@link</span> #complete&#125; methods may be called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;See &#123;<span class="doctag">@link</span> #dispatch()&#125; for additional details, including error</span></span><br><span class="line"><span class="comment">     * handling.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context the ServletContext of the dispatch target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path the path of the dispatch target, scoped to the given</span></span><br><span class="line"><span class="comment">     * ServletContext</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if one of the dispatch methods</span></span><br><span class="line"><span class="comment">     * has been called and the startAsync method has not been</span></span><br><span class="line"><span class="comment">     * called during the resulting dispatch, or if &#123;<span class="doctag">@link</span> #complete&#125;</span></span><br><span class="line"><span class="comment">     * was called</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ServletRequest#getDispatcherType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(ServletContext context, String path)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Completes the asynchronous operation that was started on the request</span></span><br><span class="line"><span class="comment">     * that was used to initialze this AsyncContext, closing the response</span></span><br><span class="line"><span class="comment">     * that was used to initialize this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Any listeners of type &#123;<span class="doctag">@link</span> AsyncListener&#125; that were registered</span></span><br><span class="line"><span class="comment">     * with the ServletRequest for which this AsyncContext was created will</span></span><br><span class="line"><span class="comment">     * be invoked at their &#123;<span class="doctag">@link</span> AsyncListener#onComplete(AsyncEvent)</span></span><br><span class="line"><span class="comment">     * onComplete&#125; method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;It is legal to call this method any time after a call to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync()&#125; or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync(ServletRequest, ServletResponse)&#125;,</span></span><br><span class="line"><span class="comment">     * and before a call to one of the &lt;tt&gt;dispatch&lt;/tt&gt; methods</span></span><br><span class="line"><span class="comment">     * of this class. </span></span><br><span class="line"><span class="comment">     * If this method is called before the container-initiated dispatch</span></span><br><span class="line"><span class="comment">     * that called &lt;tt&gt;startAsync&lt;/tt&gt; has returned to the container, then</span></span><br><span class="line"><span class="comment">     * the call will not take effect (and any invocations of</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncListener#onComplete(AsyncEvent)&#125; will be delayed) until</span></span><br><span class="line"><span class="comment">     * after the container-initiated dispatch has returned to the container.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Causes the container to dispatch a thread, possibly from a managed</span></span><br><span class="line"><span class="comment">     * thread pool, to run the specified &lt;tt&gt;Runnable&lt;/tt&gt;. The container may</span></span><br><span class="line"><span class="comment">     * propagate appropriate contextual information to the &lt;tt&gt;Runnable&lt;/tt&gt;. </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> run the asynchronous handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Runnable run)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers the given &#123;<span class="doctag">@link</span> AsyncListener&#125; with the most recent</span></span><br><span class="line"><span class="comment">     * asynchronous cycle that was started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener will receive an &#123;<span class="doctag">@link</span> AsyncEvent&#125; when</span></span><br><span class="line"><span class="comment">     * the asynchronous cycle completes successfully, times out, or results</span></span><br><span class="line"><span class="comment">     * in an error.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;AsyncListener instances will be notified in the order in which</span></span><br><span class="line"><span class="comment">     * they were added.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener the AsyncListener to be registered</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(AsyncListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers the given &#123;<span class="doctag">@link</span> AsyncListener&#125; with the most recent</span></span><br><span class="line"><span class="comment">     * asynchronous cycle that was started by a call to one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener will receive an &#123;<span class="doctag">@link</span> AsyncEvent&#125; when</span></span><br><span class="line"><span class="comment">     * the asynchronous cycle completes successfully, times out, or results</span></span><br><span class="line"><span class="comment">     * in an error.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;AsyncListener instances will be notified in the order in which</span></span><br><span class="line"><span class="comment">     * they were added.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given ServletRequest and ServletResponse objects will</span></span><br><span class="line"><span class="comment">     * be made available to the given AsyncListener via the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125; methods,</span></span><br><span class="line"><span class="comment">     * respectively, of the &#123;<span class="doctag">@link</span> AsyncEvent&#125; delivered to it. These objects</span></span><br><span class="line"><span class="comment">     * should not be read from or written to, respectively, at the time the</span></span><br><span class="line"><span class="comment">     * AsyncEvent is delivered, because additional wrapping may have</span></span><br><span class="line"><span class="comment">     * occurred since the given AsyncListener was registered, but may be used</span></span><br><span class="line"><span class="comment">     * in order to release any resources associated with them.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener the AsyncListener to be registered</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servletRequest the ServletRequest that will be included</span></span><br><span class="line"><span class="comment">     * in the AsyncEvent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servletResponse the ServletResponse that will be included</span></span><br><span class="line"><span class="comment">     * in the AsyncEvent</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(AsyncListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">                            ServletRequest servletRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                            ServletResponse servletResponse)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates the given &#123;<span class="doctag">@link</span> AsyncListener&#125; class.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The returned AsyncListener instance may be further customized</span></span><br><span class="line"><span class="comment">     * before it is registered with this AsyncContext via a call to one of </span></span><br><span class="line"><span class="comment">     * the &lt;code&gt;addListener&lt;/code&gt; methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The given AsyncListener class must define a zero argument</span></span><br><span class="line"><span class="comment">     * constructor, which is used to instantiate it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method supports resource injection if the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;clazz&lt;/tt&gt; represents a Managed Bean.</span></span><br><span class="line"><span class="comment">     * See the Java EE platform and JSR 299 specifications for additional</span></span><br><span class="line"><span class="comment">     * details about Managed Beans and resource injection.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method supports any annotations applicable to AsyncListener.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the AsyncListener class to instantiate</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new AsyncListener instance</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException if the given &lt;tt&gt;clazz&lt;/tt&gt; fails to be</span></span><br><span class="line"><span class="comment">     * instantiated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends AsyncListener&gt; <span class="function">T <span class="title">createListener</span><span class="params">(Class&lt;T&gt; clazz)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the timeout (in milliseconds) for this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The timeout applies to this AsyncContext once the</span></span><br><span class="line"><span class="comment">     * container-initiated dispatch during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called has</span></span><br><span class="line"><span class="comment">     * returned to the container. </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The timeout will expire if neither the &#123;<span class="doctag">@link</span> #complete&#125; method</span></span><br><span class="line"><span class="comment">     * nor any of the dispatch methods are called. A timeout value of</span></span><br><span class="line"><span class="comment">     * zero or less indicates no timeout. </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;If &#123;<span class="doctag">@link</span> #setTimeout&#125; is not called, then the container's</span></span><br><span class="line"><span class="comment">     * default timeout, which is available via a call to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #getTimeout&#125;, will apply.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout the timeout in milliseconds</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalStateException if this method is called after</span></span><br><span class="line"><span class="comment">     * the container-initiated dispatch, during which one of the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125; methods was called, has</span></span><br><span class="line"><span class="comment">     * returned to the container</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeout</span><span class="params">(<span class="keyword">long</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the timeout (in milliseconds) for this AsyncContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method returns the container's default timeout for</span></span><br><span class="line"><span class="comment">     * asynchronous operations, or the timeout value passed to the most</span></span><br><span class="line"><span class="comment">     * recent invocation of &#123;<span class="doctag">@link</span> #setTimeout&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;A timeout value of zero or less indicates no timeout.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the timeout in milliseconds</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeout</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>比较简单，通过看代码中的注释就能知其大意了，异步就是不等待结果立即返回，这里start一般用新线程的方式，线程运行完后(#complete)，需要通知（#addListener）,以及超时检测处理（#setTimeout,由容器Tomcat来设置）
</code></pre><h6><span id="213-asynclistener监听器">2.1.3 AsyncListener监听器</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.EventListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Listener that will be notified in the event that an asynchronous</span></span><br><span class="line"><span class="comment"> * operation initiated on a ServletRequest to which the listener had been </span></span><br><span class="line"><span class="comment"> * added has completed, timed out, or resulted in an error.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> Servlet 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncListener</span> <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation</span></span><br><span class="line"><span class="comment">     * has been completed.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that has been completed may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has been completed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation</span></span><br><span class="line"><span class="comment">     * has timed out.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that has timed out may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has timed out</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeout</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that an asynchronous operation </span></span><br><span class="line"><span class="comment">     * has failed to complete.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that failed to complete may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that an asynchronous</span></span><br><span class="line"><span class="comment">     * operation has failed to complete</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies this AsyncListener that a new asynchronous cycle is being</span></span><br><span class="line"><span class="comment">     * initiated via a call to one of the &#123;<span class="doctag">@link</span> ServletRequest#startAsync&#125;</span></span><br><span class="line"><span class="comment">     * methods.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The &#123;<span class="doctag">@link</span> AsyncContext&#125; corresponding to the asynchronous</span></span><br><span class="line"><span class="comment">     * operation that is being reinitialized may be obtained by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getAsyncContext getAsyncContext&#125; on the given</span></span><br><span class="line"><span class="comment">     * &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * &lt;p&gt;In addition, if this AsyncListener had been registered via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener(AsyncListener,</span></span><br><span class="line"><span class="comment">     * ServletRequest, ServletResponse)&#125;, the supplied ServletRequest and</span></span><br><span class="line"><span class="comment">     * ServletResponse objects may be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedRequest getSuppliedRequest&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AsyncEvent#getSuppliedResponse getSuppliedResponse&#125;,</span></span><br><span class="line"><span class="comment">     * respectively, on the given &lt;tt&gt;event&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This AsyncListener will not receive any events related to the</span></span><br><span class="line"><span class="comment">     * new asynchronous cycle unless it registers itself (via a call</span></span><br><span class="line"><span class="comment">     * to &#123;<span class="doctag">@link</span> AsyncContext#addListener&#125;) with the AsyncContext that</span></span><br><span class="line"><span class="comment">     * is delivered as part of the given AsyncEvent.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the AsyncEvent indicating that a new asynchronous</span></span><br><span class="line"><span class="comment">     * cycle is being initiated</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException if an I/O related error has occurred during the</span></span><br><span class="line"><span class="comment">     * processing of the given AsyncEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartAsync</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException</span>;     </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    监听器主要有4个事件，开始、完成、超时、错误。</p>
<h5><span id="22-springmvc中的相关组件">2.2 SpringMVC中的相关组件</span></h5><p>​    SpringMVC中异步请求相关组件 AsyncWebRequest、WebAsyncManager、WebAsyncUtils    </p>
<h6><span id="221-asyncwebrequest">2.2.1 AsyncWebRequest</span></h6><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fydgk0syd0j30u019f7aj.jpg" alt="image-20181220195645682"></p>
<p>其实现有两个，其中<code>NoSupportAsyncWebRequest</code>不支持异步，所以我们只需要关注<code>StandarServletAsyncWebRequest</code>即可。（可以看到其实主要是对Servelt中支持异步的类的一些特性进行整合）</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fydgqk142nj31bm0pawie.jpg" alt="image-20181220200306736"></p>
<blockquote>
<p>具体细节看StandarServletAsyncWebRequest的实现</p>
</blockquote>
<h6><span id="222-webasyncmanager">2.2.2 WebAsyncManager</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.context.request.async;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.AsyncTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.SimpleAsyncTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult.DeferredResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.UrlPathHelper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The central class for managing asynchronous request processing, mainly intended</span></span><br><span class="line"><span class="comment"> * as an SPI and not typically used directly by application classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An async scenario starts with request processing as usual in a thread (T1).</span></span><br><span class="line"><span class="comment"> * Concurrent request handling can be initiated by calling</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...) startCallableProcessing&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #startDeferredResultProcessing(DeferredResult, Object...) startDeferredResultProcessing&#125;,</span></span><br><span class="line"><span class="comment"> * both of which produce a result in a separate thread (T2). The result is saved</span></span><br><span class="line"><span class="comment"> * and the request dispatched to the container, to resume processing with the saved</span></span><br><span class="line"><span class="comment"> * result in a third thread (T3). Within the dispatched thread (T3), the saved</span></span><br><span class="line"><span class="comment"> * result can be accessed via &#123;<span class="doctag">@link</span> #getConcurrentResult()&#125; or its presence</span></span><br><span class="line"><span class="comment"> * detected via &#123;<span class="doctag">@link</span> #hasConcurrentResult()&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.context.request.AsyncWebRequestInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.AsyncHandlerInterceptor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.filter.OncePerRequestFilter#shouldNotFilterAsyncDispatch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.filter.OncePerRequestFilter#isAsyncDispatch</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAsyncManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object RESULT_NONE = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(WebAsyncManager.class);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UrlPathHelper urlPathHelper = <span class="keyword">new</span> UrlPathHelper();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CallableProcessingInterceptor timeoutCallableInterceptor =</span><br><span class="line">         <span class="keyword">new</span> TimeoutCallableProcessingInterceptor();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DeferredResultProcessingInterceptor timeoutDeferredResultInterceptor =</span><br><span class="line">         <span class="keyword">new</span> TimeoutDeferredResultProcessingInterceptor();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> AsyncWebRequest asyncWebRequest;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> AsyncTaskExecutor taskExecutor = <span class="keyword">new</span> SimpleAsyncTaskExecutor(<span class="keyword">this</span>.getClass().getSimpleName());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Object concurrentResult = RESULT_NONE;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Object[] concurrentResultContext;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, CallableProcessingInterceptor&gt; callableInterceptors =</span><br><span class="line">         <span class="keyword">new</span> LinkedHashMap&lt;Object, CallableProcessingInterceptor&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, DeferredResultProcessingInterceptor&gt; deferredResultInterceptors =</span><br><span class="line">         <span class="keyword">new</span> LinkedHashMap&lt;Object, DeferredResultProcessingInterceptor&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Package private constructor.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> WebAsyncUtils#getAsyncManager(javax.servlet.ServletRequest)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> WebAsyncUtils#getAsyncManager(org.springframework.web.context.request.WebRequest)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   WebAsyncManager() &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Configure the &#123;<span class="doctag">@link</span> AsyncWebRequest&#125; to use. This property may be set</span></span><br><span class="line"><span class="comment">    * more than once during a single request to accurately reflect the current</span></span><br><span class="line"><span class="comment">    * state of the request (e.g. following a forward, request/response</span></span><br><span class="line"><span class="comment">    * wrapping, etc). However, it should not be set while concurrent handling</span></span><br><span class="line"><span class="comment">    * is in progress, i.e. while &#123;<span class="doctag">@link</span> #isConcurrentHandlingStarted()&#125; is</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> asyncWebRequest the web request to use</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsyncWebRequest</span><span class="params">(<span class="keyword">final</span> AsyncWebRequest asyncWebRequest)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(asyncWebRequest, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line">      Assert.state(!isConcurrentHandlingStarted(), <span class="string">"Can't set AsyncWebRequest with concurrent handling in progress"</span>);</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest = asyncWebRequest;</span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            asyncWebRequest.removeAttribute(WebAsyncUtils.WEB_ASYNC_MANAGER_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Configure an AsyncTaskExecutor for use with concurrent processing via</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...)&#125;.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;By default a &#123;<span class="doctag">@link</span> SimpleAsyncTaskExecutor&#125; instance is used.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskExecutor</span><span class="params">(AsyncTaskExecutor taskExecutor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.taskExecutor = taskExecutor;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether the selected handler for the current request chose to handle the</span></span><br><span class="line"><span class="comment">    * request asynchronously. A return value of "true" indicates concurrent</span></span><br><span class="line"><span class="comment">    * handling is under way and the response will remain open. A return value</span></span><br><span class="line"><span class="comment">    * of "false" means concurrent handling was either not started or possibly</span></span><br><span class="line"><span class="comment">    * that it has completed and the request was dispatched for further</span></span><br><span class="line"><span class="comment">    * processing of the concurrent result.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConcurrentHandlingStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ((<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>) &amp;&amp; <span class="keyword">this</span>.asyncWebRequest.isAsyncStarted());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether a result value exists as a result of concurrent handling.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">this</span>.concurrentResult != RESULT_NONE);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides access to the result from concurrent handling.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> an Object, possibly an &#123;<span class="doctag">@code</span> Exception&#125; or &#123;<span class="doctag">@code</span> Throwable&#125; if</span></span><br><span class="line"><span class="comment">    * concurrent handling raised one.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #clearConcurrentResult()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.concurrentResult;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Provides access to additional processing context saved at the start of</span></span><br><span class="line"><span class="comment">    * concurrent handling.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #clearConcurrentResult()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> Object[] getConcurrentResultContext() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.concurrentResultContext;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; registered under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the interceptor registered under that key or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CallableProcessingInterceptor <span class="title">getCallableInterceptor</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.callableInterceptors.get(key);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; registered under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the interceptor registered under that key or &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DeferredResultProcessingInterceptor <span class="title">getDeferredResultInterceptor</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.deferredResultInterceptors.get(key);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptor the interceptor to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallableInterceptor</span><span class="params">(Object key, CallableProcessingInterceptor interceptor)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(key, <span class="string">"Key is required"</span>);</span><br><span class="line">      Assert.notNull(interceptor, <span class="string">"CallableProcessingInterceptor  is required"</span>);</span><br><span class="line">      <span class="keyword">this</span>.callableInterceptors.put(key, interceptor);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> CallableProcessingInterceptor&#125; without a key.</span></span><br><span class="line"><span class="comment">    * The key is derived from the class name and hashcode.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptors one or more interceptors to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCallableInterceptors</span><span class="params">(CallableProcessingInterceptor... interceptors)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(interceptors, <span class="string">"A CallableProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">for</span> (CallableProcessingInterceptor interceptor : interceptors) &#123;</span><br><span class="line">         String key = interceptor.getClass().getName() + <span class="string">":"</span> + interceptor.hashCode();</span><br><span class="line">         <span class="keyword">this</span>.callableInterceptors.put(key, interceptor);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; under the given key.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptor the interceptor to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDeferredResultInterceptor</span><span class="params">(Object key, DeferredResultProcessingInterceptor interceptor)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(key, <span class="string">"Key is required"</span>);</span><br><span class="line">      Assert.notNull(interceptor, <span class="string">"DeferredResultProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">this</span>.deferredResultInterceptors.put(key, interceptor);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Register a &#123;<span class="doctag">@link</span> DeferredResultProcessingInterceptor&#125; without a key.</span></span><br><span class="line"><span class="comment">    * The key is derived from the class name and hashcode.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interceptors one or more interceptors to register</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerDeferredResultInterceptors</span><span class="params">(DeferredResultProcessingInterceptor... interceptors)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(interceptors, <span class="string">"A DeferredResultProcessingInterceptor is required"</span>);</span><br><span class="line">      <span class="keyword">for</span> (DeferredResultProcessingInterceptor interceptor : interceptors) &#123;</span><br><span class="line">         String key = interceptors.getClass().getName() + <span class="string">":"</span> + interceptors.hashCode();</span><br><span class="line">         <span class="keyword">this</span>.deferredResultInterceptors.put(key, interceptor);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Clear &#123;<span class="doctag">@linkplain</span> #getConcurrentResult() concurrentResult&#125; and</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@linkplain</span> #getConcurrentResultContext() concurrentResultContext&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearConcurrentResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.concurrentResult = RESULT_NONE;</span><br><span class="line">      <span class="keyword">this</span>.concurrentResultContext = <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Start concurrent request processing and execute the given task with an</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #setTaskExecutor(AsyncTaskExecutor) AsyncTaskExecutor&#125;. The result</span></span><br><span class="line"><span class="comment">    * from the task execution is saved and the request dispatched in order to</span></span><br><span class="line"><span class="comment">    * resume processing of that result. If the task raises an Exception then</span></span><br><span class="line"><span class="comment">    * the saved result will be the raised Exception.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> callable a unit of work to be executed asynchronously</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResult()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResultContext()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> &#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> Callable&lt;?&gt; callable, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Assert.notNull(callable, <span class="string">"Callable must not be null"</span>);</span><br><span class="line">      startCallableProcessing(<span class="keyword">new</span> WebAsyncTask(callable), processingContext);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Use the given &#123;<span class="doctag">@link</span> WebAsyncTask&#125; to configure the task executor as well as</span></span><br><span class="line"><span class="comment">    * the timeout value of the &#123;<span class="doctag">@code</span> AsyncWebRequest&#125; before delegating to</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> #startCallableProcessing(Callable, Object...)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> webAsyncTask a WebAsyncTask containing the target &#123;<span class="doctag">@code</span> Callable&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startCallableProcessing</span><span class="params">(<span class="keyword">final</span> WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Assert.notNull(webAsyncTask, <span class="string">"WebAsyncTask must not be null"</span>);</span><br><span class="line">      Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">      Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">      <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">      <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.taskExecutor = executor;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;CallableProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">      interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">      interceptors.addAll(<span class="keyword">this</span>.callableInterceptors.values());</span><br><span class="line">      interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">      <span class="keyword">final</span> CallableInterceptorChain interceptorChain = <span class="keyword">new</span> CallableInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            logger.debug(<span class="string">"Processing timeout"</span>);</span><br><span class="line">            Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">            <span class="keyword">if</span> (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">               setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      interceptorChain.applyBeforeConcurrentHandling(asyncWebRequest, callable);</span><br><span class="line"></span><br><span class="line">      startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.taskExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Object result = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">               result = callable.call();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               result = t;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">               result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">            &#125;</span><br><span class="line">            setConcurrentResultAndDispatch(result);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setConcurrentResultAndDispatch</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (WebAsyncManager.<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (hasConcurrentResult()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         concurrentResult = result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (asyncWebRequest.isAsyncComplete()) &#123;</span><br><span class="line">         logger.error(<span class="string">"Could not complete async processing due to timeout or network error"</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      logger.debug(<span class="string">"Concurrent result value ["</span> + concurrentResult + <span class="string">"]"</span>);</span><br><span class="line">      logger.debug(<span class="string">"Dispatching request to resume processing"</span>);</span><br><span class="line"></span><br><span class="line">      asyncWebRequest.dispatch();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Start concurrent request processing and initialize the given</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> DeferredResult&#125; with a &#123;<span class="doctag">@link</span> DeferredResultHandler&#125; that saves</span></span><br><span class="line"><span class="comment">    * the result and dispatches the request to resume processing of that</span></span><br><span class="line"><span class="comment">    * result. The &#123;<span class="doctag">@code</span> AsyncWebRequest&#125; is also updated with a completion</span></span><br><span class="line"><span class="comment">    * handler that expires the &#123;<span class="doctag">@code</span> DeferredResult&#125; and a timeout handler</span></span><br><span class="line"><span class="comment">    * assuming the &#123;<span class="doctag">@code</span> DeferredResult&#125; has a default timeout result.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> deferredResult the DeferredResult instance to initialize</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> processingContext additional context to save that can be accessed</span></span><br><span class="line"><span class="comment">    * via &#123;<span class="doctag">@link</span> #getConcurrentResultContext()&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception If concurrent processing failed to start</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResult()</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #getConcurrentResultContext()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDeferredResultProcessing</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">final</span> DeferredResult&lt;?&gt; deferredResult, Object... processingContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      Assert.notNull(deferredResult, <span class="string">"DeferredResult must not be null"</span>);</span><br><span class="line">      Assert.state(<span class="keyword">this</span>.asyncWebRequest != <span class="keyword">null</span>, <span class="string">"AsyncWebRequest must not be null"</span>);</span><br><span class="line"></span><br><span class="line">      Long timeout = deferredResult.getTimeoutValue();</span><br><span class="line">      <span class="keyword">if</span> (timeout != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      List&lt;DeferredResultProcessingInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;DeferredResultProcessingInterceptor&gt;();</span><br><span class="line">      interceptors.add(deferredResult.getInterceptor());</span><br><span class="line">      interceptors.addAll(<span class="keyword">this</span>.deferredResultInterceptors.values());</span><br><span class="line">      interceptors.add(timeoutDeferredResultInterceptor);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> DeferredResultInterceptorChain interceptorChain = <span class="keyword">new</span> DeferredResultInterceptorChain(interceptors);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addTimeoutHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               interceptorChain.triggerAfterTimeout(asyncWebRequest, deferredResult);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               setConcurrentResultAndDispatch(t);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.addCompletionHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, deferredResult);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      interceptorChain.applyBeforeConcurrentHandling(asyncWebRequest, deferredResult);</span><br><span class="line"></span><br><span class="line">      startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         interceptorChain.applyPreProcess(<span class="keyword">this</span>.asyncWebRequest, deferredResult);</span><br><span class="line">         deferredResult.setResultHandler(<span class="keyword">new</span> DeferredResultHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">               result = interceptorChain.applyPostProcess(asyncWebRequest, deferredResult, result);</span><br><span class="line">               setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         setConcurrentResultAndDispatch(t);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAsyncProcessing</span><span class="params">(Object[] processingContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      clearConcurrentResult();</span><br><span class="line">      <span class="keyword">this</span>.concurrentResultContext = processingContext;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.asyncWebRequest.startAsync();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         HttpServletRequest request = <span class="keyword">this</span>.asyncWebRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">         String requestUri = urlPathHelper.getRequestUri(request);</span><br><span class="line">         logger.debug(<span class="string">"Concurrent handling starting for "</span> + request.getMethod() + <span class="string">" ["</span> + requestUri + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    类中有两个重要的方法#startCallableProcessing（用于处理Callable和WebAsyncTask类型），#startDeferredResultProcessing（用于处理DeferredResult和ListenableFuture类型）,是启动异步处理的入口方法，它们一共做了三件事</p>
<ul>
<li>启动异步处理</li>
<li>给Request设置相应属性（timeout、timeoutHandler和completionHandler）</li>
<li>在相应的位置调用相应的拦截器（CallableProcessingInterceptor和DeferredResultProcessingInterceptor都封装在相应的Chain中）</li>
</ul>
<blockquote>
<p>更多细节 可查看startCallableProcessing的执行过程</p>
</blockquote>
<h6><span id="223-webasyncutils">2.2.3 WebAsyncUtils</span></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.web.context.request.async;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.WebRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Utility methods related to processing asynchronous web requests.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAsyncUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_ASYNC_MANAGER_ATTRIBUTE = WebAsyncManager.class.getName() + <span class="string">".WEB_ASYNC_MANAGER"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;?&gt; standardAsyncRequestConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Obtain the &#123;<span class="doctag">@link</span> WebAsyncManager&#125; for the current request, or if not</span></span><br><span class="line"><span class="comment">    * found, create and associate it with the request.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebAsyncManager <span class="title">getAsyncManager</span><span class="params">(ServletRequest servletRequest)</span> </span>&#123;</span><br><span class="line">      WebAsyncManager asyncManager = (WebAsyncManager) servletRequest.getAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">         asyncManager = <span class="keyword">new</span> WebAsyncManager();</span><br><span class="line">         servletRequest.setAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, asyncManager);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> asyncManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Obtain the &#123;<span class="doctag">@link</span> WebAsyncManager&#125; for the current request, or if not</span></span><br><span class="line"><span class="comment">    * found, create and associate it with the request.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WebAsyncManager <span class="title">getAsyncManager</span><span class="params">(WebRequest webRequest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> scope = RequestAttributes.SCOPE_REQUEST;</span><br><span class="line">      WebAsyncManager asyncManager = (WebAsyncManager) webRequest.getAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, scope);</span><br><span class="line">      <span class="keyword">if</span> (asyncManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">         asyncManager = <span class="keyword">new</span> WebAsyncManager();</span><br><span class="line">         webRequest.setAttribute(WEB_ASYNC_MANAGER_ATTRIBUTE, asyncManager, scope);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> asyncManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Create an AsyncWebRequest instance. By default an instance of</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> StandardServletAsyncWebRequest&#125; is created if running in Servlet</span></span><br><span class="line"><span class="comment">    * 3.0 (or higher) environment or as a fallback, an instance of</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> NoSupportAsyncWebRequest&#125; is returned.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> an AsyncWebRequest instance, never &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsyncWebRequest <span class="title">createAsyncWebRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> ClassUtils.hasMethod(ServletRequest.class, <span class="string">"startAsync"</span>) ?</span><br><span class="line">            createStandardServletAsyncWebRequest(request, response) : <span class="keyword">new</span> NoSupportAsyncWebRequest(request, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AsyncWebRequest <span class="title">createStandardServletAsyncWebRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (standardAsyncRequestConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String className = <span class="string">"org.springframework.web.context.request.async.StandardServletAsyncWebRequest"</span>;</span><br><span class="line">            Class&lt;?&gt; clazz = ClassUtils.forName(className, WebAsyncUtils.class.getClassLoader());</span><br><span class="line">            standardAsyncRequestConstructor = clazz.getConstructor(HttpServletRequest.class, HttpServletResponse.class);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> (AsyncWebRequest) BeanUtils.instantiateClass(standardAsyncRequestConstructor, request, response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to instantiate StandardServletAsyncWebRequest"</span>, t);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    可以看到这个类主要是提供WebAsyncManage、AsyncWebRequest 相关的操作</p>
<h5><span id="23-springmvc中请求的支持">2.3 SpringMVC中请求的支持</span></h5><ol>
<li><p><code>FrameworkServlet</code>中添加了<code>RequestBindingInterceptor</code></p>
</li>
<li><p><code>RequestMappingHandlerAdapter</code>的<code>#invokeHandlerMethod</code> 提供了对异步请求的核心支持</p>
<p> ​    2.1 创建<code>AsyncWebRequest</code>并设置超时时间</p>
<p> ​    2.2 对当前请求<code>WebAsyncManager</code>设置了属性<code>（taskExecutor、asyncWebRequest、callabltinterceptors和deferredResultInterceptors）</code></p>
<p> ​    2.3 并判断是否有结果，如果有对结果进行处理。<code>requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</code></p>
<p> ​    2.4 然后执行方法 <code>requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</code></p>
</li>
<li><p>返回值处理器，<code>AsyncTaskMethodReturnValueHandler</code> <code>CallableMethodReturnValueHandler</code> <code>DeferredResultMethodReturnValueHandler</code> <code>ListenableFutureReturnValueHandler</code></p>
</li>
<li><p><code>DispatcherServlet</code>的<code>#doDispatcher</code>，如果是异步直接返回。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoke the &#123;<span class="doctag">@link</span> RequestMapping&#125; handler method preparing a &#123;<span class="doctag">@link</span> ModelAndView&#125;</span></span><br><span class="line"><span class="comment"> * if view resolution is required.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">invokeHandleMethod</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">   ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request, response);</span><br><span class="line"></span><br><span class="line">   WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">   ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">   ServletInvocableHandlerMethod requestMappingMethod = createRequestMappingMethod(handlerMethod, binderFactory);</span><br><span class="line"></span><br><span class="line">   ModelAndViewContainer mavContainer = <span class="keyword">new</span> ModelAndViewContainer();</span><br><span class="line">   mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">   modelFactory.initModel(webRequest, mavContainer, requestMappingMethod);</span><br><span class="line">   mavContainer.setIgnoreDefaultModelOnRedirect(<span class="keyword">this</span>.ignoreDefaultModelOnRedirect);</span><br><span class="line"></span><br><span class="line">   AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">   asyncWebRequest.setTimeout(<span class="keyword">this</span>.asyncRequestTimeout);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">   asyncManager.setTaskExecutor(<span class="keyword">this</span>.taskExecutor);</span><br><span class="line">   asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">   asyncManager.registerCallableInterceptors(<span class="keyword">this</span>.callableInterceptors);</span><br><span class="line">   asyncManager.registerDeferredResultInterceptors(<span class="keyword">this</span>.deferredResultInterceptors);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">      Object result = asyncManager.getConcurrentResult();</span><br><span class="line">      mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="number">0</span>];</span><br><span class="line">      asyncManager.clearConcurrentResult();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Found concurrent result value ["</span> + result + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5><span id="24-springwebflux-待补充">2.4 SpringWebFlux  ==待补充==</span></h5>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
            <a href="/tags/servlet/" rel="tag"># servlet</a>
          
            <a href="/tags/spring-mvc/" rel="tag"># spring-mvc</a>
          
            <a href="/tags/spring-webflux/" rel="tag"># spring-webflux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/03/servlet-tomcat/" rel="next" title="servlet_tomcat">
                <i class="fa fa-chevron-left"></i> servlet_tomcat
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/02/spring/" rel="prev" title="spring">
                spring <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MzM0Ny8xOTg4OA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhengyumin</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">1. springMVC 核心servlet —DispatcherServlet</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 整体结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 创建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 HttpServletBean的创建</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 FramewordkServlet的创建</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 DispatcherServlet的创建</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 组件概览</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1 HandlerMapping</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.2.</span> <span class="nav-text">1.3.2 HandlerAdapter</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.3.</span> <span class="nav-text">1.3.3 HandlerExceptionResolver</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.4.</span> <span class="nav-text">1.3.4 ViewResolver</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.5.</span> <span class="nav-text">1.3.5 RequestToViewNameTranslator</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.6.</span> <span class="nav-text">1.3.6 LocaleResolver</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.7.</span> <span class="nav-text">1.3.7 ThemeResolver</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.8.</span> <span class="nav-text">1.3.8 MultipartResolver</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.3.9.</span> <span class="nav-text">1.3.9 FlashMapManager</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 处理请求</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.4.1 FrameworkServlet</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">1.4.2.</span> <span class="nav-text">1.4.2 DispatcherServlet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">2. 异步请求</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 servlet异步支持</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1ServletRequest</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2  异步容器AsyncContext</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3 AsyncListener监听器</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 SpringMVC中的相关组件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 AsyncWebRequest</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 WebAsyncManager</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#undefined"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 WebAsyncUtils</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 SpringMVC中请求的支持</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undefined"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 SpringWebFlux  ==待补充==</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhengyumin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total"></span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Reading time total"></span>
  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  
    <script>
  window.livereOptions = {
    refer: '2019/02/03/servlet-springmvc/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  




  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! More info at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + 'D2GGMftjnaihnt6xGsBOCK1T-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': 'D2GGMftjnaihnt6xGsBOCK1T-gzGzoHsz',
                'X-LC-Key': '42G22rkOJK422bv0XSJhBrW6',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
